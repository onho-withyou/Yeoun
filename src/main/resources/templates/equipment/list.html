<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/layout.html}">
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/line-awesome/1.3.0/line-awesome/css/line-awesome.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script th:src="@{/js/common/formatTimeJS.js}"></script>
    <style>
        body {
            background: #f4f3fb;
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            color: #2f2b43;
        }

        .title {
            font-size: 1.8em;
            margin-bottom: 1.8rem;
            color: #697a8d;
            font-weight: 500;
        }

        .order-card {
            border-radius: 12px;
            border: 1px solid #e2e1f3;
            background: #ffffff;
            box-shadow: 0 10px 25px rgba(80, 72, 180, 0.08);
            padding: 16px 18px;
            margin-bottom: 18px;
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1.6em;
            font-weight: 600;
            color: #41388f;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .yeoun-badge-outline {
            border-radius: 999px;
            border: 1px solid rgba(111, 92, 236, 0.4);
            color: #6f5cec;
            padding: 2px 10px;
            font-size: 15px;
            background: rgba(111, 92, 236, 0.04);
        }

        .status-badge {
            width: 90px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            padding: 3px 20px;
        }

        .status-create     { background: #e7eef7; color: #3a5a8a; }
        .status-release    { background: #f0eaff; color: #6a4cc3; }
        .status-progress   { background: #e6f5ec; color: #15803d; }
        .status-complete   { background: #e8f1ff; color: #1d4ed8; }
        .status-cancel     { background: #fdecec; color: #c0392b; }


        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: #514d7a;
            margin-bottom: 4px;
        }

        .form-control,
        .form-select {
            font-size: 13px;
            border-radius: 8px;
            border-color: #d9d8f2;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #6f5cec;
            box-shadow: 0 0 0 0.15rem rgba(111, 92, 236, 0.2);
        }

        .form-text {
            font-size: 11px;
            color: #9a96c0;
        }

        .btn-yeoun-primary {
            font-size: 15px;               /* 버튼 글자 키움 */
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #6f5cec, #9479ff);
            color: white;
        }

        .btn-yeoun-primary:hover {
            background: linear-gradient(135deg, #b8b3ff, #d9d4ff);
            color: #5c4ac7 !important;
        }

        .btn-yeoun-outline {
            border-radius: 999px;
            border: 1px solid #c9c6f3;
            background: #fff;
            color: #655dc0;
            font-size: 13px;
            padding: 8px 14px;
        }

        .badge-priority {
            border-radius: 999px;
            font-size: 11px;
            padding: 3px 8px;
            background: #fdf4e2;
            color: #d97907;
        }

        .search-row {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: end;
        }

        .search-row .form-control,
        .search-row .form-select {
            font-size: 12px;
            height: 32px;
            padding: 4px 10px;
        }

        .search-row .btn {
            height: 32px;
            font-size: 12px;
            padding: 4px 10px;
        }

        /** modal **/

        /* 메인 카드형 모달 */
        .yeoun-modal {
            border-radius: 18px;
            border: none;
            background: #ffffff;
            box-shadow: 0 15px 35px rgba(90, 75, 180, 0.15);
        }

        /* 헤더 */
        .yeoun-modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid #eeeafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title-wrap i {
            color: #6a5acd;
            font-size: 20px;
            margin-right: 6px;
        }

        .modal-title {
            font-weight: 600;
            color: #3b336d;
        }

        /* 작업자 배치 */
        .worker-flow-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 14px;
            padding: 16px;
            background: #faf9ff;
            border: 1px solid #e2defc;
            border-radius: 14px;
            box-shadow: 0 8px 18px rgba(110, 94, 230, 0.08);
        }

        .flow-item {
            flex: 1;
            min-width: 160px;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #dedbf7;
            padding: 14px 12px;
            text-align: center;
            box-shadow: 0 5px 12px rgba(150, 140, 240, 0.10);
        }

        .flow-title {
            font-size: 15px;
            font-weight: 700;
            color: #5a51c8;
            margin-bottom: 3px;
        }

        .flow-desc {
            font-size: 12px;
            color: #7e78aa;
            margin-bottom: 10px;
        }

        .flow-select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d1cdf6;
            background: #fafaff;
            font-size: 13px;
            color: #4b4470;
        }

        .flow-select:focus {
            border-color: #7b6fff;
            box-shadow: 0 0 0 0.15rem rgba(130, 115, 255, 0.25);
        }



        /* 바디 */
        .yeoun-modal-body {
            padding: 24px 28px;
        }

        /* 탭 */
        .yeoun-tabs .nav-link {
            border: none;
            color: #867ccc;
            font-weight: 500;
            padding: 10px 18px;
            border-radius: 8px 8px 0 0;
        }

        .yeoun-tabs .nav-link.active {
            color: #4b3fbf;
            background: #f3f1ff;
            font-weight: 600;
        }

        /* 상세 */
        .wo-detail {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 10px 5px;
        }

        /* 공통 텍스트 */
        .wo-detail label {
            font-size: 13px;
            font-weight: 600;
            color: #776fb5;
            margin-bottom: 4px;
        }

        .wo-detail .value {
            font-size: 15px;
            padding: 6px 0;
            color: #3f3b67;
        }

        .value.strong {
            font-size: 18px;
            font-weight: 700;
            color: #5c53c4;
        }

        /* ===== Header ===== */
        .wo-header {
            display: grid;
            grid-template-columns: 1.3fr 1fr 0.7fr;
            gap: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eceaff;
        }

        /* ===== 일반 행 ===== */
        .wo-row {
            display: flex;
            gap: 40px;
        }

        .wo-col {
            flex: 1;
        }

        /* 설비 상세 모달 */
        #equipDetailModal .modal-dialog {
            max-width: 1200px;
            width: 90%;
        }

        #equipDetailModal .modal-content {
            /*height: 75vh;*/
            border-radius: 16px;
        }

        #equipDetailModal .modal-body {
            padding: 24px 28px;
            overflow: hidden; /* 내부에서 나눠서 스크롤 */
        }
        
        /* ===== 상단 카드 ===== */
        
	    .stat-card {
	      border-radius: 12px;
	      background: linear-gradient(135deg, #6f5cec, #9479ff);
	      color: #fff;
	      padding: 14px 16px;
	      position: relative;
	      overflow: hidden;
	    }
	
	    .stat-card small {
	      font-size: 11px;
	      opacity: 0.9;
	    }
	
	    .stat-card strong {
	      font-size: 20px;
	      display: block;
	      margin-top: 4px;
	    }
	
	    .stat-card.sub {
	      background: #ffffff;
	      color: #514b9a;
	      border: 1px solid #dad7f7;
	      box-shadow: 0 8px 20px rgba(60, 50, 160, 0.05);
	    }
	
	    .stat-card.sub strong {
	      font-size: 18px;
	    }

    </style>
</head>
<body>
<th:block layout:fragment="content">
    <div class="custom-body container-xxl flex-grow-1 container-p-y">
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div class="title">
                설비 현황
            </div>
            <button class="btn btn-yeoun-primary" id="btnCreate">
                <i class="bi bi-plus-circle"></i> 새로 등록
            </button>
        </div>

		    <!-- 상단 KPI 카드 -->
	    <div class="row g-3 mb-3">
	      <div class="col-md-3">
	        <div class="stat-card">
	          <small>전체 설비 갯수</small>
	          <strong th:text="${totalEquipCount}"></strong>
	          <span class="small-text" th:text="|전체 ${totalEquipCount}개 중 ${inactiveEquipCount}개 사용 가능|"></span>
	        </div>
	      </div>
	      <div class="col-md-3">
	        <div class="stat-card sub">
	          <small>가동 설비 갯수</small>
	          <strong th:text="${activeEquipCount}"></strong>
	          <span class="small-text" th:text="|가동률 ${activePer}%|"></span>
	        </div>
	      </div>
	      <div class="col-md-3">
	        <div class="stat-card sub">
	          <small>비가동 설비 갯수</small>
	          <strong th:text="${inactiveEquipCount}"></strong>
	          <span class="small-text" th:text="|비가동 설비 ${inactivePer}%|"></span>
	        </div>
	      </div>
	      <div class="col-md-3">
	        <div class="stat-card sub">
	          <small>고장 설비 갯수</small>
	          <strong th:text="${downEquipCount}"></strong>
	          <span class="small-text" th:text="|사용불가 장비 ${downPer}%|"></span>
	        </div>
	      </div>
	    </div>

        <div>
            <div class="order-card">
                <div class="order-card-header">
                </div>

                <!-- 검색 / 필터 영역 -->
                <div class="mb-2 search-row">
                    <select id="searchEquipment" class="form-select" style="max-width: 150px;">
                        <option value="ALL">전체 설비</option>
                        <option th:each="type : ${equipTypes}"
                                th:value="${type.equipId}"
                                th:text="|${type.equipId} (${type.koName})|">
                        </option>
                    </select>
                    <select id="searchLine" class="form-select" style="max-width: 150px;">
                        <option value="ALL">전체 라인</option>
                        <option th:each="line : ${lines}"
                                th:value="${line.lineId}"
                                th:text="|${line.lineId} (${line.lineName})|">
                        </option>
                    </select>
                    <select id="searchStatus" class="form-select" style="max-width: 150px;">
                        <option value="ALL">전체 상태</option>
                        <option value="RUN">가동</option>
                        <option value="STOP">정지</option>
                    </select>
                </div>

                <div id="equipGrid"></div>
            </div>
        </div>
    </div>

    <!-- 설비 등록 모달 -->
    <div class="modal fade" id="equipRegisterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">설비 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="equipForm" th:object="${req}" method="post">
                    <div class="modal-body">

                            <!-- 설비 종류 -->
                            <div class="mb-3">
                                <label class="form-label">설비 타입</label>
                                <select class="form-select" th:field="*{equipType}" required>
                                    <option value="">선택</option>
                                    <option th:each="type : ${useEquipTypes}"
                                            th:value="${type.equipId}"
                                            th:text="|${type.equipId} (${type.koName})|">
                                    </option>
                                </select>
                            </div>

                            <!-- 라인 -->
                            <div class="mb-3">
                                <label class="form-label">라인</label>
                                <select class="form-select" th:field="*{lineId}" required>
                                    <option value="">선택</option>
                                    <option th:each="line : ${useLines}"
                                            th:value="${line.lineId}"
                                            th:text="|${line.lineId} (${line.lineName})|">
                                    </option>
                                </select>
                            </div>

                            <!-- 설비명 -->
                            <div class="mb-3">
                                <label class="form-label">설비명</label>
                                <input type="text" class="form-control"
                                       th:field="*{equipName}"
                                       placeholder="예) 충전기3"
                                       required>
                            </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary" id="btnSaveEquip">저장</button>
                    </div>
                </form>

            </div>
        </div>
    </div>


    <!-- 설비 상세 모달 -->
    <div class="modal fade" id="equipDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content yeoun-modal">

                <!-- Header -->
                <div class="yeoun-modal-header">
                    <div class="modal-title-wrap d-flex align-items-center gap-2">
                        <i class="bi bi-cpu-fill"></i>
                        <h5 class="modal-title">
                            설비 상세
                        </h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Body -->
                <div class="yeoun-modal-body">

                    <!-- ===== 설비 기본 정보 ===== -->
                    <div class="wo-header mb-4">
                        <div>
                            <label>설비명</label>
                            <div class="value strong" id="dEquipName">-</div>
                        </div>

                        <div>
                            <label>설비 타입</label>
                            <div class="value" id="dEquipType">-</div>
                        </div>

                        <div>
                            <label>상태</label>
                            <div class="value">
                                <span class="status-badge" id="dEquipStatus">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="wo-row mb-4">
                        <div class="wo-col">
                            <label>소속 라인</label>
                            <div class="value" id="dLineName">-</div>
                        </div>
                        <div class="wo-col">
                            <label>등록일시</label>
                            <div class="value" id="dCreatedDate">-</div>
                        </div>
                    </div>

                    <!-- ===== 작업 이력 ===== -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">최근 작업 이력</label>
                            <span class="form-text">
                              ※ 최근 작업 기준 정렬
                            </span>
                        </div>

                        <!-- Toast Grid 영역 -->
                        <div id="equipHistoryGrid" style="height: 320px;"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>


</th:block>
<th:block layout:fragment="myScript">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let equipGrid = null;

        document.addEventListener("DOMContentLoaded", () => {
            const gridEq = document.getElementById("equipGrid");
            if (!gridEq) {
                console.error("그리드 요소 없음");
                return;
            }

            equipGrid = new tui.Grid({
                el: gridEq,
                bodyHeight: 450,
                rowHeaders: ["rowNum"],
                scrollX: false,
                scrollY: true,
                pageOptions: {
                    useClient: true,
                    perPage: 10
                },
                columnOptions: { resizable: true },
                columns: [
                    { header: "설비명", name: "equipName", align: "left" },
                    { header: "설비코드", name: "equipTypeId", align: "left" },
                    { header: "라인", name: "lineId", align: "center" },
                    { header: "상태", name: "status", align: "center" },
                    { header: "등록일자", name: "createdDate", align: "center",
                        formatter: ({ value }) => formatTimeFull(value ? new Date(value) : undefined)},
                    {
                        header: "상세",
                        name: "btn",
                        width: 90,
                        align: "center",
                        formatter: () => "<button class='btn btn-primary btn-sm grid-detail'>상세</button>"
                    }
                ]
            })

            loadEquip();

            equipGrid.on("click", (event) => {
                if (event.columnName !== "btn") return;
                const row = equipGrid.getRow(event.rowKey);
                openEquipDetailModal(row);
            });

            ["searchEquipment", "searchLine", "searchStatus"].forEach(id => {
                document.getElementById(id).addEventListener("change", loadEquip);
            });
        });

        function loadEquip(){
            const equip = document.getElementById("searchEquipment").value;
            const line  = document.getElementById("searchLine").value;
            const status = document.getElementById("searchStatus").value;

            const query = new URLSearchParams();

            if (equip !== "ALL") query.append("equipment", equip);
            if (line !== "ALL") query.append("line", line);
            if (status !== "ALL") query.append("status", status);

            fetch("/equipment/list/data?" + query.toString())
                .then(res => {
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log("작업지시 목록 : ", data);
                    equipGrid.resetData(data);
                })
                .catch(err => {
                    console.error("작업지시 목록 조회 오류", err);
                    alert("조회 중 오류 발생");
                });
        }

        // ======================================================
        // 설비 상세 모달
        let equipHistoryGrid = null;

        function initEquipHistoryGrid() {
            if (equipHistoryGrid) return;

            equipHistoryGrid = new tui.Grid({
                el: document.getElementById('equipHistoryGrid'),
                bodyHeight: 200,
                rowHeaders: ['rowNum'],
                scrollX: false,
                scrollY: true,
                pageOptions: {
                    useClient: true,
                    perPage: 5
                },
                columns: [
                    {
                        header: '작업지시',
                        name: 'orderId',
                        align: 'center'
                    },
                    {
                        header: '제품',
                        name: 'productName',
                        align: 'left',
                        width: 100
                    },
                    {
                        header: '상태',
                        name: 'status',
                        align: 'center',
                        width: 100
                    },
                    {
                        header: '시작시간',
                        name: 'startTime',
                        align: 'center',
                        width: 200,
                        formatter: ({ value }) => formatTimeFull(value ? new Date(value) : undefined)
                    },
                    {
                        header: '종료시간',
                        name: 'endTime',
                        align: 'center',
                        width: 200,
                        formatter: ({ value }) => formatTimeFull(value ? new Date(value) : undefined)
                    },
                ]
            });
        }

        async function openEquipDetailModal(data) {

            // 기본 정보 바인딩
            document.getElementById("dEquipName").textContent = data.equipName;
            document.getElementById("dEquipType").textContent = data.equipTypeId || "-";
            document.getElementById("dLineName").textContent = data.lineId || "-";
            document.getElementById("dCreatedDate").textContent = formatTimeFull(new Date(data.createdDate));

            const status = data.status ?? "UNKNOWN";
            const statusEl = document.getElementById("dEquipStatus");
            statusEl.textContent = status;
            statusEl.className = "status-badge status-" + status.toLowerCase();

            document.getElementById("equipDetailModal").addEventListener('shown.bs.modal', async () => {

                initEquipHistoryGrid();
                equipHistoryGrid.refreshLayout();

                try {
                    const history = await loadEquipHistory(data.equipId);
                    console.log(history);
                    equipHistoryGrid.resetData(history);
                } catch (err) {
                    console.error(err);
                    equipHistoryGrid.resetData([]);
                }
            }, {once: true});

            // 모달 오픈
            const modal = new bootstrap.Modal(document.getElementById("equipDetailModal"));
            modal.show();
        }

        // 히스토리 로드 함수
        async function loadEquipHistory(equipId) {
            console.log("here 1");
            console.log("data... equipId :: ", equipId);
            const res = await fetch(`/equipment/equip/${equipId}/history`, {
                headers: {
                    "Content-Type" : "application/json",
                    [csrfHeader] : csrfToken
                }
            });
            if (!res.ok) throw new Error("이력 조회 실패");
            return await res.json();
        }

        // 설비 등록 모달
        document.getElementById("btnCreate").addEventListener("click", (event) => {
            const modal = new bootstrap.Modal(document.getElementById("equipRegisterModal"));
            document.getElementById("equipForm").reset();
            // select 강제 초기화
            // document.getElementById("equipType").value = "";
            // document.getElementById("lineId").value = "";
            // document.getElementById("equipName").value = "";
            modal.show();
        });

        // 설비 등록하기
        document.getElementById("equipForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const payload = {
                equipType: document.getElementById("equipType").value,
                lineId   : document.getElementById("lineId").value,
                equipName: document.getElementById("equipName").value
            };

            try {
                const response = await fetch("/equipment/equip", {
                    method: "POST",
                    headers: {
                        "Content-Type" : "application/json",
                        [csrfHeader] : csrfToken
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const text = await response.text();
                    alert("저장 실패");
                    return;
                }

                alert ("성공적으로 저장되었습니다.");
                bootstrap.Modal.getInstance(
                    document.getElementById("equipRegisterModal")
                ).hide();

                loadEquip();

            } catch (err) {
                console.log(err);
                alert("오류가 발생했습니다.");
            }

        });


    </script>
</th:block>