<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/layout.html}">
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/line-awesome/1.3.0/line-awesome/css/line-awesome.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f4f3fb;
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            color: #2f2b43;
        }

        .title {
            font-size: 1.8em;
            margin-bottom: 1.8rem;
            color: #697a8d;
            font-weight: 500;
        }

        .order-card {
            border-radius: 12px;
            border: 1px solid #e2e1f3;
            background: #ffffff;
            box-shadow: 0 10px 25px rgba(80, 72, 180, 0.08);
            padding: 16px 18px;
            margin-bottom: 18px;
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1.6em;
            font-weight: 600;
            color: #41388f;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .yeoun-badge-outline {
            border-radius: 999px;
            border: 1px solid rgba(111, 92, 236, 0.4);
            color: #6f5cec;
            padding: 2px 10px;
            font-size: 15px;
            background: rgba(111, 92, 236, 0.04);
        }

        .status-badge {
            width: 90px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            padding: 3px 20px;
        }

        .status-create     { background: #e7eef7; color: #3a5a8a; }
        .status-release    { background: #f0eaff; color: #6a4cc3; }
        .status-progress   { background: #e6f5ec; color: #15803d; }
        .status-complete   { background: #e8f1ff; color: #1d4ed8; }
        .status-cancel     { background: #fdecec; color: #c0392b; }


        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: #514d7a;
            margin-bottom: 4px;
        }

        .form-control,
        .form-select {
            font-size: 13px;
            border-radius: 8px;
            border-color: #d9d8f2;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #6f5cec;
            box-shadow: 0 0 0 0.15rem rgba(111, 92, 236, 0.2);
        }

        .form-text {
            font-size: 11px;
            color: #9a96c0;
        }

        .btn-yeoun-primary {
            font-size: 15px;               /* Î≤ÑÌäº Í∏ÄÏûê ÌÇ§ÏõÄ */
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #6f5cec, #9479ff);
            color: white;
        }

        .btn-yeoun-primary:hover {
            background: linear-gradient(135deg, #b8b3ff, #d9d4ff);
            color: #5c4ac7 !important;
        }

        .btn-yeoun-outline {
            border-radius: 999px;
            border: 1px solid #c9c6f3;
            background: #fff;
            color: #655dc0;
            font-size: 13px;
            padding: 8px 14px;
        }

        .badge-priority {
            border-radius: 999px;
            font-size: 11px;
            padding: 3px 8px;
            background: #fdf4e2;
            color: #d97907;
        }

        .search-row {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: end;
        }

        .search-row .form-control,
        .search-row .form-select {
            font-size: 12px;
            height: 32px;
            padding: 4px 10px;
        }

        .search-row .btn {
            height: 32px;
            font-size: 12px;
            padding: 4px 10px;
        }

        /** modal **/

        /* Î©îÏù∏ Ïπ¥ÎìúÌòï Î™®Îã¨ */
        .yeoun-modal {
            border-radius: 18px;
            border: none;
            background: #ffffff;
            box-shadow: 0 15px 35px rgba(90, 75, 180, 0.15);
        }

        /* Ìó§Îçî */
        .yeoun-modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid #eeeafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title-wrap i {
            color: #6a5acd;
            font-size: 20px;
            margin-right: 6px;
        }

        .modal-title {
            font-weight: 600;
            color: #3b336d;
        }

        /* ÏûëÏóÖÏûê Î∞∞Ïπò */
        .worker-flow-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 14px;
            padding: 16px;
            background: #faf9ff;
            border: 1px solid #e2defc;
            border-radius: 14px;
            box-shadow: 0 8px 18px rgba(110, 94, 230, 0.08);
        }

        .flow-item {
            flex: 1;
            min-width: 160px;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #dedbf7;
            padding: 14px 12px;
            text-align: center;
            box-shadow: 0 5px 12px rgba(150, 140, 240, 0.10);
        }

        .flow-title {
            font-size: 15px;
            font-weight: 700;
            color: #5a51c8;
            margin-bottom: 3px;
        }

        .flow-desc {
            font-size: 12px;
            color: #7e78aa;
            margin-bottom: 10px;
        }

        .flow-select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d1cdf6;
            background: #fafaff;
            font-size: 13px;
            color: #4b4470;
        }

        .flow-select:focus {
            border-color: #7b6fff;
            box-shadow: 0 0 0 0.15rem rgba(130, 115, 255, 0.25);
        }



        /* Î∞îÎîî */
        .yeoun-modal-body {
            padding: 24px 28px;
        }

        /* ÌÉ≠ */
        .yeoun-tabs .nav-link {
            border: none;
            color: #867ccc;
            font-weight: 500;
            padding: 10px 18px;
            border-radius: 8px 8px 0 0;
        }

        .yeoun-tabs .nav-link.active {
            color: #4b3fbf;
            background: #f3f1ff;
            font-weight: 600;
        }

        /* ÏÉÅÏÑ∏ */
        .wo-detail {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 10px 5px;
        }

        /* Í≥µÌÜµ ÌÖçÏä§Ìä∏ */
        .wo-detail label {
            font-size: 13px;
            font-weight: 600;
            color: #776fb5;
            margin-bottom: 4px;
        }

        .wo-detail .value {
            font-size: 15px;
            padding: 6px 0;
            color: #3f3b67;
        }

        .value.strong {
            font-size: 18px;
            font-weight: 700;
            color: #5c53c4;
        }

        /* ===== Header ===== */
        .wo-header {
            display: grid;
            grid-template-columns: 1.3fr 1fr 0.7fr;
            gap: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eceaff;
        }

        /* ===== ÏùºÎ∞ò Ìñâ ===== */
        .wo-row {
            display: flex;
            gap: 40px;
        }

        .wo-col {
            flex: 1;
        }
        
        /* ÏÑ§ÎπÑ ÏÉÅÏÑ∏ Î™®Îã¨ */
        #equipDetailModal .modal-dialog {
            max-width: 1200px;
            width: 90%;
        }

        #equipDetailModal .modal-content {
            /*height: 75vh;*/
            border-radius: 16px;
        }

        #equipDetailModal .modal-body {
            padding: 24px 28px;
            overflow: hidden; /* ÎÇ¥Î∂ÄÏóêÏÑú ÎÇòÎà†ÏÑú Ïä§ÌÅ¨Î°§ */
        }

    </style>
</head>
<body>
<th:block layout:fragment="content">
    <div class="custom-body container-xxl flex-grow-1 container-p-y">
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div class="title">
                ÏÑ§ÎπÑ ÌòÑÌô©
            </div>
            <button class="btn btn-yeoun-primary" id="btnCreate">
                <i class="bi bi-plus-circle"></i> ÏÉàÎ°ú Îì±Î°ù
            </button>
        </div>

        <div>
            <div class="order-card">
                <div class="order-card-header">
                </div>

                <!-- Í≤ÄÏÉâ / ÌïÑÌÑ∞ ÏòÅÏó≠ -->
                <div class="mb-2 search-row">
                    <select id="searchEquipment" class="form-select" style="max-width: 150px;">
                        <option value="ALL">Ï†ÑÏ≤¥ ÏÑ§ÎπÑ</option>
                        <option value="BLENDING_TANK">BLENDING_TANK</option>
                        <option value="MIXER_AGITATOR">MIXER_AGITATOR</option>
                        <option value="FILTER_HOUSING">FILTER_HOUSING</option>
                        <option value="FILLING_SEMI">FILLING_SEMI</option>
                        <option value="CAPPING_SEMI">CAPPING_SEMI</option>
                        <option value="LABELING_AUTO">LABELING_AUTO</option>
                        <option value="PACKING_SEMI">PACKING_SEMI</option>
                    </select>
                    <select id="searchLine" class="form-select" style="max-width: 150px;">
                        <option value="ALL">Ï†ÑÏ≤¥ ÎùºÏù∏</option>
                        <option value="PL-01">1Î≤à ÎùºÏù∏</option>
                        <option value="PL-02">2Î≤à ÎùºÏù∏</option>
                        <option value="PL-03">3Î≤à ÎùºÏù∏</option>
                    </select>
                    <select id="searchStatus" class="form-select" style="max-width: 150px;">
                        <option value="ALL">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                        <option value="RUN">Í∞ÄÎèô</option>
                        <option value="STOP">Ï†ïÏßÄ</option>
                        <option value="BREAKDOWN">Í≥†Ïû•</option>
                        <option value="MAINTENANCE">Î≥¥Ïàò</option>
                    </select>
                </div>

                <div id="equipGrid"></div>
            </div>
        </div>
    </div>

    <!-- ÏÑ§ÎπÑ ÏÉÅÏÑ∏ Î™®Îã¨ -->
    <div class="modal fade" id="equipDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content yeoun-modal">

                <!-- Header -->
                <div class="yeoun-modal-header">
                    <div class="modal-title-wrap d-flex align-items-center gap-2">
                        <i class="bi bi-cpu-fill"></i>
                        <h5 class="modal-title">
                            ÏÑ§ÎπÑ ÏÉÅÏÑ∏
                        </h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Body -->
                <div class="yeoun-modal-body">

                    <!-- ===== ÏÑ§ÎπÑ Í∏∞Î≥∏ Ï†ïÎ≥¥ ===== -->
                    <div class="wo-header mb-4">
                        <div>
                            <label>ÏÑ§ÎπÑÎ™Ö</label>
                            <div class="value strong" id="dEquipName">-</div>
                        </div>

                        <div>
                            <label>ÏÑ§ÎπÑ ÌÉÄÏûÖ</label>
                            <div class="value" id="dEquipType">-</div>
                        </div>

                        <div>
                            <label>ÏÉÅÌÉú</label>
                            <div class="value">
                                <span class="status-badge" id="dEquipStatus">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="wo-row mb-4">
                        <div class="wo-col">
                            <label>ÏÜåÏÜç ÎùºÏù∏</label>
                            <div class="value" id="dLineName">-</div>
                        </div>
                        <div class="wo-col">
                            <label>Îì±Î°ùÏùºÏãú</label>
                            <div class="value" id="dCreatedDate">-</div>
                        </div>
                    </div>

                    <!-- ===== ÏûëÏóÖ Ïù¥Î†• ===== -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">ÏµúÍ∑º ÏûëÏóÖ Ïù¥Î†•</label>
                            <span class="form-text">
              ‚Äª ÏµúÍ∑º ÏûëÏóÖ Í∏∞Ï§Ä Ï†ïÎ†¨
            </span>
                        </div>

                        <!-- Toast Grid ÏòÅÏó≠ -->
                        <div id="equipHistoryGrid" style="height: 320px;"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>


</th:block>
<th:block layout:fragment="myScript">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let equipGrid = null;

        document.addEventListener("DOMContentLoaded", () => {
            const gridEq = document.getElementById("equipGrid");
            if (!gridEq) {
                console.error("Í∑∏Î¶¨Îìú ÏöîÏÜå ÏóÜÏùå");
                return;
            }

            equipGrid = new tui.Grid({
                el: gridEq,
                bodyHeight: 450,
                rowHeaders: ["rowNum"],
                scrollX: false,
                scrollY: true,
                pageOptions: {
                    useClient: true,
                    perPage: 10
                },
                columnOptions: { resizable: true },
                columns: [
                    { header: "ÏÑ§ÎπÑÎ™Ö", name: "equipName", align: "left" },
                    { header: "ÏÑ§ÎπÑÏΩîÎìú", name: "equipTypeId", align: "left" },
                    { header: "ÎùºÏù∏", name: "lineId", align: "center" },
                    { header: "ÏÉÅÌÉú", name: "status", align: "center" },
                    { header: "Îì±Î°ùÏùºÏûê", name: "createdDate", align: "center" },
                    {
                        header: "ÏÉÅÏÑ∏",
                        name: "btn",
                        width: 90,
                        align: "center",
                        formatter: () => "<button class='btn btn-primary btn-sm grid-detail'>ÏÉÅÏÑ∏</button>"
                    }
                ]
            })

            loadEquip();

            equipGrid.on("click", (event) => {
                if (event.columnName !== "btn") return;
                const row = equipGrid.getRow(event.rowKey);
                openEquipDetailModal(row.equipId);
            });

            ["searchEquipment", "searchLine", "searchStatus"].forEach(id => {
                document.getElementById(id).addEventListener("change", loadEquip);
            });
        });

        function loadEquip(){
            const equip = document.getElementById("searchEquipment").value;
            const line  = document.getElementById("searchLine").value;
            const status = document.getElementById("searchStatus").value;

            const query = new URLSearchParams();

            if (equip !== "ALL") query.append("equipment", equip);
            if (line !== "ALL") query.append("line", line);
            if (status !== "ALL") query.append("status", status);

            fetch("/equipment/list/data?" + query.toString())
                .then(res => {
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log("ÏûëÏóÖÏßÄÏãú Î™©Î°ù : ", data);
                    equipGrid.resetData(data);
                })
                .catch(err => {
                    console.error("ÏûëÏóÖÏßÄÏãú Î™©Î°ù Ï°∞Ìöå Ïò§Î•ò", err);
                    alert("Ï°∞Ìöå Ï§ë Ïò§Î•ò Î∞úÏÉù");
                });
        }

        // ======================================================
        // ÏÑ§ÎπÑ ÏÉÅÏÑ∏ Î™®Îã¨
        let equipHistoryGrid = null;

        function initEquipHistoryGrid() {
            if (equipHistoryGrid) return;

            equipHistoryGrid = new tui.Grid({
                el: document.getElementById('equipHistoryGrid'),
                bodyHeight: 200,
                rowHeaders: ['rowNum'],
                scrollX: false,
                scrollY: true,
                pageOptions: {
                    useClient: true,
                    perPage: 5
                },
                columns: [
                    {
                        header: 'ÏûëÏóÖÏßÄÏãú',
                        name: 'orderId',
                        align: 'center',
                        width: 160
                    },
                    {
                        header: 'Ï†úÌíà',
                        name: 'productName',
                        align: 'left'
                    },
                    {
                        header: 'ÏÉÅÌÉú',
                        name: 'orderStatus',
                        align: 'center',
                        width: 100
                    },
                    {
                        header: 'ÏûëÏóÖÏãúÍ∞Ñ',
                        name: 'workTime',
                        align: 'center',
                        width: 180
                    }
                ]
            });
        }

        function openEquipDetailModal(row) {

            // Í∏∞Î≥∏ Ï†ïÎ≥¥ Î∞îÏù∏Îî©
            document.getElementById("dEquipName").textContent = row.equipName;
            document.getElementById("dEquipType").textContent = row.equipment?.equipCode || "-";
            document.getElementById("dLineName").textContent = row.line?.lineName || "-";
            document.getElementById("dCreatedDate").textContent = row.createdDate;
            const status = row.status ?? "UNKNOWN";
            const statusEl = document.getElementById("dEquipStatus");
            statusEl.textContent = status;
            statusEl.className = "status-badge status-" + status.toLowerCase();
            statusEl.className = "status-badge status-" + status.toLowerCase();

            // Grid Ï¥àÍ∏∞Ìôî
            initEquipHistoryGrid();

            // üîπ ÎçîÎØ∏ ÏûëÏóÖ Ïù¥Î†•
            equipHistoryGrid.resetData([
                {
                    orderId: "WO-20251210-003",
                    productName: "Ìñ•Ïàò A",
                    orderStatus: "ÏôÑÎ£å",
                    workTime: "09:00 ~ 11:30"
                },
                {
                    orderId: "WO-20251209-001",
                    productName: "Ìñ•Ïàò B",
                    orderStatus: "Ï§ëÎã®",
                    workTime: "14:00 ~ 15:10"
                }
            ]);

            // Î™®Îã¨ Ïò§Ìîà
            const modal = new bootstrap.Modal(document.getElementById("equipDetailModal"));
            modal.show();
        }



    </script>
</th:block>