<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{/layouts/layout.html}">

    <head>
        <link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
        <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />

        <script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.js"></script>
        <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
        <script th:src="@{/js/common/formatTimeJS.js}"></script>
        <style>
            .status-active {
                background-color: #e8f5e9 !important;
                color: #2e7d32 !important;
                font-weight: bold;
            }
            .status-inactive {
                background-color: #ffe0b2 !important;
                color: #ef6c00 !important;
            }
            .highlight-eq {
                background-color: #e3f2fd !important;
                color: #1565c0 !important;
                font-weight: bold;
            }
        </style>

    </head>

    <body>
    <th:block layout:fragment="content">
        <div class="custom-body container-xxl flex-grow-1 container-p-y">
            <h2>설비 / 라인 관리</h2>

            <div class="nav-align-top mb-4">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <button type="button" class="nav-link active" role="tab"
                                data-bs-toggle="tab" data-bs-target="#navs-equipment-tab"
                                aria-controls="navs-equipment-tab" aria-selected="true">
                            설비 관리
                        </button>
                    </li>

                    <li class="nav-item">
                        <button type="button" class="nav-link" role="tab"
                                data-bs-toggle="tab" data-bs-target="#navs-line-tab"
                                aria-controls="navs-line-tab" aria-selected="false">
                            라인 관리
                        </button>
                    </li>
                </ul>

                <div class="tab-content">

                    <!-- =============================== -->
                    <!-- 설비 관리 탭 -->
                    <!-- =============================== -->
                    <div class="tab-pane fade show active" id="navs-equipment-tab" role="tabpanel">
                        <h5 class="card-title mb-0">설비 목록</h5>

                        <div class="d-flex justify-content-end" style="margin:10px;">
                            <button id="addEquipmentBtn" class="btn btn-primary" type="button" style="margin-right:5px;">추가</button>
                        </div>

                        <div id="equipmentGrid" style="width: 100%;"></div>
                    </div>

                    <!-- =============================== -->
                    <!-- 라인 관리 탭 -->
                    <!-- =============================== -->
                    <div class="tab-pane fade" id="navs-line-tab" role="tabpanel">
                        <h5 class="card-title mb-0">라인 목록</h5>

                        <div class="d-flex justify-content-end" style="margin:10px;">
                            <button id="addLineBtn" class="btn btn-primary" type="button" style="margin-right:5px;">추가</button>
                        </div>

                        <div id="lineGrid" style="width: 100%;"></div>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- =========== 등록 및 상세 모달 =========== -->
        
        <!-- =========== 설비 등록 =========== -->
        <div class="modal fade" id="equipmentModal" tabindex="-1">
		  <div class="modal-dialog modal-lg modal-dialog-centered">
		    <div class="modal-content">
			<form id="equipmentForm"
				  th:object="${equipmentTypeCreateRequest}"
				  method="post">
		      <div class="modal-header">
		        <h5 class="modal-title" id="equipmentModalTitle">설비 등록</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		      </div>
		
		      <div class="modal-body">
		          <div class="mb-3">
		            <label class="form-label">설비 ID</label>
		            <input th:field="*{equipId}"
		            	   type="text"
		            	   class="form-control"
		            	   th:classappend="${#fields.hasErrors('equipId')} ? 'is-invalid'">
		          	<div class="invalid-feedback"
		          		 th:if="${#fields.hasErrors('equipId')}"
		          		 th:errors="*{equipId}"></div>
		          </div>
		
		          <div class="mb-3">
		            <label class="form-label">이름(한)</label>
		            <input th:field="*{koName}"
		            	   type="text"
		            	   class="form-control"
		            	   th:classappend="${#fields.hasErrors('koName')} ? 'is-invalid'">
		          	<div class="invalid-feedback"
		          		 th:if="${#fields.hasErrors('koName')}"
		          		 th:errors="*{koName}"></div>
		          </div>
		
		          <div class="mb-3">
		            <label class="form-label">이름(영)</label>
		            <input th:field="*{equipName}"
		            	   type="text"
		            	   class="form-control"
		            	   th:classappend="${#fields.hasErrors('equipName')} ? 'is-invalid'">
		          	<div class="invalid-feedback"
		          		 th:if="${#fields.hasErrors('equipName')}"
		          		 th:errors="*{equipName}"></div>
		          </div>
		          
		          <div class="mb-3">
					<label class="form-label">설명</label>
					<textarea th:field="*{remark}" class="form-control" id="equipRemark" rows="4"
							  th:classappend="${#fields.hasErrors('remark')} ? 'is-valid'"
	  					      placeholder="설비 용도, 주의사항 등을 입력하세요"></textarea>
				  	<div class="invalid-feedback"
		          		 th:if="${#fields.hasErrors('remark')}"
		          		 th:errors="*{remark}"></div>
				  </div>
		        
		      </div>
		
		      <div class="modal-footer">
		        <button type="button" class="btn btn-danger d-none" id="btnDeleteEquip">비활성</button>
		        <button type="submit" class="btn btn-primary" id="btnSaveEquip">저장</button>
		      </div>
			</form>
		    </div>
		  </div>
		</div>
        
        <!-- =========== 라인 등록 =========== -->
        <div class="modal fade" id="lineModal" tabindex="-1">
		  <div class="modal-dialog modal-lg modal-dialog-centered">
		    <div class="modal-content">
			<form id="lineForm"
				  th:object="${lineCreateRequest}"
				  method="post">
		      <div class="modal-header">
		        <h5 class="modal-title" id="lineModalTitle">라인 등록</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		      </div>
		
		      <div class="modal-body">
		        
		          <div class="mb-3">
		            <label class="form-label">라인 ID</label>
		            <input th:field="*{lineId}"
						   type="text"
						   class="form-control"
						   placeholder="자동 생성됩니다. 설정불가.">
		          </div>
		
		          <div class="mb-3">
		            <label class="form-label">라인명</label>
		            <input th:field="*{lineName}"
						   type="text"
						   class="form-control">
		          </div>
		          
		          <div class="mb-3">
					<label class="form-label">설명</label>
					<textarea th:field="*{remark}"
							  rows="4"
							  class="form-control"
							  id="lineRemark"
					    	  placeholder="라인에 대한 설명을 입력하세요"></textarea>
				  </div>
		        
		      </div>
		
		      <div class="modal-footer">
		        <button type="button" class="btn btn-danger d-none" id="btnDeleteLine">삭제</button>
		        <button type="submit" class="btn btn-primary" id="btnSaveLine">저장</button>
		      </div>
			</form>
		    </div>
		  </div>
		</div>
        
    </th:block>
    </body>


	<script th:if="${openEquipmentModal}">
	    document.addEventListener("DOMContentLoaded", () => {
	        const modal = new bootstrap.Modal(
	            document.getElementById("equipmentModal")
	        );
	        modal.show();
	    });
	</script>

    <th:block layout:fragment="myScript">
		<script>
	      let equipmentGrid = null;
	      let lineGrid = null;
	      
		  document.addEventListener("DOMContentLoaded", () => {
		
		    const gridE = document.getElementById("equipmentGrid");
		    if (!gridE) {
		      console.error("equipmentGrid 요소 없음!");
		      return;
		    }
		    const gridL = document.getElementById("lineGrid");
		    if (!gridL) {
		      console.error("lineGrid 요소 없음!");
		      return;
		    }
		
		    // 1) equipmentGrid 생성
		    equipmentGrid = new tui.Grid ({
		      el: gridE,
		      bodyHeight: 450,
		      rowHeaders: ["rowNum"],
		      scrollX: false,
		      scrollY: true,
		      pageOptions: {
		        useClient: true,
		        perPage: 10
		      },
		      columnOptions: {resizable: true, editor: null},
		      columns: [
		        {header: "ID", name: "equipId", width: 160, align: "center"},
		        {header: "이름(한)", name: "koName", align: "left"},
		        {header: "이름(영)", name: "equipName", align: "left"},
		        {
		          header: "등록일자",
		          name: "createdDate",
		          align: "center",
		          formatter: ({ value }) => formatTimeFull(value ? new Date(value) : undefined)
		        },
			    {header: "사용", name: "useYn", align: "center"},
		        {
		          header: "상세",
		          name: "btn",
		          width: 90,
		          align: "center",
		          formatter: () => "<button class='btn btn-primary btn-sm grid-detail'>상세</button>"
		        }
		      ]
		    });
		  
	          equipmentGrid.on("click", event => {
	        	  if (event.columnName !== "btn") return;

				  const row = equipmentGrid.getRow(event.rowKey);
				  openEquipmentModal("DETAIL", row);
	          });
	          
		
		    // 2) lineGrid 생성
		    lineGrid = new tui.Grid ({
		      el: gridL,
		      bodyHeight: 450,
		      rowHeaders: ["rowNum"],
		      scrollX: false,
		      scrollY: true,
		      pageOptions: {
		        useClient: true,
		        perPage: 10
		      },
		      columnOptions: {resizable: true, editor: null},
		      columns: [
		        {header: "ID", name: "lineId", width: 160, align: "center"},
		        {header: "라인명", name: "lineName", align: "left"},
			    {header: "사용", name: "useYn", align: "center"},
		        {
		          header: "상세",
		          name: "btn",
		          width: 90,
		          align: "center",
		          formatter: () => "<button class='btn btn-primary btn-sm grid-detail'>상세</button>"
		        }
		      ]
		    });
		    
	          lineGrid.on("click", event => {
	        	  if (event.columnName !== "btn") return

				  const row = lineGrid.getRow(event.rowKey);
				  openLineModal("DETAIL", row);

	          });

              loadGridData('/equipment/equip/data', equipmentGrid);
		  });

		  // 탭 변경
		  document
			  .querySelectorAll('button[data-bs-toggle="tab"]')
			  .forEach(tab => {
			    tab.addEventListener('shown.bs.tab', function (e) {
			      const targetId = e.target.getAttribute('data-bs-target');
	
			      if (targetId === '#navs-equipment-tab') {
			        equipmentGrid.refreshLayout();
                    loadGridData('/equipment/equip/data', equipmentGrid);
			      } else if (targetId === '#navs-line-tab') {
			        lineGrid.refreshLayout();
                    loadGridData('/equipment/line/data', lineGrid);
			      }
			    });
			});

          // 로딩함수 공통
          async function loadGridData(url, grid) {
              try {
                  const res = await fetch(url);
                  if (!res.ok) throw new Error("서버 오류");
                  const data = await res.json();

                  console.log("서버응답 확인.... " , data);

                  grid.resetData(data); // 기존 데이터 지우고 새로 로드
                  grid.refreshLayout(); // 화면 갱신

              } catch (err) {
                  console.error("데이터 로딩 실패:", err);
              }
          }
          
          // 모달 열기
          
          // 1) 등록
		  document.getElementById("addEquipmentBtn").addEventListener("click", () => {
		    openEquipmentModal("CREATE");
		  });
          
		  document.getElementById("addLineBtn").addEventListener("click", () => {
		    openLineModal("CREATE");
		  });
                    
          
        // 모달 제어 함수
        
        // 1) 설비
        function openEquipmentModal(mode, data = null) {
		    const modal = new bootstrap.Modal(document.getElementById("equipmentModal"));
			const deleteBtn = document.getElementById("btnDeleteEquip");

		    if (mode === "CREATE") {
		        document.getElementById("equipmentModalTitle").innerText = "설비 등록";
		        document.getElementById("equipmentForm").reset();
		        document.getElementById("equipId").disabled = false;
				deleteBtn.classList.add("d-none");
		    }
		
		    if (mode === "DETAIL") {
		    	
		        if (!data) {
		            console.error("데이터가 없습니다.");
		            return;
		        }
				const isActive = data.useYn === "Y";

				deleteBtn.classList.remove("d-none");
				deleteBtn.textContent = isActive ? "비활성" : "활성";

				document.getElementById("equipmentModalTitle").innerText = "설비 상세";

		        document.getElementById("equipId").value = data.equipId ?? "";
		        document.getElementById("koName").value = data.koName ?? "";
		        document.getElementById("equipName").value = data.equipName ?? "";
		        document.getElementById("equipRemark").value = data.remark ?? "";
		
		        document.getElementById("equipId").disabled = true;

				deleteBtn.dataset.equipId = data.equipId;
				deleteBtn.dataset.useYn   = data.useYn;
		    }
		
		    modal.show();
		}
        
        // 2) 라인
        function openLineModal(mode, data = null) {
		    const modal = new bootstrap.Modal(document.getElementById("lineModal"));
			const deleteBtn = document.getElementById("btnDeleteLine");

		    if (mode === "CREATE") {
		        document.getElementById("lineModalTitle").innerText = "라인 등록";
		        document.getElementById("lineForm").reset();
				deleteBtn.classList.add("d-none");

				document.getElementById("lineId").disabled = true;
		    }
		
		    if (mode === "DETAIL") {
		        
		    	if (!data) {
		            console.error("DETAIL 모드인데 data가 없습니다.");
		            return;
		        }

				const isActive = data.useYn === "Y";

				deleteBtn.classList.remove("d-none");
				deleteBtn.textContent = isActive ? "비활성" : "활성";

				document.getElementById("lineModalTitle").innerText = "라인 상세";
		        
		        document.getElementById("lineId").value = data.lineId ?? "";
		        document.getElementById("lineName").value = data.lineName ?? "";
				document.getElementById("lineRemark").value = data.remark ?? "";
		        
		        document.getElementById("lineId").disabled = true;

				deleteBtn.dataset.lineId  = data.lineId;
				deleteBtn.dataset.useYn   = data.useYn;
		    }
		
		    modal.show();
		}
        
        // 설비 등록 및 수정
        document.getElementById("equipmentForm").addEventListener("submit", async (event) => {
        	event.preventDefault();

        	// create / update 파악
        	const mode = document.getElementById("equipId").disabled
        		? "UPDATE" : "CREATE";

			// update일 경우 한 번 더 묻기
			if (mode === "UPDATE")
				if (!confirm("정말 수정하시겠습니까?")) return;
        	
        	// request
        	const payload = {
        		equipId	 : document.getElementById("equipId").value,
        		koName	 : document.getElementById("koName").value,
        		equipName: document.getElementById("equipName").value,
        		remark	 : document.getElementById("equipRemark").value
        	};
        	
        	// create / update 보내는 url 및 method 분기
        	const url 	 = mode === "CREATE"
        		? "/equipment/equipType"
        		: `/equipment/equipType/${payload.equipId}` ;
        	
        	const method = mode	=== "CREATE" ? "POST" : "PATCH";
        	
        	
        	try {
        		const response = await fetch(url, {
        			method,
        			headers: {
        				"Content-Type" : "application/json",
        				[csrfHeader] : csrfToken
        			},
        			body: JSON.stringify(payload)
        		});
        		
        		if (!response.ok) {
        			const err = await response.json();
        			alert(err.message || "저장 실패");
        			return;
        		}
        		
        		alert ("성공적으로 저장되었습니다.");
        		bootstrap.Modal.getInstance(
        			document.getElementById("equipmentModal")
        		).hide();

				loadGridData('/equipment/equip/data', equipmentGrid);	// 목록 재조회
        		
        	} catch (err) {
        		console.error(err);
        		alert("오류가 발생했습니다.");
        	}
        
        });


	  // 설비 비활성화
	  document.getElementById("btnDeleteEquip").addEventListener("click", async (event) => {

		  const btn = document.getElementById("btnDeleteEquip");
		  const equipId = btn.dataset.equipId;
		  const currentUseYn = btn.dataset.useYn;

		  const nextUseYn = currentUseYn === "Y" ? "N" : "Y";
		  const actionText = nextUseYn === "N" ? "비활성화" : "활성화";

		  if (!confirm(`설비를 ${actionText}하시겠습니까?`)) return;

		try {
			const response = await fetch(`/equipment/equipType/${equipId}/inActive`, {
				method: "PATCH",
				headers: {
					"Content-Type": "application/json",
					[csrfHeader]: csrfToken
				},
				body: JSON.stringify({ useYn : nextUseYn })
			});

			if (!response.ok) throw await response.json();

			alert(`${actionText}되었습니다.`);
			bootstrap.Modal.getInstance(
					document.getElementById("equipmentModal")
			).hide();

			loadGridData('/equipment/equip/data', equipmentGrid);
		} catch (err) {
			console.error(err);
			alert("오류가 발생했습니다.");
		}
	  });

		  // 라인 등록 및 수정
		  document.getElementById("lineForm").addEventListener("submit", async (event) => {
			  event.preventDefault();

			  // create / update 파악
			  const mode = document.getElementById("btnDeleteLine").classList.contains("d-none")
					  ? "CREATE" : "UPDATE";

			  // update일 경우 한 번 더 묻기
			  if (mode === "UPDATE")
				  if (!confirm("정말 수정하시겠습니까?")) return;

			  // request
			  const payload = {
				  lineId	 : document.getElementById("lineId").value,
				  lineName	 : document.getElementById("lineName").value,
				  remark	 : document.getElementById("lineRemark").value
			  };

			  // create / update 보내는 url 및 method 분기
			  const url 	 = mode === "CREATE"
					  ? "/equipment/line"
					  : `/equipment/line/${payload.equipId}` ;

			  const method = mode	=== "CREATE" ? "POST" : "PATCH";


			  try {
				  const response = await fetch(url, {
					  method,
					  headers: {
						  "Content-Type" : "application/json",
						  [csrfHeader] : csrfToken
					  },
					  body: JSON.stringify(payload)
				  });

				  if (!response.ok) {
					  const err = await response.json();
					  alert(err.message || "저장 실패");
					  return;
				  }

				  alert ("성공적으로 저장되었습니다.");
				  bootstrap.Modal.getInstance(
						  document.getElementById("lineModal")
				  ).hide();

				  loadGridData('/equipment/line/data', lineGrid);	// 목록 재조회

			  } catch (err) {
				  console.error(err);
				  alert("오류가 발생했습니다.");
			  }

		  });


		  // 설비 비활성화
		  document.getElementById("btnDeleteLine").addEventListener("click", async (event) => {

			  const btn = document.getElementById("btnDeleteLine");
			  const lineId = btn.dataset.lineId;
			  const currentUseYn = btn.dataset.useYn;

			  const nextUseYn = currentUseYn === "Y" ? "N" : "Y";
			  const actionText = nextUseYn === "N" ? "비활성화" : "활성화";

			  if (!confirm(`라인을 ${actionText}하시겠습니까?`)) return;

			  try {
				  const response = await fetch(`/equipment/line/${lineId}/inActive`, {
					  method: "PATCH",
					  headers: {
						  "Content-Type": "application/json",
						  [csrfHeader]: csrfToken
					  },
					  body: JSON.stringify({ useYn : nextUseYn })
				  });

				  if (!response.ok) throw await response.json();

				  alert(`${actionText}되었습니다.`);
				  bootstrap.Modal.getInstance(
						  document.getElementById("lineModal")
				  ).hide();

				  loadGridData('/equipment/line/data', lineGrid);
			  } catch (err) {
				  console.error(err);
				  alert("오류가 발생했습니다.");
			  }
		  });

        </script>
    </th:block>

</th:block>