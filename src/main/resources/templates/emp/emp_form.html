<th:block xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layouts/layout.html}">
<body>
<th:block layout:fragment="content">
	<div class="custom-body container-xxl flex-grow-1 container-p-y">
	
	<h2 th:text="${mode == 'edit'} ? '인사 정보 수정' : '인사 신규 등록'">
	  인사 신규 등록
	</h2>

	  <form th:action="@{${formAction}}" th:object="${empDTO}" method="post"
      		enctype="multipart/form-data" novalidate>
      		
       <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
	
	    <!-- 상단 2컬럼 카드 -->
	    <div class="row g-4 mb-5">
	      <!-- 기본정보 -->
			<div class="col-md-6">
			  <div class="card h-100">
			    <div class="card-body">
			      <h5 class="card-title mb-3">기본정보</h5>
			
			      <!-- 1행: 이름 / 사번 -->
			      <div class="row g-3">
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="empName">이름</label>
			          <input type="text" class="form-control" id="empName"
			                 th:field="*{empName}" placeholder="김여운">
			          <div class="text-danger small"
			               th:if="${#fields.hasErrors('empName')}"
			               th:errors="*{empName}"></div>
			        </div>
			
			        <!-- 사번은 서비스에서 생성됨: 입력받지 않기 or 읽기전용(바인딩X) -->
			        <div class="col-12 col-md-6">
			          <label class="form-label" for="empNo">사번</label>
			          <input type="text" class="form-control" id="empNo"
			                 th:field="*{empId}"
			                 th:placeholder="${mode == 'edit'} ? '' : '자동생성'"
			                 readonly>
			        </div>
			      </div>
			
			      <!-- 2행: 성별 / 입사일 -->
			      <div class="row g-3 mt-0">
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="gender">성별</label>
			          <select class="form-select" id="gender"
			                  th:field="*{gender}" th:disabled="${mode == 'edit'}">
			            <option value="">선택</option>
			            <option value="M">남</option>
			            <option value="F">여</option>
			          </select>
			          <input type="hidden" th:if="${mode == 'edit'}" th:field="*{gender}">
			          <div class="text-danger small"
			               th:if="${#fields.hasErrors('gender')}"
			               th:errors="*{gender}"></div>
			        </div>
			
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="hireDate">입사일</label>
			          <input type="date" class="form-control" id="hireDate"
			                 th:field="*{hireDate}" th:disabled="${mode == 'edit'}">
			          <input type="hidden" th:if="${mode == 'edit'}" th:field="*{hireDate}">
			          <div class="text-danger small"
			               th:if="${#fields.hasErrors('hireDate')}"
			               th:errors="*{hireDate}"></div>
			        </div>
			      </div>
			
			      <!-- 3행: 주민번호 / 상태  ★ 상태를 이 줄로 올림 -->
			      <div class="row g-3 mt-0">
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="rrn">주민등록번호</label>
			          <!-- 등록 모드 -->
			          <input th:if="${mode == 'create'}" type="text"
			                 class="form-control" id="rrn" th:field="*{rrn}"
			                 maxlength="14" placeholder="900101-1234567" autocomplete="off">
			          <!-- 수정 모드 -->
			          <div th:if="${mode == 'edit'}">
			            <!-- 화면 표시용 (마스킹) -->
			            <input type="text" class="form-control mb-1" id="rrnDisplay"
			                   th:value="*{rrnMasked}" readonly>
			            <!-- 실제 값 전송용 -->
			            <input type="hidden" th:field="*{rrn}">
			          </div>
			          <div class="text-danger small"
			               th:if="${#fields.hasErrors('rrn')}"
			               th:errors="*{rrn}"></div>
			        </div>
			
			        <!-- 상태: 관리자/인사만 보임 -->
			        <div class="col-12 col-md-6"
			             sec:authorize="hasAnyRole('SYS_ADMIN','HR_ADMIN')">
			          <label class="form-label required" for="status">상태</label>
			          <select class="form-select" id="status" th:field="*{status}">
			            <option value="ACTIVE">재직</option>
			            <option value="LEAVE">휴직</option>
			            <option value="RETIRE">퇴직</option>
			          </select>
			        </div>
			      </div>
			
			      <!-- 일반 사원일 때는 상태를 수정 못하지만, 값은 그대로 보내기 -->
			      <input type="hidden" th:field="*{status}"
			             sec:authorize="!hasAnyRole('SYS_ADMIN','HR_ADMIN')"/>
			
			      <!-- 4행: 사원 사진  ★ 따로 한 줄로 빼줌 -->
			      <div class="row g-3 mt-0">
			        <div class="col-12 col-md-6">
			          <label class="form-label" for="photoFile">사원 사진</label>
			
			          <!-- 새 파일 업로드 (등록/수정 공통) -->
			          <input type="file" class="form-control"
			                 th:field="*{photoFile}" id="photoFile" accept="image/*">
			          <!-- 기존 photoFileId 유지용 hidden -->
			          <input type="hidden" th:field="*{photoFileId}">
			          <div class="form-text">새 사진을 선택하면 기존 사진이 교체됩니다.</div>
			
			          <div th:if="${mode == 'edit'}" class="mt-2">
			            <img th:if="${empDTO.photoFileId != null}"
			                 th:src="@{'/files/download/' + ${empDTO.photoFileId}}"
			                 alt="프로필 사진"
			                 class="rounded"
			                 style="width: 120px; height: 120px; object-fit: cover;">
			            <img th:if="${empDTO.photoFileId == null}"
			                 src="/assets/img/default-profile.png"
			                 alt="기본 프로필"
			                 class="rounded"
			                 style="width: 120px; height: 120px; object-fit: cover;">
			          </div>
			        </div>
			      </div>
			
			    </div>
			  </div>
			</div>

	
	      <!-- 연락/계정 -->
			<div class="col-md-6">
			  <div class="card h-100">
			    <div class="card-body">
			      <h5 class="card-title mb-3">연락/계정</h5>
			
			      <!-- 이메일 / 연락처 -->
			      <div class="row g-3">
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="email">이메일</label>
			          <input type="email" class="form-control" id="email" th:field="*{email}" placeholder="name@yeoun.com">
			          <div class="text-danger small" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
			        </div>
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="phone">연락처</label>
			          <input type="tel" class="form-control" id="phone" th:field="*{mobile}" placeholder="010-1234-5678" maxlength="13">
			          <div class="text-danger small" th:if="${#fields.hasErrors('mobile')}" th:errors="*{mobile}"></div>
			        </div>
			      </div>
			
			      <!-- 주소 -->
			      <div class="row g-3 mt-0">
			        <div class="col-12">
			          <label class="form-label required">주소</label>
			
			          <!-- 우편번호 + 검색버튼 -->
			          <div class="input-group mb-2">
			          	<input type="text" class="form-control" id="zipcode" th:field="*{postCode}" placeholder="우편번호">
			            <input class="btn btn-outline-secondary" type="button" onclick="btnSearchZip()" value="우편번호 찾기"><br>
			          </div>
			
			          <!-- 기본주소 -->
			          <input type="text" class="form-control mb-2" id="address" th:field="*{address1}" placeholder="도로명 주소">
			          <!-- 상세주소 -->
			          <input type="text" class="form-control" id="addressDetail" th:field="*{address2}" placeholder="상세 주소">
					  <div class="text-danger small" th:if="${#fields.hasErrors('postCode')}" th:errors="*{postCode}"></div>
					  <div class="text-danger small" th:if="${#fields.hasErrors('address1')}" th:errors="*{address1}"></div>
			        </div>
			      </div>
			
			    </div>
			  </div>
			</div>
	    </div>
	
	    <!-- 조직/직무 -->
	    <div class="card mb-4">
	      <div class="card-body">
	        <h5 class="card-title mb-3">조직/직무</h5>
	
	        <div class="row g-3">
	        
	          <!-- 본부 (ERP / MES) -->
	          <div class="col-12 col-md-4">
	            <label class="form-label required" for="topDept">본부</label>
				<select class="form-select" id="topDept" th:disabled="${mode == 'edit'}">
				  <option value="">선택</option>
				  <option th:each="d : ${deptList}"
				          th:if="${d.parentDeptId == 'DEP999'}"
				          th:value="${d.deptId}"
				          th:text="${d.deptAbbr}"></option>
				</select>
	          </div>
	          
	          <!-- 부서 -->
	          <div class="col-12 col-md-4">
	            <label class="form-label required" for="deptId">부서</label>
	            <!-- 부서 (개발부, 마케팅부, 생산부, 영업부, 인사부 등) -->
				<select class="form-select" id="deptId" th:field="*{deptId}" th:disabled="${mode == 'edit'}">
				  <option value="">선택</option>
				  <option th:each="d : ${deptList}"
				          th:if="${d.parentDeptId != null and d.parentDeptId != 'DEP999'}"
				          th:value="${d.deptId}"
				          th:text="${d.deptName}"
				          th:attr="data-parent=${d.parentDeptId}">
				  </option>
				</select>
				<input type="hidden" th:if="${mode == 'edit'}" th:field="*{deptId}">
				<div class="text-danger small" th:if="${#fields.hasErrors('deptId')}" th:errors="*{deptId}"></div>
	          </div>
	          
	          <!-- 직급 -->
	          <div class="col-12 col-md-4">
	            <label class="form-label required" for="posCode">직급</label>
	            <select class="form-select" id="posCode" name="posCode" th:field="*{posCode}" th:disabled="${mode == 'edit'}">
	              <option value="">선택</option>
	              <option th:each="p : ${positionList}" th:value="${p.posCode}" th:text="${p.posName}"></option>
	            </select>
	            <input type="hidden" th:if="${mode == 'edit'}" th:field="*{posCode}">
	            <div class="text-danger small" th:if="${#fields.hasErrors('posCode')}" th:errors="*{posCode}"></div>
	          </div>
	          
	        </div>
	      </div>
	    </div>
	
	    <!-- 급여통장 정보 -->
	    <div class="card mb-4">
	      <div class="card-body">
	        <h5 class="card-title mb-3">급여통장 정보</h5>
	
	        <div class="row g-3">
	          <div class="col-12 col-md-6">
	            <label class="form-label required" for="bankCode">은행</label>
	            <select class="form-select" id="bankCode" name="bankCode" th:field="*{bankCode}" required>
	              <option value="">선택</option>
	              <option th:each="b : ${bankList}" th:value="${b.codeId}" th:text="${b.codeName}"></option>
	            </select>
	            <div class="text-danger small" th:if="${#fields.hasErrors('bankCode')}" th:errors="*{bankCode}"></div>
	          </div>
	          
	          <div class="col-12 col-md-6">
	            <label class="form-label required" for="accountNo">계좌번호</label>
	            <input type="text" class="form-control" id="accountNo" th:field="*{accountNo}" placeholder="123-456-789012" maxlength="20">
	          	<div class="text-danger small" th:if="${#fields.hasErrors('accountNo')}" th:errors="*{accountNo}"></div>
	          </div>
	        </div>
	
	        <div class="row g-3 mt-0">
	          <div class="col-12 col-md-6">
	            <label class="form-label required" for="holder">예금주</label>
	            <input type="text" class="form-control" id="holder"  name="holder" th:field="*{holder}" placeholder="김여운">
	            <div class="text-danger small" th:if="${#fields.hasErrors('holder')}" th:errors="*{holder}"></div>
	          </div>
	          
	          <div class="col-12 col-md-6">
	            <label class="form-label" for="bankbookFile">통장사본 첨부</label>
	            
		        <!-- 새 파일 선택 (등록/수정 공통) -->
		        <input type="file" class="form-control" th:field="*{bankbookFile}" id="bankbookFile">
	           
	            <!-- 수정 모드에서 기존 통장사본 링크 보여주기 -->
		        <div th:if="${mode == 'edit'}" class="mb-1">
		          <a th:if="${empDTO.fileId != null}"
		             th:href="@{'/files/download/' + ${empDTO.fileId}}"
		             target="_blank"
		             class="small">
		            기존 통장 사본 보기
		          </a>
		          <span th:if="${empDTO.fileId == null}" class="text-muted small">
		            등록된 통장 사본이 없습니다.
		          </span>
		        </div>
		
		
		        <!-- 기존 fileId 유지용 hidden -->
		        <input type="hidden" th:field="*{fileId}">
		        <div class="form-text">새 파일을 선택하면 기존 통장 사본이 교체됩니다.</div>
	          </div>
	        </div>
	      </div>
	    </div>
	
	    <!-- 버튼 -->
	    <div class="d-flex justify-content-end gap-2">
	    
		  <!-- 관리자 / 인사 / 부서장 : 사원 목록으로 -->
		  <a sec:authorize="hasAnyRole('SYS_ADMIN','HR_ADMIN','DEPT_MANAGER')"
		     href="/emp" class="btn btn-outline-secondary">
		    취소
		  </a>
		
		  <!-- 일반 사원 : 메인으로 (권한 없음 = 이쪽으로 옴) -->
		  <a sec:authorize="isAuthenticated() and !hasAnyRole('SYS_ADMIN','HR_ADMIN','DEPT_MANAGER')"
		     href="/main" class="btn btn-outline-secondary">
		    취소
		  </a>
	      <button type="submit" class="btn btn-primary" th:text="${mode == 'edit'} ? '수정 완료' : '저장'">저장</button>
	    </div>
	  </form>
	</div>
	
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" defer></script>	
<script src="/js/emp/emp.js"></script>

</th:block>
</body>
