<th:block xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layouts/layout.html}">

<th:block layout:fragment="content">
	<div class="custom-body container-xxl flex-grow-1 container-p-y">
	
	<div class="d-flex justify-content-between align-items-center mb-3">
		<h2 th:text="${mode == 'edit'} ? '인사 정보 수정' : '인사 신규 등록'">
		  인사 신규 등록
		</h2>
		
		<!-- 수정 모드 + 관리자일 때만 보이게 -->
	    <form th:if="${mode == 'edit'} 
	               and ${#authorization.expr('hasRole(''ROLE_SYS_ADMIN'') or hasRole(''ROLE_HR_ADMIN'')')}"
	          th:action="@{|/auth/manage/emp/${empDTO.empId}/pwdResetDefault|}"
	          method="post"
	          onsubmit="return confirm('비밀번호를 1234로 초기화할까요?');">
	      <button type="submit" class="btn btn-outline-danger btn-sm">
	        비밀번호 초기화
	      </button>
	    </form>
	</div>
	
	<div th:if="${msg}" class="alert alert-warning mt-3">
	  <div class="fw-semibold" th:text="${msg}"></div>
	  <div class="small" th:text="${infoMsg}"></div>
	</div>

	  <form th:action="@{${formAction}}" th:object="${empDTO}" method="post" enctype="multipart/form-data" novalidate>
      	
      		
	    <!-- 상단 2컬럼 카드 -->
	    <div class="row g-4 mb-5">
	      <!-- 기본정보 -->
			<div class="col-md-6">
			  <div class="card h-100">
			    <div class="card-body">
			      <h5 class="card-title mb-3">기본정보</h5>
			
			      <!-- 1행: 이름 / 사번 -->
			      <div class="row g-3">
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="empName">이름</label>
			          <input type="text" class="form-control" id="empName" th:field="*{empName}" placeholder="김여운" th:readonly="${mode == 'edit'}">
			          <div class="text-danger small" th:if="${#fields.hasErrors('empName')}" th:errors="*{empName}"></div>
			        </div>
			        <!-- 사번은 서비스에서 생성됨: 입력받지 않기 -->
			        <div class="col-12 col-md-6">
			          <label class="form-label" for="empNo">사번</label>
			          <input type="text" class="form-control" id="empNo" th:field="*{empId}" th:placeholder="${mode == 'edit'} ? '' : '자동생성'" readonly>
			        </div>
			      </div>
			
			      <!-- 2행: 성별 / 입사일 -->
			      <div class="row g-3 mt-0">
			      	<!-- 성별 -->
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="gender">성별</label>
			          <select class="form-select" id="gender" th:field="*{gender}" th:disabled="${mode == 'edit'}">
			            <option value="">선택</option>
			            <option value="M">남</option>
			            <option value="F">여</option>
			          </select>
			          <input type="hidden" th:if="${mode == 'edit'}" th:field="*{gender}">
			          <div class="text-danger small" th:if="${#fields.hasErrors('gender')}" th:errors="*{gender}"></div>
			        </div>
					<!-- 입사일 -->
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="hireDate">입사일</label>
			          <input type="date" class="form-control" id="hireDate" th:field="*{hireDate}" th:disabled="${mode == 'edit'}">
			          <input type="hidden" th:if="${mode == 'edit'}" th:field="*{hireDate}">
			          <div class="text-danger small" th:if="${#fields.hasErrors('hireDate')}" th:errors="*{hireDate}"></div>
			        </div>
			      </div>
			
			      <!-- 3행: 주민번호 + 사원사진(파일선택) / 사진 미리보기 -->
			      <div class="row g-3 mt-0">
			      	<!-- 왼쪽: 주민번호 + 파일 선택 -->
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="rrn">주민등록번호</label>
			          <!-- 등록 모드 -->
			          <input th:if="${mode == 'create'}" type="text" class="form-control" id="rrn" th:field="*{rrn}" maxlength="14" placeholder="900101-1234567" autocomplete="off">
			          <!-- 수정 모드 -->
			          <div th:if="${mode == 'edit'}">
			            <!-- 화면 표시용 (마스킹) -->
			            <input type="text" class="form-control mb-1" id="rrnDisplay" th:value="*{rrnMasked}" readonly>
			            <!-- 실제 값 전송용 -->
			            <input type="hidden" th:field="*{rrn}">
			          </div>
			          <div class="text-danger small" th:if="${#fields.hasErrors('rrn')}" th:errors="*{rrn}"></div>
			        
			       	  <!-- 파일 선택 -->
			          <div class="mt-2">
				        <label class="form-label" for="photoFile">사원 사진</label>
				        <input type="file" class="form-control" th:field="*{photoFile}" id="photoFile" accept="image/*">
				        <input type="hidden" th:field="*{photoFileId}">
				        <div class="form-text">새 사진 선택 시 기존 사진이 교체됩니다.</div>
				      </div>
			        </div> 
			        
			        <!-- 오른쪽: 사진 미리보기 -->
  					<div class="col-12 col-md-6 text-center">
    				  <label class="form-label">사진 미리보기</label>
    				  <div class="mt-1">
      					<img id="photoPreview" th:src="${empDTO.photoFileId != null} ? @{'/files/download/' + ${empDTO.photoFileId}} : @{/img/default-profile.png}"
        						 alt="프로필 사진" class="rounded shadow-sm" style="width:140px; height:140px; object-fit:cover;">
    				  </div>
  					</div>
				  </div>
			    </div>
			  </div>
			</div> <!-- 기본정보 끝 -->

	
	      <!-- 연락/계정 -->
			<div class="col-md-6">
			  <div class="card h-100">
			    <div class="card-body">
			      <h5 class="card-title mb-3">연락/계정</h5>
			
			      <!-- 이메일 / 연락처 -->
			      <div class="row g-3">
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="email">이메일</label>
			          <input type="email" class="form-control" id="email" th:field="*{email}" placeholder="name@yeoun.com">
			          <div class="text-danger small" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
			        </div>
			        <div class="col-12 col-md-6">
			          <label class="form-label required" for="phone">연락처</label>
			          <input type="tel" class="form-control" id="phone" th:field="*{mobile}" placeholder="010-1234-5678" maxlength="13">
			          <div class="text-danger small" th:if="${#fields.hasErrors('mobile')}" th:errors="*{mobile}"></div>
			        </div>
			      </div>
			
			      <!-- 주소 -->
			      <div class="row g-3 mt-0">
			        <div class="col-12">
			          <label class="form-label required">주소</label>
			
			          <!-- 우편번호 + 검색버튼 -->
			          <div class="input-group mb-2">
			          	<input type="text" class="form-control" id="zipcode" th:field="*{postCode}" placeholder="우편번호" readonly>
			            <input class="btn btn-outline-secondary" type="button" onclick="btnSearchZip()" value="우편번호 찾기"><br>
			          </div>
			
			          <!-- 기본주소 -->
			          <input type="text" class="form-control mb-2" id="address" th:field="*{address1}" placeholder="도로명 주소" readonly>
			          <!-- 상세주소 -->
			          <input type="text" class="form-control" id="addressDetail" th:field="*{address2}" placeholder="상세 주소">
					  <div class="text-danger small" th:if="${#fields.hasErrors('postCode')}" th:errors="*{postCode}"></div>
					  <div class="text-danger small" th:if="${#fields.hasErrors('address1')}" th:errors="*{address1}"></div>
			        </div>
			      </div>
			
			    </div>
			  </div>
			</div>
	    </div>
	
	    <!-- 조직/직무 -->
	    <div class="card mb-4">
	      <div class="card-body">
	        <h5 class="card-title mb-3">조직/직무</h5>
	
	        <div class="row g-3">
	        
	          <!-- 본부 (ERP / MES) -->
	          <div class="col-12 col-md-4">
	            <label class="form-label required" for="topDept">본부</label>
				<select class="form-select" id="topDept" th:disabled="${mode == 'edit'}">
				  <option value="">선택</option>
				  <option th:each="d : ${topDeptList}"
				          th:value="${d.deptId}"
				          th:text="${d.deptAbbr}"></option>
				</select>
	          </div>
	          
	          <!-- 부서 -->
	          <div class="col-12 col-md-4">
	            <label class="form-label required" for="deptId">부서</label>
	            <!-- 부서 (개발부, 마케팅부, 생산부, 영업부, 인사부 등) -->
				<select class="form-select" id="deptId" th:field="*{deptId}" th:disabled="${mode == 'edit'}">
				  <option value="">선택</option>
				  <option th:each="d : ${subDeptList}"
				          th:value="${d.deptId}"
				          th:text="${d.deptName}"
				          th:attr="data-parent=${d.parentDeptId}">
				  </option>
				</select>
				<input type="hidden" th:if="${mode == 'edit'}" th:field="*{deptId}">
				<div class="text-danger small" th:if="${#fields.hasErrors('deptId')}" th:errors="*{deptId}"></div>
	          </div>
	          
	          <!-- 직급 -->
	          <div class="col-12 col-md-4">
	            <label class="form-label required" for="posCode">직급</label>
	            <select class="form-select" id="posCode" name="posCode" th:field="*{posCode}" th:disabled="${mode == 'edit'}">
	              <option value="">선택</option>
	              <option th:each="p : ${positionList}" th:value="${p.posCode}" th:text="${p.posName}"></option>
	            </select>
	            <input type="hidden" th:if="${mode == 'edit'}" th:field="*{posCode}">
	            <div class="text-danger small" th:if="${#fields.hasErrors('posCode')}" th:errors="*{posCode}"></div>
	          </div>
	          
	        </div>
	      </div>
	    </div>
	
	    <!-- 급여통장 정보 -->
	    <div class="card mb-4">
	      <div class="card-body">
	        <h5 class="card-title mb-3">급여통장 정보</h5>
	
			<!-- HR / SYS 관리자 : 수정 가능 -->
			<div th:if="${canEditBankInfo}">
	        <div class="row g-3">
	          <div class="col-12 col-md-6">
	            <label class="form-label required" for="bankCode">은행</label>
	            <select class="form-select" id="bankCode" name="bankCode" th:field="*{bankCode}" required>
	              <option value="">선택</option>
	              <option th:each="b : ${bankList}" th:value="${b.codeId}" th:text="${b.codeName}"></option>
	            </select>
	            <div class="text-danger small" th:if="${#fields.hasErrors('bankCode')}" th:errors="*{bankCode}"></div>
	          </div>
	          
	          <div class="col-12 col-md-6">
	            <label class="form-label required" for="accountNo">계좌번호</label>
	            <input type="text" class="form-control" id="accountNo" th:field="*{accountNo}" placeholder="123-456-789012" maxlength="20">
	          	<div class="text-danger small" th:if="${#fields.hasErrors('accountNo')}" th:errors="*{accountNo}"></div>
	          </div>
	        </div>
	
	        <div class="row g-3 mt-0">
	          <div class="col-12 col-md-6">
	            <label class="form-label" for="holder">예금주</label>
	            <input type="text" class="form-control" id="holder"  name="holder" th:value="${empDTO.empName}" readonly>
	                <div class="form-text text-muted">
				      본인 명의 계좌만 등록 가능합니다.
				    </div>
	          </div>
	          
	          <div class="col-12 col-md-6">
	            <label class="form-label" for="bankbookFile">통장사본 첨부</label>
	            
		        <!-- 새 파일 선택 (등록/수정 공통) -->
		        <input type="file" class="form-control" th:field="*{bankbookFile}" id="bankbookFile">
	           
	            <!-- 수정 모드에서 기존 통장사본 링크 보여주기 -->
		        <div th:if="${mode == 'edit'}" class="mb-1">
		          <a th:if="${empDTO.fileId != null}"
		             th:href="@{'/files/download/' + ${empDTO.fileId}}"
		             target="_blank"
		             class="small">
		            기존 통장 사본 보기
		          </a>
		          <span th:if="${empDTO.fileId == null}" class="text-muted small">
		            등록된 통장 사본이 없습니다.
		          </span>
		        </div>
		
		
		        <!-- 기존 fileId 유지용 hidden -->
		        <input type="hidden" th:field="*{fileId}">
		        <div class="form-text">새 파일을 선택하면 기존 통장 사본이 교체됩니다.</div>
	          </div>
	        </div>
	      </div>
	      
	      <!-- 일반 사원: 읽기만 가능 -->
	      <div th:unless="${canEditBankInfo}">
	          <div class="row g-3">
	            <div class="col-12 col-md-6">
	              <label class="form-label" for="bankCodeView">은행</label>
	              <!-- 화면에는 읽기전용 텍스트 -->
	              <select class="form-select" id="bankCodeView" th:field="*{bankCode}" disabled>
			        <option value="">선택</option>
			        <option th:each="b : ${bankList}" th:value="${b.codeId}" th:text="${b.codeName}"></option>
			      </select>
	              <!-- 실제 전송용 hidden -->
	              <input type="hidden" th:field="*{bankCode}">
	            </div>
	            
	            <div class="col-12 col-md-6">
	              <label class="form-label" for="accountNoView">계좌번호</label>
	              <input type="text" class="form-control" id="accountNoView" th:value="*{accountNo}" readonly>
	              <input type="hidden" th:field="*{accountNo}">
	            </div>
	          </div>
	
	          <div class="row g-3 mt-0">
	            <div class="col-12 col-md-6">
	              <label class="form-label" for="holderView">예금주</label>
	              <input type="text" class="form-control" id="holderView" th:value="${empDTO.empName}" readonly>
	              <div class="form-text text-muted">
	                본인 명의 계좌만 등록 가능합니다.
	              </div>
	            </div>
	            
	            <div class="col-12 col-md-6">
	              <label class="form-label">통장사본</label>
	              
	              <div th:if="${empDTO.fileId != null}">
	                <a th:href="@{'/files/download/' + ${empDTO.fileId}}" target="_blank" class="small">
	                  통장 사본 보기
	                </a>
	              </div>
	              <div th:if="${empDTO.fileId == null}" class="text-muted small">
	                등록된 통장 사본이 없습니다.
	              </div>
	
	              <!-- fileId만 hidden으로 유지 -->
	              <input type="hidden" th:field="*{fileId}">
	            </div>
	          </div>
	        </div>
	        
	        <br>
	        
	        <div class="alert alert-light border small mb-3" sec:authorize="!hasAnyRole('SYS_ADMIN','HR_ADMIN')">
	          급여통장 정보 변경은 인사부에 문의바랍니다.
         	</div>
	        
	      </div>
		</div>	
	    <!-- 버튼 -->
	    <div class="d-flex justify-content-end gap-2">
	    
		  <!-- 관리자 / 인사 / 부서장 : 사원 목록으로 -->
		  <a sec:authorize="hasAnyRole('SYS_ADMIN','HR_ADMIN','DEPT_MANAGER')"
		     href="/emp" class="btn btn-outline-secondary">
		    취소
		  </a>
		
		  <!-- 일반 사원 : 메인으로 (권한 없음 = 이쪽으로 옴) -->
		  <a sec:authorize="isAuthenticated() and !hasAnyRole('SYS_ADMIN','HR_ADMIN','DEPT_MANAGER')"
		     href="/main" class="btn btn-outline-secondary">
		    취소
		  </a>
	      <button type="submit" class="btn btn-primary" th:text="${mode == 'edit'} ? '수정 완료' : '저장'">저장</button>
	    </div>
	  </form>
	</div>
	
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" defer></script>	
<script src="/js/emp/emp.js"></script>

</th:block>
</body>
