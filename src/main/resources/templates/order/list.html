<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/layout.html}">
<head>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/line-awesome/1.3.0/line-awesome/css/line-awesome.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
  body {
    background: #f4f3fb;
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    color: #2f2b43;
  }

  .title {
    font-size: 1.8em;
    margin-bottom: 1.8rem;
    color: #697a8d;
    font-weight: 500;
  }

  .order-card {
    border-radius: 12px;
    border: 1px solid #e2e1f3;
    background: #ffffff;
    box-shadow: 0 10px 25px rgba(80, 72, 180, 0.08);
    padding: 16px 18px;
    margin-bottom: 18px;
  }

  .order-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .card-title {
    font-size: 1.6em;
    font-weight: 600;
    color: #41388f;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .yeoun-badge-outline {
    border-radius: 999px;
    border: 1px solid rgba(111, 92, 236, 0.4);
    color: #6f5cec;
    padding: 2px 10px;
    font-size: 11px;
    background: rgba(111, 92, 236, 0.04);
  }

  .status-badge {
    width: 90px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    padding: 3px 20px;
  }

  .status-create     { background: #e7eef7; color: #3a5a8a; }
  .status-release    { background: #f0eaff; color: #6a4cc3; }
  .status-progress   { background: #e6f5ec; color: #15803d; }
  .status-complete   { background: #e8f1ff; color: #1d4ed8; }
  .status-cancel     { background: #fdecec; color: #c0392b; }


  .form-label {
    font-size: 13px;
    font-weight: 500;
    color: #514d7a;
    margin-bottom: 4px;
  }

  .form-control,
  .form-select {
    font-size: 13px;
    border-radius: 8px;
    border-color: #d9d8f2;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: #6f5cec;
    box-shadow: 0 0 0 0.15rem rgba(111, 92, 236, 0.2);
  }

  .form-text {
    font-size: 11px;
    color: #9a96c0;
  }

  .btn-yeoun-primary {
    font-size: 15px;               /* 버튼 글자 키움 */
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #6f5cec, #9479ff);
    color: white;
  }
  
  .btn-yeoun-primary:hover {
  	background: linear-gradient(135deg, #b8b3ff, #d9d4ff);
  	color: #5c4ac7 !important;
  }

  .btn-yeoun-outline {
    border-radius: 999px;
    border: 1px solid #c9c6f3;
    background: #fff;
    color: #655dc0;
    font-size: 13px;
    padding: 8px 14px;
  }

  .badge-priority {
    border-radius: 999px;
    font-size: 11px;
    padding: 3px 8px;
    background: #fdf4e2;
    color: #d97907;
  }

  .search-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .search-row .form-control,
  .search-row .form-select {
    font-size: 12px;
    height: 32px;
    padding: 4px 10px;
  }

  .search-row .btn {
    height: 32px;
    font-size: 12px;
    padding: 4px 10px;
  }

  /** modal **/

  /* 메인 카드형 모달 */
  .yeoun-modal {
    border-radius: 18px;
    border: none;
    background: #ffffff;
    box-shadow: 0 15px 35px rgba(90, 75, 180, 0.15);
  }

  /* 헤더 */
  .yeoun-modal-header {
    padding: 18px 24px;
    border-bottom: 1px solid #eeeafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title-wrap i {
    color: #6a5acd;
    font-size: 20px;
    margin-right: 6px;
  }

  .modal-title {
    font-weight: 600;
    color: #3b336d;
  }
  
  /* 작업자 배치 */
  .worker-flow-container {
	  display: flex;
	  justify-content: space-between;
	  align-items: stretch;
	  gap: 14px;
	  padding: 16px;
	  background: #faf9ff;
	  border: 1px solid #e2defc;
	  border-radius: 14px;
	  box-shadow: 0 8px 18px rgba(110, 94, 230, 0.08);
	}
	
	.flow-item {
	  flex: 1;
	  min-width: 160px;
	  background: #ffffff;
	  border-radius: 12px;
	  border: 1px solid #dedbf7;
	  padding: 14px 12px;
	  text-align: center;
	  box-shadow: 0 5px 12px rgba(150, 140, 240, 0.10);
	}
	
	.flow-title {
	  font-size: 15px;
	  font-weight: 700;
	  color: #5a51c8;
	  margin-bottom: 3px;
	}
	
	.flow-desc {
	  font-size: 12px;
	  color: #7e78aa;
	  margin-bottom: 10px;
	}
	
	.flow-select {
	  width: 100%;
	  padding: 8px 10px;
	  border-radius: 8px;
	  border: 1px solid #d1cdf6;
	  background: #fafaff;
	  font-size: 13px;
	  color: #4b4470;
	}
	
	.flow-select:focus {
	  border-color: #7b6fff;
	  box-shadow: 0 0 0 0.15rem rgba(130, 115, 255, 0.25);
	}

  

  /* 바디 */
  .yeoun-modal-body {
    padding: 24px 28px;
  }

  /* 탭 */
  .yeoun-tabs .nav-link {
    border: none;
    color: #867ccc;
    font-weight: 500;
    padding: 10px 18px;
    border-radius: 8px 8px 0 0;
  }

  .yeoun-tabs .nav-link.active {
    color: #4b3fbf;
    background: #f3f1ff;
    font-weight: 600;
  }

  /* 정보 그리드 */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 18px;
  }

  .info-item label {
    font-size: 13px;
    font-weight: 600;
    color: #776fb5;
    margin-bottom: 4px;
  }

  /* 진행률 */
  .info-progress {
    grid-column: 1 / span 3;
  }

  .yeoun-progress {
    background: #ece9ff;
    height: 10px;
    border-radius: 999px;
  }

  .yeoun-progress .progress-bar {
    background: linear-gradient(135deg, #6f5cec, #9479ff);
    border-radius: 999px;
    font-size: 11px;
  }

  /* 테이블 */
  .yeoun-table thead {
    background: #f5f3ff;
    color: #5b53a1;
  }

  .yeoun-table td {
    font-size: 13px;
  }

  /* 푸터 */
  .yeoun-modal-footer {
    border-top: 1px solid #eeeafc;
    padding: 16px 24px;
    text-align: right;
  }

  /* 입력폼 스타일 보완 */
  #workCreateForm .form-label {
    color: #6a63b9;
    font-weight: 600;
    font-size: 13px;
  }

  #workCreateForm .form-control,
  #workCreateForm .form-select {
    background: #faf9ff;
    border-color: #dcd6fe;
  }

  #workCreateForm .form-control:focus,
  #workCreateForm .form-select:focus {
    border-color: #6a5acd;
    box-shadow: 0 0 0 0.15rem rgba(106, 92, 205, 0.2);
  }

  /* info-value는 read-only 표현 */
  .info-value {
    background: #faf9ff;
    border: 1px solid #e3dfff;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 14px;
    color: #4a436d;
  }

  .status-tag {
    font-weight: 600;
    color: #6a5acd;
  }

  /* 테이블 */
  .yeoun-table thead {
    background: #f5f3ff;
    color: #5b53a1;
  }

</style>
</head>
<body>
<th:block layout:fragment="content">
<div class="custom-body container-xxl flex-grow-1 container-p-y">
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <div class="title">
      <i class="bi bi-kanban-fill"></i>
      작업지시 관리
    </div>
    <button class="btn btn-yeoun-primary" id="btnCreate">
      <i class="bi bi-plus-circle"></i> 새로 등록
    </button>
  </div>
  <!-- ===== 왼쪽: 작업지시 목록 ===== -->
  <div>
    <div class="order-card">
      <div class="order-card-header">
        <div class="card-title">
          작업지시 목록
        </div>
        <span class="yeoun-badge-outline">
            미처리 생산계획 8건
        </span>
      </div>

      <!-- 검색 / 필터 영역 -->
      <div class="mb-2 search-row">
        <input id="searchKeyword" type="text" class="form-control" placeholder="품목명 / 작업지시 번호 검색" />
        <select id="searchStatus" class="form-select" style="max-width: 150px;">
          <option value="ALL">전체 상태</option>
          <option value="CREATED">준비</option>
          <option value="RELEASED">확정</option>
          <option value="IN_PROGRESS">진행</option>
          <option value="COMPLETED">완료</option>
          <option value="CANCELED">취소</option>
        </select>
        <input type="date" class="form-control" id="startDateFrom" style="max-width: 150px;" />
        <button id="btnSearchOrder" class="btn btn-sm btn-outline-secondary">
          <i class="las la-search drop-shadow fs-5"></i>
        </button>
      </div>

      <div id="workOrderGrid"></div>
    </div>
  </div>
</div>

  <!-- 모달 HTML -->
  <!-- =================================== 등록 모달 ========================================== -->
  <div class="modal fade" id="workCreateModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content yeoun-modal">

        <!-- Header -->
        <div class="yeoun-modal-header">
          <div class="modal-title-wrap">
            <h5 class="modal-title">작업지시 등록</h5>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Body -->
        <div class="yeoun-modal-body">
          <form id="workCreateForm">
          
          	<div class="row g-3 mb-3">
          		<div class="col-6">
          			<label class="form-label">생산 계획서</label>
          			<select name="planId" class="form-select" id="planId" style="color: red;">
          				<option disabled selected>생산 계획을 먼저 선택해주세요.</option>
          				<th:block th:each="plan : ${plans}">
          					<option th:value="${plan.planId}"
          							th:text="${plan.planId}"
          							th:data-name="${plan.itemName}"
          							th:data-qty="${plan.totalQty}"
          							style="color: #888;"
          					></option>
          				</th:block>
          			</select>
          		</div>
          		<div class="col-3">
          			<label class="form-label">품목 및 수량</label> <!-- view 용도. form 전송값 없음 -->
          			<div id="planDetail" class="form-control">
          				생산 계획을 선택해주세요.
          			</div> 
          		</div>
          		<div class="col-3">
          			<label class="form-label">공정 코드(라우트)</label>
          			<input type="text" class="form-control" id="routeHeader" name="routeId"
          				placeholder="생산 계획을 선택해주세요."/>
<!--           			<div id="routeHeader" class="form-control">
          				생산 계획을 선택해주세요.
          			</div> -->
          		</div>
          	</div>

            <!-- 품목 / 라인 -->
            <div class="row g-3 mb-3">
              <div class="col-4">
                <label class="form-label">품목</label>
                <select name="prdId" class="form-select" id="prdName">
                	<option disabled selected>생산 계획을 선택해주세요.</option>
                	<th:block th:each="prod : ${prods}">
                		<option th:value="${prod.prdId}" th:text="${prod.prdName}"></option>
                	</th:block>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label">라인</label>
                <select name="lineId" class="form-select" id="line">
                  <option disabled selected>눌러서 선택</option>
                  <th:block th:each="line : ${lines}">
                  	<option th:value="${line.lineId}" th:text="${line.lineName}"></option>
                  </th:block>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label">계획 수량</label>
                <input name="planQty" type="number" class="form-control" id="planQty" placeholder="예) 250">
              </div>
            </div>

            <!-- 날짜 / 시간 -->
            <div class="row g-3 mb-3">
              <div class="col-3">
          			<label class="form-label">예상 소요 시간</label>
          			<div id="referTime" class="form-control">
          				생산 계획을 선택해주세요.
          			</div>
          		</div>
              <div class="col-3">
                <label class="form-label">계획 일자</label>
                <input type="date" class="form-control" id="planDate">
              </div>
              <div class="col-3">
                <label class="form-label">시작 시간</label>
                <input type="time" class="form-control" id="startTime">
              </div>
              <div class="col-3">
                <label class="form-label">종료 시간</label>
                <input type="time" class="form-control" id="endTime">
              </div>
              <input type="hidden" name="planStartDate" id="planStartDate">
			  <input type="hidden" name="planEndDate" id="planEndDate">
            </div>

            
            <div class="worker-flow-container">
			
			  <div class="flow-item">
			    <div class="flow-title">블렌딩</div>
			    <div class="flow-desc">혼합탱크·교반기</div>
			    <select class="flow-select" id="blendSelect">
			      <option selected disabled>선택</option>
			      <th:block th:each="worker : ${workers}">
                  	<option th:value="${worker.empId}"
                  			th:text="|${worker.empName} (${worker.posName})|"
                  	></option>
                  </th:block>
			    </select>
			  </div>
			  
			  <div class="flow-item">
			    <div class="flow-title">여과</div>
			    <div class="flow-desc">여과기</div>
			    <select class="flow-select" id="filterSelect">
			      <option selected disabled>선택</option>
			      <th:block th:each="worker : ${workers}">
                  	<option th:value="${worker.empId}"
                  			th:text="|${worker.empName} (${worker.posName})|"
                  	></option>
                  </th:block>
			    </select>
			  </div>
			
			  <div class="flow-item">
			    <div class="flow-title">충전</div>
			    <div class="flow-desc">충전기</div>
			    <select class="flow-select" id="fillSelect">
			      <option selected disabled>선택</option>
			      <th:block th:each="worker : ${workers}">
                  	<option th:value="${worker.empId}"
                  			th:text="|${worker.empName} (${worker.posName})|"
                  	></option>
                  </th:block>
			    </select>
			  </div>
			
			  <div class="flow-item">
			    <div class="flow-title">조립 + 캡핑</div>
			    <div class="flow-desc">반자동 캡핑기</div>
			    <select class="flow-select" id="cappingSelect">
			      <option selected disabled>선택</option>
			      <th:block th:each="worker : ${workers}">
                  	<option th:value="${worker.empId}"
                  			th:text="|${worker.empName} (${worker.posName})|"
                  	></option>
                  </th:block>
			    </select>
			  </div>
			
			  <div class="flow-item">
			    <div class="flow-title">라벨링 + 포장</div>
			    <div class="flow-desc">라벨러·포장기</div>
			    <select class="flow-select" id="labelPackSelect">
			      <option selected disabled>선택</option>
			      <th:block th:each="worker : ${workers}">
                  	<option th:value="${worker.empId}"
                  			th:text="|${worker.empName} (${worker.posName})|"
                  	></option>
                  </th:block>
			    </select>
			  </div>
			
			</div>

            
            <!-- 비고 -->
            <div class="mb-3">
              <label class="form-label">비고</label>
              <textarea name="remark" class="form-control" id="remark" rows="3" placeholder="특이사항, 주의사항 등을 입력하세요."
              			style="resize: none;"
              ></textarea>
            </div>
          </form>
        </div>

        <!-- Footer -->
        <div class="yeoun-modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-yeoun-primary" id="btnCreateSubmit">
            <i class="bi bi-check2-circle"></i> 저장
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- =============================== 상세 모달 ================================= -->
  <div class="modal fade" id="workDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content yeoun-modal">

        <!-- HEADER -->
        <div class="yeoun-modal-header">
          <div class="modal-title-wrap">
            <i class="bi bi-eye-fill"></i>
            <h5 class="modal-title" id="detailModalTitle">작업지시 상세</h5>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- BODY -->
        <div class="yeoun-modal-body">

          <!-- 탭 -->
          <ul class="nav yeoun-tabs mb-4" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#detail-basic">기본 정보</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#detail-route">공정 라우트</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#detail-lot">LOT 정보</button>
            </li>
          </ul>

          <div class="tab-content">

            <!-- ======================== 기본 정보 ======================== -->
            <div class="tab-pane fade show active" id="detail-basic">

              <div class="info-grid">

                <div class="info-item">
                  <label>작업지시번호</label>
                  <div class="info-value" id="detailWoId"></div>
                </div>

                <div class="info-item">
                  <label>품목명</label>
                  <div class="info-value" id="detailItemName"></div>
                </div>

                <div class="info-item">
                  <label>상태</label>
                  <div class="info-value status-tag" id="detailStatus"></div>
                </div>

                <div class="info-item">
                  <label>계획 수량</label>
                  <div class="info-value" id="detailPlanQty"></div>
                </div>

                <div class="info-item">
                  <label>생산 일자</label>
                  <div class="info-value" id="detailPlanDate"></div>
                </div>

                <div class="info-item">
                  <label>생산 시간</label>
                  <div class="info-value" id="detailPlanTime"></div>
                </div>

                <div class="info-item">
                  <label>할당 라인</label>
                  <div class="info-value" id="detailLineName"></div>
                </div>

                <div class="info-item">
                  <label>할당 설비</label>
                  <div class="info-value" id="detailEquipName"></div>
                </div>

                <div class="info-item">
                  <label>담당 작업자</label>
                  <div class="info-value" id="detailWorkerName"></div>
                </div>

                <!-- 진행률 -->
                <div class="info-progress">
                  <label>공정 진행률</label>
                  <div class="progress yeoun-progress">
                    <div id="detailProgressBar" class="progress-bar" style="width: 0%">0%</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ======================== 공정 라우트 ======================== -->
            <div class="tab-pane fade" id="detail-route">
              <table class="table yeoun-table">
                <thead>
                <tr>
                  <th>STEP</th>
                  <th>공정명</th>
                  <th>설비</th>
                  <th>기준시간</th>
                  <th>상태</th>
                </tr>
                </thead>
                <tbody id="detailRouteTable"></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- FOOTER -->
        <div class="yeoun-modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>

      </div>
    </div>
  </div>


</th:block>

<th:block layout:fragment="myScript">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

  let workOrderGrid = null;

  document.addEventListener("DOMContentLoaded", () => {

    const gridEl = document.getElementById("workOrderGrid");
    if (!gridEl) {
      console.error("workOrderGrid 요소 없음!");
      return;
    }

    // 1) Grid 생성
    workOrderGrid = new tui.Grid ({
      el: gridEl,
      bodyHeight: 450,
      rowHeaders: ["rowNum"],
      scrollX: false,
      scrollY: true,
      pageOptions: {
        useClient: true,
        perPage: 10
      },
      columnOptions: {resizable: true},
      columns: [
        {header: "작업지시번호", name: "orderId", width: 160, align: "center"},
        {header: "품번", name: "prdId", align: "center"},
        {header: "품목군", name: "prdName", align: "left"},
        {header: "계획수량", name: "planQty", align: "right"},
        {
          header: "시작시간",
          name: "startDate",
          align: "center",
          formatter: ({ value }) => formatDate(value)
        },
        {
          header: "종료시간",
          name: "endDate",
          align: "center",
          formatter: ({ value }) => formatDate(value)
        },
        {
          header: "상태",
          name: "status",
          align: "center",
          formatter: ({ value }) => formatStatusBadge(value)
        },
        {header: "출고여부", name: "outboundYn", align: "center"},
        {
          header: "상세",
          name: "btn",
          width: 90,
          align: "center",
          formatter: () => "<button class='btn btn-primary btn-sm grid-detail'>상세</button>"
        }
      ]
    });

    // 2) 검색 버튼 클릭 시 조회
    document.getElementById("btnSearchOrder").addEventListener("click", () => {
      loadWorkOrderGrid();
    });

    // 3) 페이지 로드 시 전체 조회
    loadWorkOrderGrid();

    // 4) 상세 버튼 클릭 이벤트
    workOrderGrid.on("click", (event) => {
      if (event.columnName !== "btn") return;
      const row = workOrderGrid.getRow(event.rowKey);
      openDetailModal(row.orderId);
    });

  });

  // ======================================================
  // 작업지시 목록 조회
  // ======================================================
  function loadWorkOrderGrid(){

    const keyword = document.getElementById("searchKeyword").value || "";
    const status  = document.getElementById("searchStatus").value  || "";
    const date    = document.getElementById("startDateFrom").value || "";

    const query = new URLSearchParams({
      keyword,
      status,
      date
    });

    fetch("/order/list/data?" + query.toString())
            .then(res => {
              if (!res.ok) throw new Error("HTTP " + res.status);
              return res.json();
            })
            .then(data => {
              console.log("작업지시 목록 : ", data);
              workOrderGrid.resetData(data);
            })
            .catch(err => {
              console.error("작업지시 목록 조회 오류", err);
              alert("조회 중 오류 발생");
            });

  }

  // 상태 뱃지 포맷
  function formatStatusBadge(status) {

    const map = {
      "CREATED":      { text: "준비",       cls: "status-badge status-create" },
      "RELEASED":     { text: "확정",       cls: "status-badge status-release" },
      "IN_PROGRESS":  { text: "진행중",     cls: "status-badge status-progress" },
      "COMPLETED":    { text: "완료",       cls: "status-badge status-complete" },
      "CANCELED":     { text: "취소",       cls: "status-badge status-cancel" }
    };

    const item = map[status] || { text: status, cls: "status-badge" };

    return `<span class="${item.cls}">${item.text}</span>`;
  }

  // 생산 일정 포맷
  function formatDate(dt) {
    if (!dt) return "-";

    // dt = "2025-12-04T09:00:00"
    const d = new Date(dt);

    if (isNaN(d.getTime())) return dt; // 잘못된 날짜면 원본 그대로

    const yy = String(d.getFullYear()).substring(2);
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");

    return `${yy}-${mm}-${dd} ${hh}:${mi}`;
  }


  // ======================================================
  // 작업지시 등록 모달
  // ======================================================

  // 등록 모달 열기
  document.getElementById("btnCreate").addEventListener("click", () => {
    document.getElementById("workCreateForm").reset(); // 등록 전용 폼 초기화
    document.getElementById("planDetail").innerText = "생산 계획을 선택해주세요.";
    document.getElementById("referTime").innerText = "생산 계획을 선택해주세요.";
    document.getElementById("routeHeader").innerText = "생산 계획을 선택해주세요.";
    const modal = new bootstrap.Modal(document.getElementById("workCreateModal"));
    modal.show();
  });
  
  let maxQty = null;

  // 생산계획서 정보 불러오기
  document.getElementById("planId").addEventListener("change", function() {
	    const option = this.selectedOptions[0];
	    const product = option.dataset.name;
	    const qty = option.dataset.qty;
	    
	    maxQty = qty;	// 수량 저장
	    referTime = calcRecommendedHours(qty);	// 소요시간 계산

	    document.getElementById("planDetail").innerText = `${product} / ${qty}개`;
	    document.getElementById("referTime").innerText = referTime;
	    if (qty < 336) {
	    	document.getElementById("planQty").value = qty;
	    }
	    
	    const matchedOption = selectOptionByText("prdName", product);

	    if (matchedOption) {
	        const prdId = matchedOption.value;     // ⭐ 여기 쓰면 됨!
	        document.getElementById("routeHeader").innerText = `RT-${prdId}`;
	    }
	});
  
  // 품목 자동 선택
  function selectOptionByText(selectId, text) {
	    const select = document.getElementById(selectId);
	    for (let option of select.options) {
	        if (option.text.trim() === text.trim()) {
	            option.selected = true;
	            return option;
	        }
	    }
	    return null;
	}
  
  // 계획 수량 제한
  document.getElementById("planQty").addEventListener("input", function () {
    if (maxQty && Number(this.value) > maxQty) {
        alert(`이 생산계획의 최대 수량은 ${maxQty}개입니다.`);
        this.value = maxQty;
    }
  });
  
  // 예상 소요 시간 계산
  function calcRecommendedHours(qty) {
	   const hours = qty / 42;
	   return "약 " + Math.ceil(qty / 42) + "시간(" + Math.round(hours * 10) / 10 + "시간) 소요 예상";
  }
  
  // 시간 합쳐 input value 지정
  document.getElementById("btnCreateSubmit").addEventListener("click", function () {
	    
	    const date = document.getElementById("planDate").value;
	    const start = document.getElementById("startTime").value;
	    const end = document.getElementById("endTime").value;

	    if (date && start) {
	        document.getElementById("planStartDate").value = `${date}T${start}`;
	    }

	    if (date && end) {
	        document.getElementById("planEndDate").value = `${date}T${end}`;
	    }

	    document.getElementById("workCreateForm").submit();
	});


  
  // ======================================================
  // 작업지시 상세 모달
  // ======================================================
  
  // 상세 모달 열기
  workOrderGrid.on("click", (event) => {
	  if (event.columnName !== "btn") return;
	  const row = workOrderGrid.getRow(event.rowKey);
	  openDetailModal(row.orderId);
  });


  function openDetailModal(workId) {
    console.log("Detail:", workId);
    const modal = new bootstrap.Modal(document.getElementById("workDetailModal"));

    // 1) 기본 정보 로드
    fetch(`/api/work-order/${workId}`)
            .then(res => res.json())
            .then(data => {
              document.getElementById("detailWoId").innerText = data.woId;
              document.getElementById("detailItemName").innerText = data.itemName;
              document.getElementById("detailStatus").innerText = data.status;
              document.getElementById("detailPlanQty").innerText = data.quantity;
              document.getElementById("detailPlanDate").innerText = data.planDate;
              document.getElementById("detailPlanTime").innerText =
                      `${data.planStart} ~ ${data.planEnd}`;
              document.getElementById("detailLineName").innerText = data.lineName;
              document.getElementById("detailEquipName").innerText = data.equipName;
              document.getElementById("detailWorkerName").innerText = data.worker;

              // 진행률 처리
              const p = data.progress;
              const bar = document.getElementById("detailProgressBar");
              bar.style.width = p + "%";
              bar.innerText = p + "%";
            });

    // 2) 라우팅 정보
    fetch(`/api/work-order/${workId}/routing`)
            .then(res => res.json())
            .then(list => {
              const t = document.getElementById("detailRouteTable");
              t.innerHTML = "";
              list.forEach(r => {
                t.innerHTML += `
          <tr>
            <td>${r.step}</td>
            <td>${r.processName}</td>
            <td>${r.equipment}</td>
            <td>${r.stdTime} min</td>
            <td>${r.status}</td>
          </tr>`;
              });
            });

    // 3) LOT 정보
    fetch(`/api/work-order/${workId}/lot`)
            .then(res => res.json())
            .then(list => {
              const t = document.getElementById("detailLotTable");
              t.innerHTML = "";
              list.forEach(l => {
                t.innerHTML += `
          <tr>
            <td>${l.lotNo}</td>
            <td>${l.itemName}</td>
            <td>${l.qty}</td>
            <td>${l.warehouse}</td>
            <td>${l.remark}</td>
          </tr>`;
              });
            });

    modal.show();
  }

</script>
</th:block>

</body>
</html>

<!--

function openDetailModal(workId){
  // 1) 기본 정보 로드
  fetch(`/api/work-order/${workId}`)
    .then(res=>res.json())
    .then(data=>{
      document.getElementById("woId").value = data.woId;
      document.getElementById("itemName").value = data.itemName;
      document.getElementById("planQty").value = data.quantity;
      document.getElementById("status").value = data.status;
      document.getElementById("planDate").value = data.planDate;
      document.getElementById("planTime").value = data.planStart + " ~ " + data.planEnd;
      document.getElementById("lineName").value = data.lineName;
      document.getElementById("equipName").value = data.equipName;
      document.getElementById("workerName").value = data.worker;

      // 진행률
      const p = data.progress;
      const bar = document.getElementById("progressBar");
      bar.style.width = p + "%";
      bar.innerText = p + "%";
    });

  // 2) 공정 라우트 로드
  fetch(`/api/work-order/${workId}/routing`)
    .then(res=>res.json())
    .then(list=>{
      const tbody = document.getElementById("routeTable");
      tbody.innerHTML = "";
      list.forEach(r=>{
        tbody.innerHTML += `
          <tr>
            <td>${r.step}</td>
            <td>${r.processName}</td>
            <td>${r.equipment}</td>
            <td>${r.stdTime} min</td>
            <td>${r.status}</td>
          </tr>`;
      });
    });

  // 3) LOT 정보 로드
  fetch(`/api/work-order/${workId}/lot`)
    .then(res=>res.json())
    .then(list=>{
      const tbody = document.getElementById("lotTable");
      tbody.innerHTML = "";
      list.forEach(l=>{
        tbody.innerHTML += `
          <tr>
            <td>${l.lotNo}</td>
            <td>${l.itemName}</td>
            <td>${l.qty}</td>
            <td>${l.warehouse}</td>
            <td>${l.remark}</td>
          </tr>`;
      });
    });

  // 마지막 → 모달 열기
  new bootstrap.Modal(document.getElementById("workModal")).show();
}
-->