<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{/layouts/layout.html}">
          
  <th:block layout:fragment="content">

    <div class="container-xxl py-4">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-primary fw-bold">급여 계산 및 확정</h1>
      </div>

      <!-- 1. 급여 계산 및 시뮬레이션 -->
      <section class="card shadow-sm mb-4">
        <div class="card-body">         

          <!-- 조건 선택 -->
          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <label for="calc_month" class="col-form-label fw-semibold fs-5">계산 대상 월</label>
            </div>
            <div class="col-auto">
              <select id="calc_month" class="form-select form-select">
                <option th:each="m : ${months}"
                        th:value="${m}"
                        th:selected="${m==yyyymm}"
                        th:text="${#strings.substring(m,0,4)} + '년 ' + ${#strings.substring(m,4,6)} + '월'">
                </option>
              </select>
            </div>
          </div>

          <!-- 액션 버튼 -->
      <div class="d-flex flex-wrap gap-2 mb-3">

		  <button id="btnSimulateAll" class="btn btn-warning">
		    계산 시뮬레이션 (가계산)
		  </button>
		
		  <button id="btnConfirmAll" class="btn btn-success">
		    계산 결과 확정
		  </button>
		
		  <!-- 숨겨진 yyyymm 값 -->
		  <input type="hidden" id="calcMonth" th:value="${yyyymm}">
		  <input type="hidden" id="calcMonthConfirm" th:value="${yyyymm}">
		</div>


          <!-- 상태 박스 -->
          <div id="statusBox"
               class="alert d-flex justify-content-between align-items-center"
               th:classappend="${status.calculated} ? ' alert-success' : ' alert-warning'">

            <div>
              선택 월(<span id="statMonth" th:text="${yyyymm}">YYYYMM</span>) 계산 상태:
<!--               <strong id="statCalc" th:switch="${status.calcStatus}"> -->
<!--                 <span th:case="'CONFIRMED'">확정 완료</span> -->
<!--                 <span th:case="'CALCULATED'">계산 완료</span> -->
<!--                 <span th:case="'SIMULATED'">가계산</span> -->
<!--                 <span th:case="*">미계산</span> -->
<!--               </strong> -->

               <span class="badge bg-primary">총 [[${status.totalCount}]]건</span>
		      <span class="badge bg-success">확정 [[${status.confirmedCount}]]건</span>
		      <span class="badge bg-warning text-dark">가계산 [[${status.simulatedCount}]]건</span>
<!-- 		      <span class="badge bg-info text-dark">계산완료 [[${status.calculatedCount}]]건</span> -->

            </div>

            <div>
              총지급: <span id="statTot" class="text-primary fw-bold ms-1"
                         th:text="${#numbers.formatInteger(status.totAmt,0)}">0</span> 원
              · 공제:
              <span id="statDed" class="text-danger fw-bold ms-1"
                    th:text="${#numbers.formatInteger(status.dedAmt,0)}">0</span> 원
              · 실수령:
              <span id="statNet" class="fw-bold ms-1"
                    th:text="${#numbers.formatInteger(status.netAmt,0)}">0</span> 원
            </div>

          </div>

          <!-- AG Grid -->
          <h6 class="fw-semibold mt-3">계산 결과 검토</h6>
          <div id="payslipGrid" class="ag-theme-alpine mt-3"
               style="height: 420px; width: 100%; border-radius: 10px;"></div>

        </div>
      </section>

      <!-- 상세 모달 -->
      <div th:replace="~{pay/payslip_detailModal :: payslip_detailModal}"></div>

      

      <!-- 2. 급여 명세서 관리 -->
      <section class="card shadow-sm">
        <div class="card-body">
          <h3 class="h5 mb-3 border-start ps-2">급여 명세서 관리</h3>
          <p class="text-secondary">
            확정된 급여 계산 결과를 바탕으로 <strong>월별 급여 명세서</strong>를 사원별로 자동 생성하고 PDF 파일로 제공합니다.
          </p>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <label class="col-form-label fw-semibold">명세서 생성 월</label>
            </div>
            <div class="col-auto">
              <select id="payroll_month" class="form-select form-select-sm">
                <option th:each="m : ${months}" th:value="${m}"
                        th:selected="${m==yyyymm}"
                        th:text="${#strings.substring(m,0,4)} + '년 ' + ${#strings.substring(m,4,6)} + '월'">
                </option>
              </select>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-success">명세서 일괄 생성</button>
            <button type="button" class="btn btn-outline-secondary">생성 현황 확인</button>
            <button type="button" class="btn btn-outline-secondary">명세서 PDF 일괄 다운로드</button>
          </div>

        </div>
      </section>

    </div>


<!-- AG-Grid CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>


<!-- Slip Data Injection -->
<script th:inline="javascript">
  const slipsData = /*[[${slips}]]*/ [];
  const currentYymm = /*[[${yyyymm}]]*/ "";
</script>

<!-- External JS -->
<script src="/js/pay/pay_calc_all.js"></script>

  </th:block>
</th:block>
