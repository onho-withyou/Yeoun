<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{layouts/layout}">

<th:block layout:fragment="content">

  <style>
    .rule-item-card{border-radius:14px}
    .nowrap{white-space:nowrap}
    .amount{font-variant-numeric:tabular-nums}
    .muted{color:#6b7280}

    /* ===================== íƒ­ ì»¤ìŠ¤í…€ ===================== */
    .pay-tabs {
      border-bottom: 2px solid #e5e7eb; /* ë¼ì¸ */
      margin-bottom: 1.5rem;
    }
    .pay-tabs .nav-link {
      position: relative;
      color: #6b7280;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px 8px 0 0;
      transition: all 0.25s ease;
    }
    .pay-tabs .nav-link:hover {
      color: #0d6efd;
      background: #f1f5ff;
    }
    .pay-tabs .nav-link.active {
      color: #0d6efd;
      background: #ffffff;
      box-shadow: 0 -2px 8px rgba(13,110,253,0.1);
    }
    .pay-tabs .nav-link.active::after {
      content: '';
      position: absolute;
      left: 0; right: 0; bottom: -2px;
      height: 3px;
      background: #0d6efd;
      border-radius: 2px;
      animation: underlineIn 0.3s ease forwards;
    }
    @keyframes underlineIn {
      from {width: 0; margin-left: 50%;}
      to {width: 100%; margin-left: 0;}
    }
  </style>

  <!-- ===================== ìƒë‹¨ íƒ­ ===================== -->
<ul class="nav pay-tabs">
  <li class="nav-item"><a class="nav-link" th:href="@{/pay/rule}"      th:classappend="${activeTab}=='rule' ? 'active'">ê¸‰ì—¬ê¸°ì¤€ì •ë³´</a></li>
  <li class="nav-item"><a class="nav-link" th:href="@{/pay/rule_calc}" th:classappend="${activeTab}=='calc' ? 'active'">ê¸‰ì—¬ê³„ì‚°</a></li>
  <li class="nav-item"><a class="nav-link" th:href="@{/pay/rule_item}" th:classappend="${activeTab}=='item' ? 'active'">ê¸‰ì—¬í•­ëª©</a></li>
</ul>



  <div class="container-xxl py-4">
  
   <!-- ë©” ì„¸ ì§€ -->
<div th:if="${msg}" class="alert alert-success alert-dismissible fade show" role="alert">
  <span th:text="${msg}">ì„±ê³µ ë©”ì‹œì§€</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div th:if="${err}" class="alert alert-danger alert-dismissible fade show" role="alert">
  <span th:text="${err}">ì—ëŸ¬ ë©”ì‹œì§€</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
 
 
 <div th:if="${activeTab}=='rule'">
    <!-- í—¤ë” -->    
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold text-primary mb-0">ê¸‰ì—¬ ê¸°ì¤€ì •ë³´</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">ë“± ë¡</button>
    </div>

    <!-- ì¹´ë“œí˜• ëª©ë¡ -->
   <div>
    <h5 class="card-title mb-3">ê¸‰ì—¬ ê¸°ì¤€ ëª©ë¡</h5>

    <div class="text-muted" th:if="${#lists.isEmpty(rules)}">ë“±ë¡ëœ ê¸‰ì—¬ ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

    <div th:each="r : ${rules}"
         class="card mb-3 border-0 shadow-sm rule-item-card"
         th:attr="data-rule-id=${r.ruleId}">
      <div class="card-body p-3">

        <div class="d-flex justify-content-between align-items-center pb-2 border-bottom">
          <div class="d-flex align-items-center">
            <h6 class="mb-0 me-3 fw-bold text-dark">
              ê¸°ì¤€ ID: <span class="text-primary" th:text="${r.ruleId}"></span>
            </h6>
            <span class="text-muted small">
              (<span th:text="${#temporals.format(r.startDate, 'yyyy.MM.dd')}"></span> ~
               <span th:text="${r.endDate != null ? #temporals.format(r.endDate, 'yyyy.MM.dd') : 'ë¬´ê¸°í•œ'}"></span>)
            </span>
          </div>

          <div class="d-flex align-items-center">
            <span class="badge me-3" th:classappend="${r.status.name()=='ACTIVE'} ? 'bg-success' : 'bg-secondary'"
                  th:text="${r.status}"></span>

            <button class="btn btn-sm btn-outline-primary me-2"
                    data-bs-toggle="modal"
                    th:attr="data-bs-target=${'#editModal-' + r.ruleId}">
              ìˆ˜ì •
            </button>

            <button class="btn btn-sm btn-outline-danger btn-delete-rule"
                    th:attr="data-href=@{'/pay/rule/delete/' + ${r.ruleId}}, data-rule-id=${r.ruleId}">
              ì‚­ì œ
            </button>
          </div>
        </div>

        <div class="row g-3 pt-3">
          <div class="col-lg-5 col-md-6 border-end">
            <span class="d-block fw-semibold text-secondary mb-2">ğŸ’° ì§€ê¸‰ ì •ë³´</span>

            <div class="d-flex justify-content-between small mb-1">
              <span class="text-muted">ê¸°ë³¸ê¸‰:</span>
              <span class="fw-medium amount">
                <span th:text="${#numbers.formatDecimal(r.baseAmt, 0, 'COMMA', 0, 'POINT')}"></span>ì›
              </span>
            </div>
            <div class="d-flex justify-content-between small mb-1">
              <span class="text-muted">ì‹ëŒ€:</span>
              <span class="fw-medium amount">
                <span th:text="${#numbers.formatDecimal(r.mealAmt, 0, 'COMMA', 0, 'POINT')}"></span>ì›
              </span>
            </div>
            <div class="d-flex justify-content-between small mb-1">
              <span class="text-muted">êµí†µë¹„:</span>
              <span class="fw-medium amount">
                <span th:text="${#numbers.formatDecimal(r.transAmt, 0, 'COMMA', 0, 'POINT')}"></span>ì›
              </span>
            </div>
            <div class="d-flex justify-content-between small mt-2 pt-2 border-top">
              <span class="text-muted fw-semibold nowrap">ì§€ê¸‰ì¼:</span>
              <span class="fw-bold text-primary" th:text="${r.payDay} + 'ì¼'"></span>
            </div>
          </div>

          <div class="col-lg-7 col-md-6">
            <span class="d-block fw-semibold text-secondary mb-2">ğŸ“‰ ê³µì œìœ¨ ê¸°ì¤€</span>

            <div class="row row-cols-2 g-2">
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">êµ­ë¯¼ì—°ê¸ˆìœ¨:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.penRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">ê±´ê°•ë³´í—˜ìœ¨:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.hlthRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">ê³ ìš©ë³´í—˜ìœ¨:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.empRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">ì†Œë“ì„¸ìœ¨:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.taxRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-end pt-3 mt-3 border-top">
          <div class="small text-secondary flex-grow-1 me-4">
            <span class="fw-semibold me-1">ë¹„ê³ :</span>
            <span th:text="${r.remark ?: '-'}"></span>
          </div>
          <div class="text-end small text-muted flex-shrink-0">
            <span class="d-block">ìƒì„±:
              <span th:text="${#temporals.format(r.createdDate, 'yy.MM.dd HH:mm')}"></span>
            </span>
            <span class="d-block">ìˆ˜ì •:
              <span th:text="${r.updatedDate != null ? #temporals.format(r.updatedDate, 'yy.MM.dd HH:mm') : '-'}"></span>
            </span>
          </div>
        </div>

      </div>
    </div>
</div>

    <!-- [ë“±ë¡] ëª¨ë‹¬ -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <form th:action="@{/pay/rule}" th:object="${newRule}" method="post" class="needs-validation" id="create-rule-form" novalidate>
            <div class="modal-header">
              <h5 class="modal-title">ê¸‰ì—¬ ê¸°ì¤€ ë“±ë¡</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>

            <div class="modal-body">
              <div class="row g-4">
                <div class="col-lg-7">
                  <h6 class="mb-3 text-secondary">ê¸°ë³¸/ìˆ˜ë‹¹ ê¸°ì¤€</h6>

                  <div class="row g-3 mb-4">
                    <div class="col-md-4">
                      <label class="form-label">ì ìš© ì‹œì‘ì¼</label>
                      <input type="date" th:field="*{startDate}" class="form-control" id="create-start" required>
                      <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">ì ìš© ì¢…ë£Œì¼</label>
                      <input type="date" th:field="*{endDate}" class="form-control" id="create-end">
                      <div class="form-text">ë¬´ê¸°í•œì´ë©´ ë¹„ì›Œë‘ì„¸ìš”</div>
                      <div class="invalid-feedback">ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">ì§€ê¸‰ì¼</label>
                      <input type="number" th:field="*{payDay}" class="form-control" min="1" max="31" placeholder="ì˜ˆ: 25" required>
                      <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                  </div>

                  <div class="row g-3 mb-4">
                    <div class="col-md-4">
                      <label class="form-label">ê¸°ë³¸ê¸‰</label>
                      <input type="text" class="form-control amount-input" th:field="*{baseAmt}" inputmode="numeric" required>
                      <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">ì‹ëŒ€</label>
                      <input type="text" class="form-control amount-input" th:field="*{mealAmt}" inputmode="numeric" required>
                      <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">êµí†µë¹„</label>
                      <input type="text" class="form-control amount-input" th:field="*{transAmt}" inputmode="numeric" required>
                      <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                  </div>

                  <h6 class="mb-3 text-secondary">ê³µì œ í•­ëª© ê´€ë¦¬</h6>
                  <div class="card card-sm">
                    <div class="card-body p-2">
                      <table class="table table-sm table-borderless align-middle mb-0">
                        <thead class="table-light">
                          <tr><th style="width:120px">í•­ëª©</th><th style="width:110px">ì„¸ìœ¨</th><th style="width:100px">ê¸°ì¤€</th><th>ë²•ì •ê¸°ì¤€</th></tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>êµ­ë¯¼ì—°ê¸ˆ</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{penRate}" step="0.0001" min="0" max="1" placeholder="0.045" required></td>
                            <td>ê¸‰ì—¬</td><td>êµ­ë¯¼ì—°ê¸ˆë²•</td>
                          </tr>
                          <tr>
                            <td>ê±´ê°•ë³´í—˜</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{hlthRate}" step="0.0001" min="0" max="1" placeholder="0.03545" required></td>
                            <td>ê¸‰ì—¬</td><td>êµ­ë¯¼ê±´ê°•ë³´í—˜ë²•</td>
                          </tr>
                          <tr>
                            <td>ê³ ìš©ë³´í—˜</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{empRate}" step="0.0001" min="0" max="1" placeholder="0.009" required></td>
                            <td>ê¸‰ì—¬</td><td>ê³ ìš©ë³´í—˜ë²•</td>
                          </tr>
                          <tr>
                            <td>ì†Œë“ì„¸</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{taxRate}" step="0.0001" min="0" max="1" placeholder="0.06" required></td>
                            <td>ê³¼ì„¸í‘œì¤€</td><td>ì†Œë“ì„¸ë²•(ê°„ì´)</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <h6 class="mb-3 mt-4 text-secondary">ê¸°íƒ€ ì •ë³´</h6>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">STATUS</label>
                      <select class="form-select" th:field="*{status}" required>
                        <option value="">-- ì„ íƒ --</option>
                        <option value="ACTIVE">ACTIVE</option>
                        <option value="INACTIVE">INACTIVE</option>
                      </select>
                      <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                    <div class="col-12">
                      <label class="form-label">REMARK</label>
                      <textarea class="form-control" th:field="*{remark}" rows="2" placeholder="ë©”ëª¨..."></textarea>
                    </div>
                  </div>
                </div>

                <!-- ë“±ë¡ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="col-lg-5">
                  <h6 class="mb-3 text-secondary">ê¸‰ì—¬ ê³µì œ ë¯¸ë¦¬ë³´ê¸°</h6>
                  <div class="card bg-light border-0">
                    <div class="card-body">
                      <p class="mb-3 text-muted">ê¸°ì¤€ ê³µì œì•¡ ì˜ˆìƒ (ì„¸ì „ ê¸‰ì—¬ <b><span id="create-preview-gross-pay">0</span></b>ì›)</p>
                      <table class="table table-sm mb-0">
                        <thead class="table-light">
                          <tr><th>í•­ëª©</th><th class="text-end" style="width:120px">ì˜ˆìƒ ê³µì œì•¡</th></tr>
                        </thead>
                        <tbody>
                          <tr><td>êµ­ë¯¼ì—°ê¸ˆ</td><td class="text-end fw-bold" id="create-preview-pen-amt">â‚©0</td></tr>
                          <tr><td>ê±´ê°•ë³´í—˜</td><td class="text-end fw-bold" id="create-preview-hlth-amt">â‚©0</td></tr>
                          <tr><td>ê³ ìš©ë³´í—˜</td><td class="text-end fw-bold" id="create-preview-emp-amt">â‚©0</td></tr>
                          <tr><td>ì†Œë“ì„¸</td><td class="text-end fw-bold" id="create-preview-tax-amt">â‚©0</td></tr>
                          <tr class="table-active">
                            <td class="fw-bold">í•©ê³„</td>
                            <td class="text-end text-primary fw-bold fs-5" id="create-preview-total-amt">â‚©0</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">ë“±ë¡</button>
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- [ìˆ˜ì •] ëª¨ë‹¬ë“¤ -->
    <div th:each="r : ${rules}">
      <div class="modal fade" th:id="${'editModal-' + r.ruleId}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <form th:action="@{'/pay/rule/' + ${r.ruleId}}" method="post" class="needs-validation" novalidate
                  th:id="${'edit-rule-form-' + r.ruleId}">
              <div class="modal-header">
                <h5 class="modal-title">ê¸°ì¤€ ìˆ˜ì • RULE - <span th:text="${r.ruleId}">1</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
              </div>

              <div class="modal-body">
                <div class="row g-4">
                  <div class="col-lg-7">
                    <h6 class="mb-3 text-secondary">ê¸°ë³¸/ìˆ˜ë‹¹ ê¸°ì¤€</h6>

                    <div class="row g-3 mb-4">
                      <div class="col-md-4">
                        <label class="form-label">ì ìš©ì‹œì‘ì¼</label>
                        <input type="date" name="startDate" th:value="${#temporals.format(r.startDate, 'yyyy-MM-dd')}"
                               class="form-control edit-start" required>
                        <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">ì ìš©ì¢…ë£Œì¼</label>
                        <input type="date" name="endDate"
                               th:value="${r.endDate != null ? #temporals.format(r.endDate, 'yyyy-MM-dd') : ''}"
                               class="form-control edit-end">
                        <div class="invalid-feedback">ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">ì§€ê¸‰ì¼</label>
                        <input type="number" name="payDay" th:value="${r.payDay}" class="form-control" min="1" max="31" required>
                        <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                      </div>
                    </div>

                    <div class="row g-3 mb-4">
                      <!-- ê¸ˆì•¡ ì¸í’‹: data-rule-id ë¡œ ì—°ê²° -->
                      <div class="col-md-4">
                        <label class="form-label">ê¸°ë³¸ê¸‰</label>
                        <input type="text" name="baseAmt"
                               th:value="${#numbers.formatDecimal(r.baseAmt,0,'COMMA',0,'POINT')}"
                               class="form-control amount-input edit-amount"
                               th:attr="data-rule-id=${r.ruleId}" required>
                        <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">ì‹ëŒ€</label>
                        <input type="text" name="mealAmt"
                               th:value="${#numbers.formatDecimal(r.mealAmt,0,'COMMA',0,'POINT')}"
                               class="form-control amount-input edit-amount"
                               th:attr="data-rule-id=${r.ruleId}" required>
                        <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">êµí†µë¹„</label>
                        <input type="text" name="transAmt"
                               th:value="${#numbers.formatDecimal(r.transAmt,0,'COMMA',0,'POINT')}"
                               class="form-control amount-input edit-amount"
                               th:attr="data-rule-id=${r.ruleId}" required>
                        <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                      </div>
                    </div>

                    <h6 class="mb-3 text-secondary">ê³µì œ í•­ëª© ê´€ë¦¬</h6>
                    <div class="card card-sm">
                      <div class="card-body p-2">
                        <table class="table table-sm table-borderless align-middle mb-0">
                          <thead class="table-light">
                            <tr><th style="width:120px">í•­ëª©</th><th style="width:110px">ì„¸ìœ¨</th><th style="width:100px">ê¸°ì¤€</th><th>ë²•ì •ê¸°ì¤€</th></tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>êµ­ë¯¼ì—°ê¸ˆ</td>
                              <td><input type="number" name="penRate" th:value="${r.penRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>ê¸‰ì—¬</td><td>êµ­ë¯¼ì—°ê¸ˆë²•</td>
                            </tr>
                            <tr>
                              <td>ê±´ê°•ë³´í—˜</td>
                              <td><input type="number" name="hlthRate" th:value="${r.hlthRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>ê¸‰ì—¬</td><td>êµ­ë¯¼ê±´ê°•ë³´í—˜ë²•</td>
                            </tr>
                            <tr>
                              <td>ê³ ìš©ë³´í—˜</td>
                              <td><input type="number" name="empRate" th:value="${r.empRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>ê¸‰ì—¬</td><td>ê³ ìš©ë³´í—˜ë²•</td>
                            </tr>
                            <tr>
                              <td>ì†Œë“ì„¸</td>
                              <td><input type="number" name="taxRate" th:value="${r.taxRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>ê³¼ì„¸í‘œì¤€</td><td>ì†Œë“ì„¸ë²•(ê°„ì´)</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <h6 class="mb-3 mt-4 text-secondary">ê¸°íƒ€ ì •ë³´</h6>
                    <div class="row g-3">
                      <div class="col-md-4">
                        <label class="form-label">STATUS</label>
                        <select name="status" class="form-select" required>
                          <option value="ACTIVE" th:selected="${r.status.name() == 'ACTIVE'}">ACTIVE</option>
                          <option value="INACTIVE" th:selected="${r.status.name() == 'INACTIVE'}">INACTIVE</option>
                        </select>
                        <div class="invalid-feedback">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                      </div>
                      <div class="col-12">
                        <label class="form-label">REMARK</label>
                        <textarea name="remark" class="form-control" rows="2" th:text="${r.remark}"></textarea>
                      </div>
                    </div>
                  </div>

                  <!-- ìˆ˜ì • ë¯¸ë¦¬ë³´ê¸° -->
                  <div class="col-lg-5">
                    <h6 class="mb-3 text-secondary">ê¸‰ì—¬ ê³µì œ ë¯¸ë¦¬ë³´ê¸°</h6>
                    <div class="card bg-light border-0">
                      <div class="card-body">
                        <p class="mb-3 text-muted">ê¸°ì¤€ ê³µì œì•¡ ì˜ˆìƒ (ì„¸ì „ ê¸‰ì—¬ <b><span class="edit-preview-gross-pay">0</span></b>ì›)</p>
                        <table class="table table-sm mb-0">
                          <thead class="table-light">
                            <tr><th>í•­ëª©</th><th class="text-end" style="width:120px">ì˜ˆìƒ ê³µì œì•¡</th></tr>
                          </thead>
                          <tbody>
                            <tr><td>êµ­ë¯¼ì—°ê¸ˆ</td><td class="text-end fw-bold edit-preview-pen-amt">â‚©0</td></tr>
                            <tr><td>ê±´ê°•ë³´í—˜</td><td class="text-end fw-bold edit-preview-hlth-amt">â‚©0</td></tr>
                            <tr><td>ê³ ìš©ë³´í—˜</td><td class="text-end fw-bold edit-preview-emp-amt">â‚©0</td></tr>
                            <tr><td>ì†Œë“ì„¸</td><td class="text-end fw-bold edit-preview-tax-amt">â‚©0</td></tr>
                            <tr class="table-active">
                              <td class="fw-bold">í•©ê³„</td>
                              <td class="text-end text-primary fw-bold fs-5 edit-preview-total-amt">â‚©0</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
					</div>
					</div>	
                </div><!-- /tab-content -->

  </div><!-- /container -->

              <div class="modal-footer">
                <button class="btn btn-primary" type="submit">ì €ì¥</button>
                <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">ë‹«ê¸°</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    /* ========= ê³µí†µ ìœ í‹¸ ========= */
    function onlyDigits(str){ return (str||'').replace(/[^\d]/g,''); }
    function formatAmountValue(v){ if(v===''||v==null) return ''; return Number(v).toLocaleString('ko-KR'); }
    function parseAmountValue(v){ return Number(onlyDigits(v)); }
    function fmtKRW(n){ if(!isFinite(n)) n=0; return 'â‚©'+Math.round(n).toLocaleString('ko-KR'); }

    function updatePreview(modal){
      if(!modal) return;
      const isCreate = modal.id === 'createModal';

      // ê¸ˆì•¡ê°’(ì½¤ë§ˆ ì œê±° í›„)
      const base = parseAmountValue( (modal.querySelector(isCreate? 'input[name="baseAmt"]' : 'input[name="baseAmt"]')?.value) || '0' );
      const meal = parseAmountValue( (modal.querySelector(isCreate? 'input[name="mealAmt"]' : 'input[name="mealAmt"]')?.value) || '0' );
      const trans = parseAmountValue( (modal.querySelector(isCreate? 'input[name="transAmt"]' : 'input[name="transAmt"]')?.value) || '0' );
      const gross = base + meal + trans;

      // ì„¸ìœ¨
      const pen  = Number(modal.querySelector(isCreate? '#create-rule-form input[name="penRate"]' : 'input[name="penRate"]')?.value || 0);
      const hlth = Number(modal.querySelector(isCreate? '#create-rule-form input[name="hlthRate"]' : 'input[name="hlthRate"]')?.value || 0);
      const emp  = Number(modal.querySelector(isCreate? '#create-rule-form input[name="empRate"]' : 'input[name="empRate"]')?.value || 0);
      const tax  = Number(modal.querySelector(isCreate? '#create-rule-form input[name="taxRate"]' : 'input[name="taxRate"]')?.value || 0);

      const penAmt  = gross * pen;
      const hlthAmt = gross * hlth;
      const empAmt  = gross * emp;
      const taxAmt  = gross * tax;
      const total   = penAmt + hlthAmt + empAmt + taxAmt;

      if(isCreate){
        modal.querySelector('#create-preview-gross-pay').textContent = gross.toLocaleString('ko-KR');
        modal.querySelector('#create-preview-pen-amt').textContent   = fmtKRW(penAmt);
        modal.querySelector('#create-preview-hlth-amt').textContent  = fmtKRW(hlthAmt);
        modal.querySelector('#create-preview-emp-amt').textContent   = fmtKRW(empAmt);
        modal.querySelector('#create-preview-tax-amt').textContent   = fmtKRW(taxAmt);
        modal.querySelector('#create-preview-total-amt').textContent = fmtKRW(total);
      }else{
        modal.querySelector('.edit-preview-gross-pay').textContent = gross.toLocaleString('ko-KR');
        modal.querySelector('.edit-preview-pen-amt').textContent   = fmtKRW(penAmt);
        modal.querySelector('.edit-preview-hlth-amt').textContent  = fmtKRW(hlthAmt);
        modal.querySelector('.edit-preview-emp-amt').textContent   = fmtKRW(empAmt);
        modal.querySelector('.edit-preview-tax-amt').textContent   = fmtKRW(taxAmt);
        modal.querySelector('.edit-preview-total-amt').textContent = fmtKRW(total);
      }
    }

    function clampEndAfterStart(startEl, endEl){
      if(!startEl || !endEl) return;
      if(startEl.value){
        endEl.min = startEl.value;
        if(endEl.value && endEl.value < startEl.value){ endEl.value = startEl.value; }
      }else{
        endEl.removeAttribute('min');
      }
    }

    // ì œì¶œ ì§ì „ ì½¤ë§ˆ ì œê±°
    function sanitizeAmountInputs(form){
      form.querySelectorAll('.amount-input').forEach(inp=>{
        inp.dataset._formatted = inp.value;         // ë³µêµ¬ìš© ì €ì¥
        inp.value = onlyDigits(inp.value);          // ì½¤ë§ˆ ì œê±°
      });
    }
    // ê²€ì¦ ì‹¤íŒ¨ì‹œ ì½¤ë§ˆ ë³µì›
    function restoreAmountInputs(form){
      form.querySelectorAll('.amount-input').forEach(inp=>{
        if(inp.dataset._formatted){ inp.value = inp.dataset._formatted; delete inp.dataset._formatted; }
      });
    }

    /* ========= ë“±ë¡ ëª¨ë‹¬ ë°”ì¸ë”© ========= */
    const createModal = document.getElementById('createModal');
    const createForm  = document.getElementById('create-rule-form');

    if(createModal){
      createModal.addEventListener('shown.bs.modal', ()=>{
        // ê¸ˆì•¡ í¬ë§·
        createModal.querySelectorAll('.amount-input').forEach(inp=>{
          if(inp.value){ inp.value = formatAmountValue(parseAmountValue(inp.value)); }
        });
        clampEndAfterStart(document.getElementById('create-start'), document.getElementById('create-end'));
        updatePreview(createModal);
      });

      createModal.addEventListener('hidden.bs.modal', ()=>{
        createForm.reset();
        createForm.classList.remove('was-validated');
        const end = document.getElementById('create-end');
        if(end){ end.setCustomValidity(''); end.removeAttribute('min'); }
      });

      // ê¸ˆì•¡/ì„¸ìœ¨ ì…ë ¥ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸°
      createModal.addEventListener('input', (e)=>{
        if(e.target.matches('.amount-input')){
          e.target.value = formatAmountValue(parseAmountValue(e.target.value));
        }
        if(e.target.matches('.amount-input, .rate-input')) updatePreview(createModal);
        if(e.target.id==='create-start' || e.target.id==='create-end'){
          clampEndAfterStart(document.getElementById('create-start'), document.getElementById('create-end'));
        }
      });

      // ì œì¶œ
      createForm.addEventListener('submit', (e)=>{
        sanitizeAmountInputs(createForm);
        if(!createForm.checkValidity()){
          e.preventDefault(); e.stopPropagation();
          createForm.classList.add('was-validated');
          restoreAmountInputs(createForm);
          return;
        }
        const s = document.getElementById('create-start');
        const d = document.getElementById('create-end');
        if(s.value && d.value && d.value < s.value){
          e.preventDefault(); e.stopPropagation();
          d.setCustomValidity('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤');
          d.classList.add('is-invalid');
          createForm.classList.add('was-validated');
          restoreAmountInputs(createForm);
          return;
        }else{
          d.setCustomValidity('');
          d.classList.remove('is-invalid');
        }
      });
    }

    /* ========= ìˆ˜ì • ëª¨ë‹¬ ë°”ì¸ë”©(ê³µí†µ) ========= */
    document.addEventListener('shown.bs.modal', (evt)=>{
      const modal = evt.target;
      if(!modal.classList.contains('modal')) return;
      if(modal.dataset.bound === '1') { updatePreview(modal); return; } // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€

      // ì´ˆê¸° í¬ë§·/ë™ê¸°í™”
      modal.querySelectorAll('.amount-input').forEach(inp=>{
        if(inp.value){ inp.value = formatAmountValue(parseAmountValue(inp.value)); }
      });
      const s = modal.querySelector('.edit-start');
      const d = modal.querySelector('.edit-end');
      clampEndAfterStart(s, d);
      updatePreview(modal);

      // ì…ë ¥ ì´ë²¤íŠ¸
      modal.addEventListener('input', (e)=>{
        if(e.target.matches('.amount-input')){
          e.target.value = formatAmountValue(parseAmountValue(e.target.value));
        }
        if(e.target.matches('.amount-input, .rate-input')) updatePreview(modal);
        if(e.target.classList.contains('edit-start') || e.target.classList.contains('edit-end')){
          clampEndAfterStart(s, d);
        }
      });

      // ì œì¶œ ì²˜ë¦¬
      const form = modal.querySelector('form.needs-validation');
      form?.addEventListener('submit', (e)=>{
        sanitizeAmountInputs(form);
        if(!form.checkValidity()){
          e.preventDefault(); e.stopPropagation();
          form.classList.add('was-validated');
          restoreAmountInputs(form);
          return;
        }
        if(s && d && s.value && d.value && d.value < s.value){
          e.preventDefault(); e.stopPropagation();
          d.setCustomValidity('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤');
          d.classList.add('is-invalid');
          form.classList.add('was-validated');
          restoreAmountInputs(form);
          return;
        }else{
          d?.setCustomValidity('');
          d?.classList.remove('is-invalid');
        }
      });

      modal.dataset.bound = '1';
    });

    /* ========= ì‚­ì œ ë²„íŠ¼(í™•ì¸ í›„ ì´ë™) ========= */
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-delete-rule');
      if(!btn) return;
      const id = btn.dataset.ruleId;
      if(confirm(`ê¸°ì¤€ ID ${id} ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
        location.href = btn.dataset.href;
      }
    });
    
    
 // í™œì„± íƒ­ì„ localStorageì— ì €ì¥/ë³µì›
    (function(){
      const key = 'payTabs.active';
      const tabsEl = document.getElementById('payTabs');
      if(!tabsEl) return;

      // ë³µì›
      const saved = localStorage.getItem(key);
      if(saved){
        const trigger = document.querySelector(`[data-bs-target="${saved}"]`);
        if(trigger){
          const tab = new bootstrap.Tab(trigger);
          tab.show();
        }
      }
      // ì €ì¥
      tabsEl.addEventListener('shown.bs.tab', function(e){
        const target = e.target?.getAttribute('data-bs-target');
        if(target){ localStorage.setItem(key, target); }
      });
    })();
  </script>

</th:block>
</th:block>
