<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{layouts/layout}">

<th:block layout:fragment="content">

  <style>
    .rule-item-card{border-radius:14px}
    .nowrap{white-space:nowrap}
    .amount{font-variant-numeric:tabular-nums}
    .muted{color:#6b7280}

    /* ===================== 탭 커스텀 ===================== */
    .pay-tabs {
      border-bottom: 2px solid #e5e7eb; /* 라인 */
      margin-bottom: 1.5rem;
    }
    .pay-tabs .nav-link {
      position: relative;
      color: #6b7280;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px 8px 0 0;
      transition: all 0.25s ease;
    }
    .pay-tabs .nav-link:hover {
      color: #0d6efd;
      background: #f1f5ff;
    }
    .pay-tabs .nav-link.active {
      color: #0d6efd;
      background: #ffffff;
      box-shadow: 0 -2px 8px rgba(13,110,253,0.1);
    }
    .pay-tabs .nav-link.active::after {
      content: '';
      position: absolute;
      left: 0; right: 0; bottom: -2px;
      height: 3px;
      background: #0d6efd;
      border-radius: 2px;
      animation: underlineIn 0.3s ease forwards;
    }
    @keyframes underlineIn {
      from {width: 0; margin-left: 50%;}
      to {width: 100%; margin-left: 0;}
    }
  </style>
  <div class="container-xxl py-4">
  <!-- ===================== 상단 탭 ===================== -->
<ul class="nav pay-tabs">
  <li class="nav-item"><a class="nav-link" th:href="@{/pay/rule}"      th:classappend="${activeTab}=='rule' ? 'active'">급여기준정보</a></li>
  <li class="nav-item"><a class="nav-link" th:href="@{/pay/rule_calc}" th:classappend="${activeTab}=='calc' ? 'active'">급여계산</a></li>
  <li class="nav-item"><a class="nav-link" th:href="@{/pay/rule_item}" th:classappend="${activeTab}=='item' ? 'active'">급여항목</a></li>
</ul>
  
   <!-- 메 세 지 -->
<div th:if="${msg}" class="alert alert-success alert-dismissible fade show" role="alert">
  <span th:text="${msg}">성공 메시지</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div th:if="${err}" class="alert alert-danger alert-dismissible fade show" role="alert">
  <span th:text="${err}">에러 메시지</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
 
 
 <div th:if="${activeTab}=='rule'">
    <!-- 헤더 -->    
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="fw-bold text-primary mb-0">급여 기준정보</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">등 록</button>
    </div>

    <!-- 카드형 목록 -->
   <div>
    <h5 class="card-title mb-3">급여 기준 목록</h5>

    <div class="text-muted" th:if="${#lists.isEmpty(rules)}">등록된 급여 기준이 없습니다.</div>

    <div th:each="r : ${rules}"
         class="card mb-3 border-0 shadow-sm rule-item-card"
         th:attr="data-rule-id=${r.ruleId}">
      <div class="card-body p-3">

        <div class="d-flex justify-content-between align-items-center pb-2 border-bottom">
          <div class="d-flex align-items-center">
            <h6 class="mb-0 me-3 fw-bold text-dark">
              기준 ID: <span class="text-primary" th:text="${r.ruleId}"></span>
            </h6>
            <span class="text-muted small">
              (<span th:text="${#temporals.format(r.startDate, 'yyyy.MM.dd')}"></span> ~
               <span th:text="${r.endDate != null ? #temporals.format(r.endDate, 'yyyy.MM.dd') : '무기한'}"></span>)
            </span>
          </div>

          <div class="d-flex align-items-center">
            <span class="badge me-3" th:classappend="${r.status.name()=='ACTIVE'} ? 'bg-success' : 'bg-secondary'"
                  th:text="${r.status}"></span>

            <button class="btn btn-sm btn-outline-primary me-2"
                    data-bs-toggle="modal"
                    th:attr="data-bs-target=${'#editModal-' + r.ruleId}">
              수정
            </button>

            <button class="btn btn-sm btn-outline-danger btn-delete-rule"
                    th:attr="data-href=@{'/pay/rule/delete/' + ${r.ruleId}}, data-rule-id=${r.ruleId}">
              삭제
            </button>
          </div>
        </div>

        <div class="row g-3 pt-3">
          <div class="col-lg-5 col-md-6 border-end">
            <span class="d-block fw-semibold text-secondary mb-2">💰 지급 정보</span>

            <div class="d-flex justify-content-between small mb-1">
              <span class="text-muted">기본급:</span>
              <span class="fw-medium amount">
                <span th:text="${#numbers.formatDecimal(r.baseAmt, 0, 'COMMA', 0, 'POINT')}"></span>원
              </span>
            </div>
            <div class="d-flex justify-content-between small mb-1">
              <span class="text-muted">식대:</span>
              <span class="fw-medium amount">
                <span th:text="${#numbers.formatDecimal(r.mealAmt, 0, 'COMMA', 0, 'POINT')}"></span>원
              </span>
            </div>
            <div class="d-flex justify-content-between small mb-1">
              <span class="text-muted">교통비:</span>
              <span class="fw-medium amount">
                <span th:text="${#numbers.formatDecimal(r.transAmt, 0, 'COMMA', 0, 'POINT')}"></span>원
              </span>
            </div>
            <div class="d-flex justify-content-between small mt-2 pt-2 border-top">
              <span class="text-muted fw-semibold nowrap">지급일:</span>
              <span class="fw-bold text-primary" th:text="${r.payDay} + '일'"></span>
            </div>
          </div>

          <div class="col-lg-7 col-md-6">
            <span class="d-block fw-semibold text-secondary mb-2">📉 공제율 기준</span>

            <div class="row row-cols-2 g-2">
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">국민연금율:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.penRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">건강보험율:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.hlthRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">고용보험율:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.empRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
              <div class="col">
                <div class="d-flex justify-content-between small p-1">
                  <span class="text-muted">소득세율:</span>
                  <span class="fw-medium" th:text="${#numbers.formatDecimal(r.taxRate*100,1,'POINT',2,'POINT')} + '%'"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-end pt-3 mt-3 border-top">
          <div class="small text-secondary flex-grow-1 me-4">
            <span class="fw-semibold me-1">비고:</span>
            <span th:text="${r.remark ?: '-'}"></span>
          </div>
          <div class="text-end small text-muted flex-shrink-0">
            <span class="d-block">생성:
              <span th:text="${#temporals.format(r.createdDate, 'yy.MM.dd HH:mm')}"></span>
            </span>
            <span class="d-block">수정:
              <span th:text="${r.updatedDate != null ? #temporals.format(r.updatedDate, 'yy.MM.dd HH:mm') : '-'}"></span>
            </span>
          </div>
        </div>

      </div>
    </div>
</div>

    <!-- [등록] 모달 -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <form th:action="@{/pay/rule}" th:object="${newRule}" method="post" class="needs-validation" id="create-rule-form" novalidate>
            <div class="modal-header">
              <h5 class="modal-title">급여 기준 등록</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>

            <div class="modal-body">
              <div class="row g-4">
                <div class="col-lg-7">
                  <h6 class="mb-3 text-secondary">기본/수당 기준</h6>

                  <div class="row g-3 mb-4">
                    <div class="col-md-4">
                      <label class="form-label">적용 시작일</label>
                      <input type="date" th:field="*{startDate}" class="form-control" id="create-start" required>
                      <div class="invalid-feedback">값을 입력하세요</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">적용 종료일</label>
                      <input type="date" th:field="*{endDate}" class="form-control" id="create-end">
                      <div class="form-text">무기한이면 비워두세요</div>
                      <div class="invalid-feedback">종료일은 시작일 이후여야 합니다</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">지급일</label>
                      <input type="number" th:field="*{payDay}" class="form-control" min="1" max="31" placeholder="예: 25" required>
                      <div class="invalid-feedback">값을 입력하세요</div>
                    </div>
                  </div>

                  <div class="row g-3 mb-4">
                    <div class="col-md-4">
                      <label class="form-label">기본급</label>
                      <input type="text" class="form-control amount-input" th:field="*{baseAmt}" inputmode="numeric" required>
                      <div class="invalid-feedback">값을 입력하세요</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">식대</label>
                      <input type="text" class="form-control amount-input" th:field="*{mealAmt}" inputmode="numeric" required>
                      <div class="invalid-feedback">값을 입력하세요</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">교통비</label>
                      <input type="text" class="form-control amount-input" th:field="*{transAmt}" inputmode="numeric" required>
                      <div class="invalid-feedback">값을 입력하세요</div>
                    </div>
                  </div>

                  <h6 class="mb-3 text-secondary">공제 항목 관리</h6>
                  <div class="card card-sm">
                    <div class="card-body p-2">
                      <table class="table table-sm table-borderless align-middle mb-0">
                        <thead class="table-light">
                          <tr><th style="width:120px">항목</th><th style="width:110px">세율</th><th style="width:100px">기준</th><th>법정기준</th></tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>국민연금</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{penRate}" step="0.0001" min="0" max="1" placeholder="0.045" required></td>
                            <td>급여</td><td>국민연금법</td>
                          </tr>
                          <tr>
                            <td>건강보험</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{hlthRate}" step="0.0001" min="0" max="1" placeholder="0.03545" required></td>
                            <td>급여</td><td>국민건강보험법</td>
                          </tr>
                          <tr>
                            <td>고용보험</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{empRate}" step="0.0001" min="0" max="1" placeholder="0.009" required></td>
                            <td>급여</td><td>고용보험법</td>
                          </tr>
                          <tr>
                            <td>소득세</td>
                            <td><input type="number" class="form-control form-control-sm rate-input" th:field="*{taxRate}" step="0.0001" min="0" max="1" placeholder="0.06" required></td>
                            <td>과세표준</td><td>소득세법(간이)</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <h6 class="mb-3 mt-4 text-secondary">기타 정보</h6>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">STATUS</label>
                      <select class="form-select" th:field="*{status}" required>
                        <option value="">-- 선택 --</option>
                        <option value="ACTIVE">ACTIVE</option>
                        <option value="INACTIVE">INACTIVE</option>
                      </select>
                      <div class="invalid-feedback">값을 입력하세요</div>
                    </div>
                    <div class="col-12">
                      <label class="form-label">REMARK</label>
                      <textarea class="form-control" th:field="*{remark}" rows="2" placeholder="메모..."></textarea>
                    </div>
                  </div>
                </div>

                <!-- 등록 미리보기 -->
                <div class="col-lg-5">
                  <h6 class="mb-3 text-secondary">급여 공제 미리보기</h6>
                  <div class="card bg-light border-0">
                    <div class="card-body">
                      <p class="mb-3 text-muted">기준 공제액 예상 (세전 급여 <b><span id="create-preview-gross-pay">0</span></b>원)</p>
                      <table class="table table-sm mb-0">
                        <thead class="table-light">
                          <tr><th>항목</th><th class="text-end" style="width:120px">예상 공제액</th></tr>
                        </thead>
                        <tbody>
                          <tr><td>국민연금</td><td class="text-end fw-bold" id="create-preview-pen-amt">₩0</td></tr>
                          <tr><td>건강보험</td><td class="text-end fw-bold" id="create-preview-hlth-amt">₩0</td></tr>
                          <tr><td>고용보험</td><td class="text-end fw-bold" id="create-preview-emp-amt">₩0</td></tr>
                          <tr><td>소득세</td><td class="text-end fw-bold" id="create-preview-tax-amt">₩0</td></tr>
                          <tr class="table-active">
                            <td class="fw-bold">합계</td>
                            <td class="text-end text-primary fw-bold fs-5" id="create-preview-total-amt">₩0</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">등록</button>
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- [수정] 모달들 -->
    <div th:each="r : ${rules}">
      <div class="modal fade" th:id="${'editModal-' + r.ruleId}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <form th:action="@{'/pay/rule/' + ${r.ruleId}}" method="post" class="needs-validation" novalidate
                  th:id="${'edit-rule-form-' + r.ruleId}">
              <div class="modal-header">
                <h5 class="modal-title">기준 수정 RULE - <span th:text="${r.ruleId}">1</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
              </div>

              <div class="modal-body">
                <div class="row g-4">
                  <div class="col-lg-7">
                    <h6 class="mb-3 text-secondary">기본/수당 기준</h6>

                    <div class="row g-3 mb-4">
                      <div class="col-md-4">
                        <label class="form-label">적용시작일</label>
                        <input type="date" name="startDate" th:value="${#temporals.format(r.startDate, 'yyyy-MM-dd')}"
                               class="form-control edit-start" required>
                        <div class="invalid-feedback">값을 입력하세요</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">적용종료일</label>
                        <input type="date" name="endDate"
                               th:value="${r.endDate != null ? #temporals.format(r.endDate, 'yyyy-MM-dd') : ''}"
                               class="form-control edit-end">
                        <div class="invalid-feedback">종료일은 시작일 이후여야 합니다</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">지급일</label>
                        <input type="number" name="payDay" th:value="${r.payDay}" class="form-control" min="1" max="31" required>
                        <div class="invalid-feedback">값을 입력하세요</div>
                      </div>
                    </div>

                    <div class="row g-3 mb-4">
                      <!-- 금액 인풋: data-rule-id 로 연결 -->
                      <div class="col-md-4">
                        <label class="form-label">기본급</label>
                        <input type="text" name="baseAmt"
                               th:value="${#numbers.formatDecimal(r.baseAmt,0,'COMMA',0,'POINT')}"
                               class="form-control amount-input edit-amount"
                               th:attr="data-rule-id=${r.ruleId}" required>
                        <div class="invalid-feedback">값을 입력하세요</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">식대</label>
                        <input type="text" name="mealAmt"
                               th:value="${#numbers.formatDecimal(r.mealAmt,0,'COMMA',0,'POINT')}"
                               class="form-control amount-input edit-amount"
                               th:attr="data-rule-id=${r.ruleId}" required>
                        <div class="invalid-feedback">값을 입력하세요</div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">교통비</label>
                        <input type="text" name="transAmt"
                               th:value="${#numbers.formatDecimal(r.transAmt,0,'COMMA',0,'POINT')}"
                               class="form-control amount-input edit-amount"
                               th:attr="data-rule-id=${r.ruleId}" required>
                        <div class="invalid-feedback">값을 입력하세요</div>
                      </div>
                    </div>

                    <h6 class="mb-3 text-secondary">공제 항목 관리</h6>
                    <div class="card card-sm">
                      <div class="card-body p-2">
                        <table class="table table-sm table-borderless align-middle mb-0">
                          <thead class="table-light">
                            <tr><th style="width:120px">항목</th><th style="width:110px">세율</th><th style="width:100px">기준</th><th>법정기준</th></tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td>국민연금</td>
                              <td><input type="number" name="penRate" th:value="${r.penRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>급여</td><td>국민연금법</td>
                            </tr>
                            <tr>
                              <td>건강보험</td>
                              <td><input type="number" name="hlthRate" th:value="${r.hlthRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>급여</td><td>국민건강보험법</td>
                            </tr>
                            <tr>
                              <td>고용보험</td>
                              <td><input type="number" name="empRate" th:value="${r.empRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>급여</td><td>고용보험법</td>
                            </tr>
                            <tr>
                              <td>소득세</td>
                              <td><input type="number" name="taxRate" th:value="${r.taxRate}"
                                         class="form-control form-control-sm rate-input" step="0.0001" min="0" max="1" required></td>
                              <td>과세표준</td><td>소득세법(간이)</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <h6 class="mb-3 mt-4 text-secondary">기타 정보</h6>
                    <div class="row g-3">
                      <div class="col-md-4">
                        <label class="form-label">STATUS</label>
                        <select name="status" class="form-select" required>
                          <option value="ACTIVE" th:selected="${r.status.name() == 'ACTIVE'}">ACTIVE</option>
                          <option value="INACTIVE" th:selected="${r.status.name() == 'INACTIVE'}">INACTIVE</option>
                        </select>
                        <div class="invalid-feedback">값을 입력하세요</div>
                      </div>
                      <div class="col-12">
                        <label class="form-label">REMARK</label>
                        <textarea name="remark" class="form-control" rows="2" th:text="${r.remark}"></textarea>
                      </div>
                    </div>
                  </div>

                  <!-- 수정 미리보기 -->
                  <div class="col-lg-5">
                    <h6 class="mb-3 text-secondary">급여 공제 미리보기</h6>
                    <div class="card bg-light border-0">
                      <div class="card-body">
                        <p class="mb-3 text-muted">기준 공제액 예상 (세전 급여 <b><span class="edit-preview-gross-pay">0</span></b>원)</p>
                        <table class="table table-sm mb-0">
                          <thead class="table-light">
                            <tr><th>항목</th><th class="text-end" style="width:120px">예상 공제액</th></tr>
                          </thead>
                          <tbody>
                            <tr><td>국민연금</td><td class="text-end fw-bold edit-preview-pen-amt">₩0</td></tr>
                            <tr><td>건강보험</td><td class="text-end fw-bold edit-preview-hlth-amt">₩0</td></tr>
                            <tr><td>고용보험</td><td class="text-end fw-bold edit-preview-emp-amt">₩0</td></tr>
                            <tr><td>소득세</td><td class="text-end fw-bold edit-preview-tax-amt">₩0</td></tr>
                            <tr class="table-active">
                              <td class="fw-bold">합계</td>
                              <td class="text-end text-primary fw-bold fs-5 edit-preview-total-amt">₩0</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
					</div>
					</div>	
            

              <div class="modal-footer">
                <button class="btn btn-primary" type="submit">저장</button>
                <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">닫기</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>


      </div><!-- /tab-content -->

  </div><!-- /container -->
<!-- JS 파일 분리 -->
  <script src="/js/pay/pay_rule.js"></script>
  
</th:block>
</th:block>
