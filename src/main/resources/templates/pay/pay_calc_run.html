<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê¸‰ì—¬ ì´ë ¥ ì¡°íšŒ</title>

    <!-- AG Grid -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>

    <style>
        .tab-button { padding: 10px 15px; border: 1px solid #ccc; cursor: pointer; margin-right: 5px; }
        .tab-button.active { background-color: #0d6efd; color: white; }
        .search-box { border:1px solid #ddd; padding:15px; margin-top:15px; border-radius:8px; }
        #payslipGrid { height: 450px; width: 100%; margin-top: 20px; }
    </style>
</head>

<body>

<h1>ğŸ’° ê¸‰ì—¬ ì´ë ¥ ì¡°íšŒ</h1>

<!-- ===================== íƒ­ ë²„íŠ¼ ===================== -->
<div>
    <button class="tab-button" data-mode="emp">ì‚¬ì› ê¸°ì¤€ ì¡°íšŒ</button>
    <button class="tab-button" data-mode="dept">ë¶€ì„œ ê¸°ì¤€ ì¡°íšŒ</button>
    <button class="tab-button" data-mode="month">ì›”ë³„ í†µí•© ì¡°íšŒ</button>
</div>


<!-- ===================================================== -->
<!-- ğŸ”¥ ì˜¤ì§ 1ê°œì˜ FORM ë§Œ ì‚¬ìš©í•œë‹¤ -->
<!-- mode ì— ë”°ë¼ ë‚´ë¶€ input ë§Œ ë³€ê²½ëœë‹¤ -->
<!-- ===================================================== -->

<form method="get" action="/pay/history" id="searchForm">

    <input type="hidden" name="mode" id="modeInput">

    <div id="searchArea" class="search-box">
        <!-- ì—¬ê¸°ì— JSê°€ ì•Œë§ì€ ê²€ìƒ‰í¼ì„ ê·¸ë ¤ë„£ëŠ”ë‹¤ -->
    </div>

    <button type="submit">ê²€ìƒ‰</button>
</form>


<!-- ===================================================== -->
<!-- ===================== AG GRID ======================= -->
<!-- ===================================================== -->

<div id="payslipGrid" class="ag-theme-alpine"></div>

<script th:inline="javascript">
/*<![CDATA[*/

    /* ==========================
       ì´ˆê¸° ê°’
    ===========================*/
    const currentMode = /*[[${mode}]]*/ "emp";
    const slips = /*[[${slips}]]*/ [];

    /* ============================
       ëª¨ë“œë³„ ê²€ìƒ‰í¼ í…œí”Œë¦¿
    ============================*/
    const templates = {

        emp: `
            <label>ì‚¬ë²ˆ/ì‚¬ì›ëª…</label>
            <input type="text" name="keyword" value="${"[[${param.keyword}]]"}">

            <label>ì—°ë„</label>
            <select name="year">
                <option value="">ì „ì²´</option>
                <option value="2025" ${"[[${param.year}]]"==="2025"?"selected":""}>2025</option>
                <option value="2024" ${"[[${param.year}]]"==="2024"?"selected":""}>2024</option>
            </select>

            <label>ì›”</label>
            <select name="month">
                <option value="">ì „ì²´</option>
                ${[...Array(12).keys()].map(i=>{
                    const m = String(i+1).padStart(2,'0');
                    return `<option value="${m}" ${"[[${param.month}]]"===m?"selected":""}>${i+1}ì›”</option>`;
                }).join("")}
            </select>
        `,

        dept: `
            <label>ë¶€ì„œëª…</label>
            <input type="text" name="deptName" value="${"[[${param.deptName}]]"}">

            <label>ì—°ë„</label>
            <select name="year">
                <option value="">ì „ì²´</option>
                <option value="2025" ${"[[${param.year}]]"==="2025"?"selected":""}>2025</option>
                <option value="2024" ${"[[${param.year}]]"==="2024"?"selected":""}>2024</option>
            </select>

            <label>ì›”</label>
            <select name="month">
                <option value="">ì „ì²´</option>
                ${[...Array(12).keys()].map(i=>{
                    const m = String(i+1).padStart(2,'0');
                    return `<option value="${m}" ${"[[${param.month}]]"===m?"selected":""}>${i+1}ì›”</option>`;
                }).join("")}
            </select>
        `,

        month: `
            <label>ì—°ë„</label>
            <select name="year">
                <option value="">ì „ì²´</option>
                <option value="2025" ${"[[${param.year}]]"==="2025"?"selected":""}>2025</option>
                <option value="2024" ${"[[${param.year}]]"==="2024"?"selected":""}>2024</option>
            </select>

            <label>ì›”</label>
            <select name="month">
                ${[...Array(12).keys()].map(i=>{
                    const m = String(i+1).padStart(2,'0');
                    return `<option value="${m}" ${"[[${param.month}]]"===m?"selected":""}>${i+1}ì›”</option>`;
                }).join("")}
            </select>
        `,
    };


    /* ============================
       íƒ­ í´ë¦­ ì‹œ í¼ ë³€ê²½
    ============================*/
    function switchMode(mode) {
        document.querySelectorAll('.tab-button')
            .forEach(btn => btn.classList.remove("active"));

        document.querySelector(`[data-mode="${mode}"]`)
            .classList.add("active");

        document.getElementById("modeInput").value = mode;
        document.getElementById("searchArea").innerHTML = templates[mode];
    }


    /* ============================
       í˜ì´ì§€ ë¡œë”©ì‹œ ëª¨ë“œ ì ìš©
    ============================*/
    switchMode(currentMode);


    /* ============================
       AG GRID ë Œë”ë§
    ============================*/

    function numberFormat(v){
        if (!v) return "";
        return v.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");
    }

    const columnDefs = [
        { headerName:'ì‚¬ë²ˆ', field:'empId', width:120 },
        { headerName:'ì‚¬ì›ëª…', field:'empName', width:150 },
        { headerName:'ë¶€ì„œëª…', field:'deptName', width:150 },
        { headerName:'ì§€ê¸‰ì›”', field:'payYymm', width:130 },

        { headerName:'ê¸°ë³¸ê¸‰', field:'baseAmt', valueFormatter:p=>numberFormat(p.value), width:130 },
        { headerName:'ìˆ˜ë‹¹í•©ê³„', field:'alwAmt', valueFormatter:p=>numberFormat(p.value), width:130 },
        { headerName:'ì´ì§€ê¸‰ì•¡', field:'totAmt', valueFormatter:p=>numberFormat(p.value), width:130 },
        { headerName:'ê³µì œì•¡', field:'dedAmt', valueFormatter:p=>numberFormat(p.value), width:130 },
        { headerName:'ì‹¤ìˆ˜ë ¹ì•¡', field:'netAmt', valueFormatter:p=>numberFormat(p.value), width:150 },

        {
            headerName:'ìƒíƒœ', field:'calcStatus', width:120,
            cellRenderer: p => {
                if(p.value==='CONFIRMED') return '<span style="color:green;font-weight:700">í™•ì •</span>';
                if(p.value==='CALCULATED') return '<span style="color:blue;font-weight:700">ê³„ì‚°ì™„ë£Œ</span>';
                return '<span style="color:gray">ë¯¸ê³„ì‚°</span>';
            }
        }
    ];

    new agGrid.Grid(
        document.getElementById("payslipGrid"),
        {
            columnDefs,
            rowData: slips,
            pagination: true,
            paginationPageSize: 20,
            defaultColDef: { sortable:true, filter:true, resizable:true }
        }
    );

/*]]>*/
</script>

</body>
</html>
