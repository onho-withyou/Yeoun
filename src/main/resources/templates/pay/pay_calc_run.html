<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{/layouts/layout.html}">

          

  <th:block layout:fragment="content">

    <div class="container-xxl py-4">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-primary fw-bold">ê¸‰ì—¬ ê³„ì‚° ë° í™•ì •</h1>
      </div>

      <!-- 1. ê¸‰ì—¬ ê³„ì‚° ë° ì‹œë®¬ë ˆì´ì…˜ -->
      <section class="card shadow-sm mb-4">
        <div class="card-body">
          <h3 class="h5 mb-3 border-start ps-2">ê¸‰ì—¬ ê³„ì‚° ë° ì‹œë®¬ë ˆì´ì…˜</h3>
          

          <!-- ì¡°ê±´ ì„ íƒ -->
          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <label for="calc_month" class="col-form-label fw-semibold">ê³„ì‚° ëŒ€ìƒ ì›”</label>
            </div>
            <div class="col-auto">
              <select id="calc_month" class="form-select form-select-sm">
                <option th:each="m : ${months}"
                        th:value="${m}"
                        th:selected="${m==yyyymm}"
                        th:text="${#strings.substring(m,0,4)} + 'ë…„ ' + ${#strings.substring(m,4,6)} + 'ì›”'">
                </option>
                <option th:if="${months == null}" th:value="${yyyymm}" th:text="${yyyymm}">ì„ íƒì›”</option>
              </select>
            </div>

<!--             <div class="col-auto"> -->
<!--               <label class="col-form-label fw-semibold">ê³„ì‚° ìœ í˜•</label> -->
<!--             </div> -->
<!--             <div class="col-auto"> -->
<!--               <select id="calc_type" class="form-select form-select-sm"> -->
<!--                 <option value="all">ì¼ê´„ ê³„ì‚° (ì „ ì‚¬ì›)</option> -->
<!--                 <option value="individual" disabled>ê°œë³„ ê³„ì‚° (ì¤€ë¹„ì¤‘)</option> -->
<!--                 <option value="mid_join_leave" disabled>ì¤‘ë„ ì…/í‡´ì‚¬ì ì¼í•  ì •ì‚° (ì¤€ë¹„ì¤‘)</option> -->
<!--               </select> -->
<!--             </div> -->
          </div>

          <!-- ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="d-flex flex-wrap gap-2 mb-3">
          <form th:action="@{/pay/calc/simulate}" method="post" class="d-inline">
			  <input type="hidden" name="yyyymm" id="calcMonth" th:value="${yyyymm}">
			  <input type="hidden" name="calcType" id="calcType" value="ALL"> <!-- ê¸°ë³¸ê°’: ì „ì‚¬ì› -->
			  <input type="hidden" name="overwrite" value="true">
			
			  <button type="submit" class="btn btn-warning">
			    ê³„ì‚° ì‹œë®¬ë ˆì´ì…˜ (ê°€ê³„ì‚°)
			  </button>
			</form>

            <form th:action="@{/pay/calc/confirm}" method="post" class="d-inline">
			  <input type="hidden" name="yyyymm" id="calcMonthConfirm" th:value="${yyyymm}">
			  <input type="hidden" name="calcType" id="calcTypeConfirm" value="ALL">
			  <input type="hidden" name="overwrite" value="true">
			
			  <button type="submit" class="btn btn-success">
			    ê³„ì‚° ê²°ê³¼ í™•ì •
			  </button>
</form>
          </div>

          <!-- ê²°ê³¼ ìƒíƒœ -->
          <div id="statusBox"
               class="alert d-flex justify-content-between align-items-center"
               th:classappend="${status.calculated} ? ' alert-success' : ' alert-warning'">
            <div>
              ì„ íƒ ì›”(<span id="statMonth" th:text="${yyyymm}">YYYYMM</span>) ê³„ì‚° ìƒíƒœ:
             <strong id="statCalc"
					  th:switch="${status.calcStatus}">
					  <span th:case="'CONFIRMED'">í™•ì • ì™„ë£Œ</span>
					  <span th:case="'CALCULATED'">ê³„ì‚° ì™„ë£Œ</span>
					  <span th:case="'SIMULATED'">ê°€ê³„ì‚°</span>
					  <span th:case="*">ë¯¸ê³„ì‚°</span>
					</strong>
					             

              <span class="ms-2 badge bg-secondary" id="statCount" th:text="|ê±´ìˆ˜ ${status.count}|">ê±´ìˆ˜ 0</span>
            </div>
            <div>
              ì´ì§€ê¸‰:
              <span class="text-primary fw-bold ms-1" id="statTot"
                    th:text="${#numbers.formatInteger(status.totalAmt,0)}">0</span> ì› 
              Â· ê³µì œ:
              <span class="text-danger fw-bold ms-1" id="statDed"
                    th:text="${#numbers.formatInteger(status.dedAmt,0)}">0</span> ì›
              Â· ì‹¤ìˆ˜ë ¹:
              <span class="fw-bold ms-1" id="statNet"
                    th:text="${#numbers.formatInteger(status.netAmt,0)}">0</span> ì›
            </div>
          </div>
         
  

<!-- í‘œ: ì‹¤ì œ DBì—ì„œ ì½ì–´ì˜¨ slips ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.2/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.2/styles/ag-theme-alpine.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.2/dist/ag-grid-community.min.js"></script>

<h6 class="fw-semibold mt-3">ê³„ì‚° ê²°ê³¼ ê²€í† </h6>

<!-- ğŸ”¹ AG Grid ì˜ì—­ìœ¼ë¡œ êµì²´ -->
<div id="payslipGrid" class="ag-theme-alpine mt-3" style="height: 420px; width: 100%; border-radius: 10px;"></div>

<script th:inline="javascript">
/*<![CDATA[*/
  // ğŸ”¸ Thymeleafì—ì„œ slips ë¦¬ìŠ¤íŠ¸ë¥¼ JS ê°ì²´ë¡œ ì „ë‹¬
  const slips = /*[[${slips}]]*/ [];

  // ğŸ”¹ ì»¬ëŸ¼ ì •ì˜
  const columnDefs = [
    { headerName: "ì‚¬ë²ˆ", field: "empId", sortable: true, filter: true, width: 120 },
    { headerName: "ì´ë¦„", field: "empName", sortable: true, filter: true, width: 140 },
    { headerName: "ë¶€ì„œ", field: "deptName", sortable: true, filter: true, width: 160 },
    {
      headerName: "ê¸°ë³¸ê¸‰",
      field: "baseAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ìˆ˜ë‹¹í•©ê³„",
      field: "alwAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ì´ì§€ê¸‰ì•¡",
      field: "totAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ê³µì œì•¡",
      field: "dedAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ì‹¤ìˆ˜ë ¹ì•¡",
      field: "netAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 140,
      cellStyle: params => ({
        color: '#0d6efd',
        fontWeight: '600',
        textAlign: 'right'
      })
    },
    {
      headerName: "ìƒíƒœ",
      field: "calcStatus",
      width: 130,
      cellRenderer: params => renderStatusBadge(params.value),
      cellStyle: { textAlign: 'center' }
    },    
    {
    	  headerName: "ìƒì„¸",
    	  width: 120,
    	  cellRenderer: params => {
    		    return `
    		      <button class="btn btn-sm btn-outline-primary"
    		              onclick="openDetail('${params.data.empId}')">
    		        ìƒì„¸ë³´ê¸°
    		      </button>`;
    		},

    	  cellStyle: { textAlign: 'center' }
    	}

  ];

  // ğŸ”¹ Grid ì˜µì…˜
  const gridOptions = {
    columnDefs: columnDefs,
    rowData: slips,
    defaultColDef: {
      resizable: true,
      sortable: true,
      filter: true,
      flex: 1,
      minWidth: 100
    },
    pagination: true,
    paginationPageSize: 10,
    animateRows: true,
    rowHeight: 38,
  };

  // ğŸ”¹ ìˆ«ì í¬ë§· í•¨ìˆ˜
  function numberWithCommas(x) {
    if (x == null) return '';
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // ğŸ”¹ ìƒíƒœ ë±ƒì§€ ë Œë”ëŸ¬
  function renderStatusBadge(status) {
    const cls = {
      CONFIRMED: 'bg-success',
      CALCULATED: 'bg-info text-dark',
      SIMULATED: 'bg-warning text-dark',
      READY: 'bg-secondary'
    }[status] || 'bg-secondary';
    return `<span class="badge ${cls} text-uppercase px-2 py-1">${status}</span>`;
  }

  // ğŸ”¹ Grid ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', () => {
    const gridDiv = document.querySelector('#payslipGrid');
    new agGrid.Grid(gridDiv, gridOptions);
  });
  
  async function openDetail(empId) {
	    const mm = document.getElementById('calc_month').value;

	    try {
	        const res = await fetch(`/pay/calc/detail?yyyymm=${mm}&empId=${empId}`);
	        const data = await res.json();

	        // ====== ê¸°ë³¸ ì •ë³´ ======
	        document.getElementById("d-empId").innerText = data.empId ?? "";
	        document.getElementById("d-empName").innerText = data.empName ?? "";
	        document.getElementById("d-deptName").innerText = data.deptName ?? "";

	        document.getElementById("d-baseAmt").innerText = numberFormat(data.baseAmt);
	        document.getElementById("d-alwAmt").innerText = numberFormat(data.alwAmt);
	        document.getElementById("d-dedAmt").innerText = numberFormat(data.dedAmt);
	        document.getElementById("d-netAmt").innerText = numberFormat(data.netAmt);

	        // ====== ì§€ê¸‰ / ê³µì œ ======
	        const payBody = document.getElementById("payItemsBody");
	        const dedBody = document.getElementById("dedItemsBody");

	        payBody.innerHTML = "";
	        dedBody.innerHTML = "";

	        let payCount = 0;
	        let dedCount = 0;

	        (data.payItems ?? []).forEach(it => {
	            payBody.innerHTML += `
	                <tr>
	                    <td>${it.itemName}</td>
	                    <td class="text-end">${numberFormat(it.amount)}</td>
	                    <td class="text-center">${it.remark ?? ''}</td>
	                </tr>
	            `;
	            payCount++;
	        });

	        (data.dedItems ?? []).forEach(it => {
	            dedBody.innerHTML += `
	                <tr>
	                    <td>${it.itemName}</td>
	                    <td class="text-end">${numberFormat(it.amount)}</td>
	                    <td class="text-center">${it.remark ?? ''}</td>
	                </tr>
	            `;
	            dedCount++;
	        });

	        document.getElementById("payCount").innerText = payCount + "ê±´";
	        document.getElementById("dedCount").innerText = dedCount + "ê±´";

	        new bootstrap.Modal(document.getElementById("detailModal")).show();

	    } catch (err) {
	        alert("ìƒì„¸ì¡°íšŒ ì‹¤íŒ¨: " + err);
	    }
	}

	function numberFormat(num) {
	    if (num == null) return "0 ì›";
	    return Number(num).toLocaleString() + " ì›";
	}



/*]]>*/
</script>
<!-- ===================== ê¸‰ì—¬ ìƒì„¸ ëª¨ë‹¬ ===================== -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">

      <div class="modal-header border-0">
        <h4 class="modal-title fw-bold text-primary">ê¸‰ì—¬ ìƒì„¸ ë‚´ì—­</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- ìƒë‹¨ ê¸°ë³¸ ì •ë³´ -->
        <div class="p-4 rounded-4 mb-4" style="background:#f8f9fa;">
          <div class="row g-3">

            <div class="col-md-4">
              <div class="small text-secondary">ì‚¬ë²ˆ</div>
              <div class="fw-bold fs-5" id="d-empId"></div>
            </div>

            <div class="col-md-4">
              <div class="small text-secondary">ì´ë¦„</div>
              <div class="fw-bold fs-5" id="d-empName"></div>
            </div>

            <div class="col-md-4">
              <div class="small text-secondary">ë¶€ì„œ</div>
              <div class="fw-bold fs-5" id="d-deptName"></div>
            </div>

          </div>

          <hr>

          <div class="row text-center">
            <div class="col">
              <div class="small text-secondary">ê¸°ë³¸ê¸‰</div>
              <div class="fw-bold fs-5" id="d-baseAmt"></div>
            </div>
            <div class="col">
              <div class="small text-secondary">ìˆ˜ë‹¹ í•©ê³„</div>
              <div class="fw-bold fs-5" id="d-alwAmt"></div>
            </div>
            <div class="col">
              <div class="small text-secondary">ê³µì œ í•©ê³„</div>
              <div class="fw-bold fs-5 text-danger" id="d-dedAmt"></div>
            </div>
            <div class="col">
              <div class="small text-secondary">ì‹¤ìˆ˜ë ¹ì•¡</div>
              <div class="fw-bold fs-5 text-primary" id="d-netAmt"></div>
            </div>
          </div>
        </div>

        <!-- ì§€ê¸‰ / ê³µì œ ì˜ì—­ -->
        <div class="row g-4">

          <!-- ğŸ”µ ì§€ê¸‰ í•­ëª© -->
          <div class="col-md-6">
            <div class="rounded-4 border shadow-sm p-3">
              <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold text-primary mb-0">ì§€ê¸‰ í•­ëª©</h5>
                <span class="small text-secondary" id="payCount"></span>
              </div>

              <table class="table align-middle" style="background:#fdfdfd;">
                <thead class="table-light">
                  <tr>
                    <th>í•­ëª©ëª…</th>
                    <th class="text-end">ê¸ˆì•¡</th>                   
                  </tr>
                </thead>
                <tbody id="payItemsBody"></tbody>
              </table>
            </div>
          </div>

          <!-- ğŸ”´ ê³µì œ í•­ëª© -->
          <div class="col-md-6">
            <div class="rounded-4 border shadow-sm p-3">
              <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold text-danger mb-0">ê³µì œ í•­ëª©</h5>
                <span class="small text-secondary" id="dedCount"></span>
              </div>

              <table class="table align-middle" style="background:#fdfdfd;">
                <thead class="table-light">
                  <tr>
                    <th>í•­ëª©ëª…</th>
                    <th class="text-end">ê¸ˆì•¡</th>                    
                  </tr>
                </thead>
                <tbody id="dedItemsBody"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer border-0">
        <button class="btn btn-secondary px-4" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>



      <!-- 2. ê¸‰ì—¬ ëª…ì„¸ì„œ ê´€ë¦¬ -->
      <section class="card shadow-sm">
        <div class="card-body">
          <h3 class="h5 mb-3 border-start ps-2">ê¸‰ì—¬ ëª…ì„¸ì„œ ê´€ë¦¬</h3>
          <p class="text-secondary">
            í™•ì •ëœ ê¸‰ì—¬ ê³„ì‚° ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ <strong>ì›”ë³„ ê¸‰ì—¬ ëª…ì„¸ì„œ</strong>ë¥¼ ì‚¬ì›ë³„ë¡œ ìë™ ìƒì„±í•˜ê³  PDF íŒŒì¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.
          </p>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <label for="payroll_month" class="col-form-label fw-semibold">ëª…ì„¸ì„œ ìƒì„± ì›”</label>
            </div>
            <div class="col-auto">
              <select id="payroll_month" class="form-select form-select-sm">
                <option th:each="m : ${months}"
                        th:value="${m}"
                        th:selected="${m==yyyymm}"
                        th:text="${#strings.substring(m,0,4)} + 'ë…„ ' + ${#strings.substring(m,4,6)} + 'ì›”'">
                </option>
              </select>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-success">ëª…ì„¸ì„œ ì¼ê´„ ìƒì„±</button>
            <button type="button" class="btn btn-outline-secondary">ìƒì„± í˜„í™© í™•ì¸</button>
            <button type="button" class="btn btn-outline-secondary">ëª…ì„¸ì„œ PDF ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button>
          </div>

          <p class="text-muted mt-3 mb-0">* ëª…ì„¸ì„œëŠ” ìƒì„± ì¦‰ì‹œ ì‚¬ì› í¬í„¸ì—ì„œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>
      </section>
    </div>

    <script>
      const monthSel = document.getElementById('calc_month');
      if (monthSel) {
        monthSel.addEventListener('change', (e) => {
          const mm = e.target.value;
          location.href = '/pay/calc?yyyymm=' + mm;
        });
      }

      // AJAX ìƒíƒœ ë™ê¸°í™” (REST Controller ì¶”ê°€ í•„ìš”)
    async function refreshStatus(mm) {
  try {
    const res = await fetch(`/pay/calc/status?yyyymm=${mm}`, {
      headers: { 'Accept':'application/json' }
    });
    if (!res.ok) return;

    const s = await res.json();
    const fmt = (n)=> (n ?? 0).toLocaleString();

    document.getElementById('statMonth').textContent = mm;

  
    const statusMap = {
      'CONFIRMED': 'í™•ì • ì™„ë£Œ',
      'CALCULATED': 'ê³„ì‚° ì™„ë£Œ',
      'SIMULATED': 'ê°€ê³„ì‚° ì™„ë£Œ',
      'READY': 'ë¯¸ê³„ì‚°'
    };
    document.getElementById('statCalc').textContent = statusMap[s.calcStatus] ?? 'ë¯¸ê³„ì‚°';

    document.getElementById('statCount').textContent = `ê±´ìˆ˜ ${s.count}`;
    document.getElementById('statTot').textContent = fmt(s.totalAmt);
    document.getElementById('statDed').textContent = fmt(s.dedAmt);
    document.getElementById('statNet').textContent = fmt(s.netAmt);

    const box = document.getElementById('statusBox');
    box.classList.remove('alert-success','alert-warning');

    // ğŸ”¥ CONFIRMEDì´ë©´ ì´ˆë¡ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” ë…¸ë€ìƒ‰
    box.classList.add(s.calcStatus === 'CONFIRMED' ? 'alert-success' : 'alert-warning');

    // í™•ì • ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„± (ì›í•˜ë©´ ê·œì¹™ ë°”ê¿€ ìˆ˜ ìˆìŒ)
    const btnConfirm = document.getElementById('btnConfirm');
    if (btnConfirm) btnConfirm.disabled = (s.calcStatus !== 'CALCULATED');

  } catch(e) {
    console.warn('status refresh failed', e);
  }
}


      (function(){
        const mm = document.getElementById('calc_month')?.value;
        if (mm) refreshStatus(mm);
      })();
   
  // ì›”/ìœ í˜• ì„ íƒë°•ìŠ¤ì™€ ë²„íŠ¼ ê°„ ê°’ ë™ê¸°í™”
  const monthSelect = document.getElementById("monthSelect");
  const typeSelect = document.getElementById("typeSelect");

  function applyCalcParams() {
    document.getElementById("calcMonth").value = monthSelect.value;
    document.getElementById("calcMonthConfirm").value = monthSelect.value;
    document.getElementById("calcType").value = typeSelect.value;
    document.getElementById("calcTypeConfirm").value = typeSelect.value;
  }

  monthSelect.addEventListener("change", applyCalcParams);
  typeSelect.addEventListener("change", applyCalcParams);
  
 

</script>



  </th:block>
</th:block>
