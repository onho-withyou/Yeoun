<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{/layouts/layout.html}">

          

  <th:block layout:fragment="content">

    <div class="container-xxl py-4">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-primary fw-bold">ê¸‰ì—¬ ê³„ì‚° ë° í™•ì •</h1>
      </div>

      <!-- 1. ê¸‰ì—¬ ê³„ì‚° ë° ì‹œë®¬ë ˆì´ì…˜ -->
      <section class="card shadow-sm mb-4">
        <div class="card-body">
          <h3 class="h5 mb-3 border-start ps-2">1. ê¸‰ì—¬ ê³„ì‚° ë° ì‹œë®¬ë ˆì´ì…˜</h3>
          <p class="text-secondary">
            ì„¤ì •ëœ ê¸°ì¤€ì— ë”°ë¼ ìë™ìœ¼ë¡œ <strong>ê¸‰ì—¬ ì´ì•¡</strong> ë° <strong>ê³µì œì•¡</strong>ì„ ê³„ì‚°í•˜ê³ , ê²°ê³¼ë¥¼ ì‹œë®¬ë ˆì´ì…˜ ë° ê²€í† í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>

          <!-- ì¡°ê±´ ì„ íƒ -->
          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <label for="calc_month" class="col-form-label fw-semibold">ê³„ì‚° ëŒ€ìƒ ì›”</label>
            </div>
            <div class="col-auto">
              <select id="calc_month" class="form-select form-select-sm">
                <option th:each="m : ${months}"
                        th:value="${m}"
                        th:selected="${m==yyyymm}"
                        th:text="${#strings.substring(m,0,4)} + 'ë…„ ' + ${#strings.substring(m,4,6)} + 'ì›”'">
                </option>
                <option th:if="${months == null}" th:value="${yyyymm}" th:text="${yyyymm}">ì„ íƒì›”</option>
              </select>
            </div>

            <div class="col-auto">
              <label class="col-form-label fw-semibold">ê³„ì‚° ìœ í˜•</label>
            </div>
            <div class="col-auto">
              <select id="calc_type" class="form-select form-select-sm">
                <option value="all">ì¼ê´„ ê³„ì‚° (ì „ ì‚¬ì›)</option>
                <option value="individual" disabled>ê°œë³„ ê³„ì‚° (ì¤€ë¹„ì¤‘)</option>
                <option value="mid_join_leave" disabled>ì¤‘ë„ ì…/í‡´ì‚¬ì ì¼í•  ì •ì‚° (ì¤€ë¹„ì¤‘)</option>
              </select>
            </div>
          </div>

          <!-- ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="d-flex flex-wrap gap-2 mb-3">
          <form th:action="@{/pay/calc/simulate}" method="post" class="d-inline">
			  <input type="hidden" name="yyyymm" id="calcMonth" th:value="${yyyymm}">
			  <input type="hidden" name="calcType" id="calcType" value="ALL"> <!-- ê¸°ë³¸ê°’: ì „ì‚¬ì› -->
			  <input type="hidden" name="overwrite" value="true">
			
			  <button type="submit" class="btn btn-warning">
			    ê³„ì‚° ì‹œë®¬ë ˆì´ì…˜ (ê°€ê³„ì‚°)
			  </button>
			</form>

            <form th:action="@{/pay/calc/confirm}" method="post" class="d-inline">
			  <input type="hidden" name="yyyymm" id="calcMonthConfirm" th:value="${yyyymm}">
			  <input type="hidden" name="calcType" id="calcTypeConfirm" value="ALL">
			  <input type="hidden" name="overwrite" value="true">
			
			  <button type="submit" class="btn btn-success">
			    ê³„ì‚° ê²°ê³¼ í™•ì •
			  </button>
</form>
          </div>

          <!-- ê²°ê³¼ ìƒíƒœ -->
          <div id="statusBox"
               class="alert d-flex justify-content-between align-items-center"
               th:classappend="${status.calculated} ? ' alert-success' : ' alert-warning'">
            <div>
              ì„ íƒ ì›”(<span id="statMonth" th:text="${yyyymm}">YYYYMM</span>) ê³„ì‚° ìƒíƒœ:
              <strong id="statCalc" th:text="${status.calculated} ? 'ê³„ì‚° ì™„ë£Œ' : 'ë¯¸ê³„ì‚°'">ë¯¸ê³„ì‚°</strong>
              <span class="ms-2 badge bg-secondary" id="statCount" th:text="|ê±´ìˆ˜ ${status.count}|">ê±´ìˆ˜ 0</span>
            </div>
            <div>
              ì´ì§€ê¸‰:
              <span class="text-primary fw-bold" id="statTot"
                    th:text="${#numbers.formatInteger(status.totalAmt,0)}">0</span> ì›
              Â· ê³µì œ:
              <span class="text-danger fw-bold ms-1" id="statDed"
                    th:text="${#numbers.formatInteger(status.dedAmt,0)}">0</span> ì›
              Â· ì‹¤ìˆ˜ë ¹:
              <span class="fw-bold ms-1" id="statNet"
                    th:text="${#numbers.formatInteger(status.netAmt,0)}">0</span> ì›
            </div>
          </div>
         
  

<!-- í‘œ: ì‹¤ì œ DBì—ì„œ ì½ì–´ì˜¨ slips ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.2/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.2/styles/ag-theme-alpine.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@32.0.2/dist/ag-grid-community.min.js"></script>

<h6 class="fw-semibold mt-3">ê³„ì‚° ê²°ê³¼ ê²€í† </h6>

<!-- ğŸ”¹ AG Grid ì˜ì—­ìœ¼ë¡œ êµì²´ -->
<div id="payslipGrid" class="ag-theme-alpine mt-3" style="height: 420px; width: 100%; border-radius: 10px;"></div>

<script th:inline="javascript">
/*<![CDATA[*/
  // ğŸ”¸ Thymeleafì—ì„œ slips ë¦¬ìŠ¤íŠ¸ë¥¼ JS ê°ì²´ë¡œ ì „ë‹¬
  const slips = /*[[${slips}]]*/ [];

  // ğŸ”¹ ì»¬ëŸ¼ ì •ì˜
  const columnDefs = [
    { headerName: "ì‚¬ë²ˆ", field: "empId", sortable: true, filter: true, width: 120 },
    { headerName: "ì´ë¦„", field: "empName", sortable: true, filter: true, width: 140 },
    { headerName: "ë¶€ì„œ", field: "deptName", sortable: true, filter: true, width: 160 },
    {
      headerName: "ê¸°ë³¸ê¸‰",
      field: "baseAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ìˆ˜ë‹¹í•©ê³„",
      field: "alwAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ì´ì§€ê¸‰ì•¡",
      field: "totAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ê³µì œì•¡",
      field: "dedAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 130,
      cellClass: 'text-end'
    },
    {
      headerName: "ì‹¤ìˆ˜ë ¹ì•¡",
      field: "netAmt",
      valueFormatter: p => numberWithCommas(p.value),
      type: 'numericColumn',
      width: 140,
      cellStyle: params => ({
        color: '#0d6efd',
        fontWeight: '600',
        textAlign: 'right'
      })
    },
    {
      headerName: "ìƒíƒœ",
      field: "calcStatus",
      width: 130,
      cellRenderer: params => renderStatusBadge(params.value),
      cellStyle: { textAlign: 'center' }
    }
  ];

  // ğŸ”¹ Grid ì˜µì…˜
  const gridOptions = {
    columnDefs: columnDefs,
    rowData: slips,
    defaultColDef: {
      resizable: true,
      sortable: true,
      filter: true,
      flex: 1,
      minWidth: 100
    },
    pagination: true,
    paginationPageSize: 10,
    animateRows: true,
    rowHeight: 38,
  };

  // ğŸ”¹ ìˆ«ì í¬ë§· í•¨ìˆ˜
  function numberWithCommas(x) {
    if (x == null) return '';
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // ğŸ”¹ ìƒíƒœ ë±ƒì§€ ë Œë”ëŸ¬
  function renderStatusBadge(status) {
    const cls = {
      CONFIRMED: 'bg-success',
      CALCULATED: 'bg-info text-dark',
      SIMULATED: 'bg-warning text-dark',
      READY: 'bg-secondary'
    }[status] || 'bg-secondary';
    return `<span class="badge ${cls} text-uppercase px-2 py-1">${status}</span>`;
  }

  // ğŸ”¹ Grid ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', () => {
    const gridDiv = document.querySelector('#payslipGrid');
    new agGrid.Grid(gridDiv, gridOptions);
  });
/*]]>*/
</script>

          

      <!-- 2. ê¸‰ì—¬ ëª…ì„¸ì„œ ê´€ë¦¬ -->
      <section class="card shadow-sm">
        <div class="card-body">
          <h3 class="h5 mb-3 border-start ps-2">2. ê¸‰ì—¬ ëª…ì„¸ì„œ ê´€ë¦¬</h3>
          <p class="text-secondary">
            í™•ì •ëœ ê¸‰ì—¬ ê³„ì‚° ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ <strong>ì›”ë³„ ê¸‰ì—¬ ëª…ì„¸ì„œ</strong>ë¥¼ ì‚¬ì›ë³„ë¡œ ìë™ ìƒì„±í•˜ê³  PDF íŒŒì¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.
          </p>

          <div class="row g-3 align-items-center mb-3">
            <div class="col-auto">
              <label for="payroll_month" class="col-form-label fw-semibold">ëª…ì„¸ì„œ ìƒì„± ì›”</label>
            </div>
            <div class="col-auto">
              <select id="payroll_month" class="form-select form-select-sm">
                <option th:each="m : ${months}"
                        th:value="${m}"
                        th:selected="${m==yyyymm}"
                        th:text="${#strings.substring(m,0,4)} + 'ë…„ ' + ${#strings.substring(m,4,6)} + 'ì›”'">
                </option>
              </select>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-success">ëª…ì„¸ì„œ ì¼ê´„ ìƒì„±</button>
            <button type="button" class="btn btn-outline-secondary">ìƒì„± í˜„í™© í™•ì¸</button>
            <button type="button" class="btn btn-outline-secondary">ëª…ì„¸ì„œ PDF ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button>
          </div>

          <p class="text-muted mt-3 mb-0">* ëª…ì„¸ì„œëŠ” ìƒì„± ì¦‰ì‹œ ì‚¬ì› í¬í„¸ì—ì„œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>
      </section>
    </div>

    <script>
      const monthSel = document.getElementById('calc_month');
      if (monthSel) {
        monthSel.addEventListener('change', (e) => {
          const mm = e.target.value;
          location.href = '/pay/calc?yyyymm=' + mm;
        });
      }

      // AJAX ìƒíƒœ ë™ê¸°í™” (REST Controller ì¶”ê°€ í•„ìš”)
      async function refreshStatus(mm) {
        try {
          const res = await fetch(`/pay/calc/status?yyyymm=${mm}`, { headers: { 'Accept':'application/json' }});
          if (!res.ok) return;
          const s = await res.json();
          const fmt = (n)=> (n ?? 0).toLocaleString();

          document.getElementById('statMonth').textContent = mm;
          document.getElementById('statCalc').textContent  = s.calculated ? 'ê³„ì‚° ì™„ë£Œ' : 'ë¯¸ê³„ì‚°';
          document.getElementById('statCount').textContent = `ê±´ìˆ˜ ${s.count}`;
          document.getElementById('statTot').textContent   = fmt(s.totalAmt);
          document.getElementById('statDed').textContent   = fmt(s.dedAmt);
          document.getElementById('statNet').textContent   = fmt(s.netAmt);

          const box = document.getElementById('statusBox');
          box.classList.remove('alert-success','alert-warning');
          box.classList.add(s.calculated ? 'alert-success' : 'alert-warning');

          const btnConfirm = document.getElementById('btnConfirm');
          if (btnConfirm) btnConfirm.disabled = !s.calculated;
        } catch(e) {
          console.warn('status refresh failed', e);
        }
      }

      (function(){
        const mm = document.getElementById('calc_month')?.value;
        if (mm) refreshStatus(mm);
      })();
   
  // ì›”/ìœ í˜• ì„ íƒë°•ìŠ¤ì™€ ë²„íŠ¼ ê°„ ê°’ ë™ê¸°í™”
  const monthSelect = document.getElementById("monthSelect");
  const typeSelect = document.getElementById("typeSelect");

  function applyCalcParams() {
    document.getElementById("calcMonth").value = monthSelect.value;
    document.getElementById("calcMonthConfirm").value = monthSelect.value;
    document.getElementById("calcType").value = typeSelect.value;
    document.getElementById("calcTypeConfirm").value = typeSelect.value;
  }

  monthSelect.addEventListener("change", applyCalcParams);
  typeSelect.addEventListener("change", applyCalcParams);
</script>



  </th:block>
</th:block>
