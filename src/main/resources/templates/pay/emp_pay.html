<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{/layouts/layout.html}">

  <th:block layout:fragment="content">

    <div class="container-fluid py-4">

      <!-- ===================== PAGE HEADER ===================== -->
      <header>
        <div class="container row">
          <div class="grow">
            <h1>ê¸‰ì—¬ ëª…ì„¸ì„œ ì¡°íšŒ</h1>
            <div class="subtitle">ì›”ë³„ ê¸‰ì—¬ëª…ì„¸ì„œ í™•ì¸ Â· PDF ë‹¤ìš´ë¡œë“œ Â· ë¬¸ì˜ ë“±ë¡</div>
          </div>
          <div class="toolbar">
            <button class="btn btn-ghost btn-icon" id="prevMonthBtn">â—€ ì´ì „</button>
            <input id="month" type="month">
            <button class="btn btn-ghost btn-icon" id="nextMonthBtn">ë‹¤ìŒ â–¶</button>
            <button class="btn btn-soft btn-icon" id="printBtn">ğŸ–¨ PDF ì €ì¥</button>
          </div>
        </div>
      </header>

      <main class="container grid">
        <!-- Summary -->
        <section class="grid two">
          <div class="panel">
            <div class="muted mini" id="payMonthLabel">2025-01</div>
            <div class="kpi" id="netPay">â‚©0</div>
            <div class="kpi-sub">ì‹¤ìˆ˜ë ¹ì•¡</div>
          </div>
          <div class="panel">
            <div class="row" style="justify-content:space-between">
              <div>
                <div><strong id="empName">í™ê¸¸ë™</strong> <span class="badge" id="empPos">ëŒ€ë¦¬</span></div>
                <div class="muted mini">ë¶€ì„œ: <span id="empDept">ê°œë°œ1íŒ€</span> Â· ì‚¬ë²ˆ: <span id="empNo">E2025001</span></div>
              </div>
              <div class="right">
                <div>ì§€ê¸‰ì¼: <span id="payDate">2025-01-25</span></div>
                <div class="muted mini">ì§€ê¸‰ì€í–‰: <span id="bank">êµ­ë¯¼(**-**-1234)</span></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Tables -->
        <section class="grid two">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ì§€ê¸‰ í•­ëª©</h3>
              <span class="muted mini" id="earnCount">0ê°œ</span>
            </div>
            <table id="earnTable">
              <thead><tr><th>í•­ëª©</th><th class="right">ê¸ˆì•¡</th><th class="right">ë¹„ê³ </th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th>ì†Œê³„</th><th class="right" id="earnTotal">â‚©0</th><th></th></tr></tfoot>
            </table>
          </div>

          <div class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ê³µì œ í•­ëª©</h3>
              <span class="muted mini" id="dedCount">0ê°œ</span>
            </div>
            <table id="deductTable">
              <thead><tr><th>í•­ëª©</th><th class="right">ê¸ˆì•¡</th><th class="right">ë¹„ê³ </th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th>ì†Œê³„</th><th class="right" id="deductTotal">â‚©0</th><th></th></tr></tfoot>
            </table>
          </div>
        </section>

       
      </main>

     

      <script>
        const el = id => document.getElementById(id);
        const fmt = n => "â‚©"+(n||0).toLocaleString("ko-KR");

        const SAMPLE = {
          employee: { name:"í™ê¸¸ë™", dept:"ê°œë°œ1íŒ€", pos:"ëŒ€ë¦¬", no:"E2025001", bank:"êµ­ë¯¼(**-**-1234)" },
          months: {
            "2025-01": {
              payDate:"2025-01-25",
              memo:"ì—°ë§ì •ì‚° ì •ì‚°ë¶„ ì¼ë¶€ ì°¨ì›” ë°˜ì˜.",
              earn:[
                {name:"ê¸°ë³¸ê¸‰", amount:2800000, note:""},
                {name:"ì‹ëŒ€", amount:200000, note:"ë¹„ê³¼ì„¸"},
                {name:"êµí†µë¹„", amount:100000, note:""},
                {name:"ì•¼ê·¼ìˆ˜ë‹¹", amount:240000, note:"15ì‹œê°„"}
              ],
              deduct:[
                {name:"ì†Œë“ì„¸", amount:120000, note:""},
                {name:"ì§€ë°©ì†Œë“ì„¸", amount:12000, note:""},
                {name:"êµ­ë¯¼ì—°ê¸ˆ", amount:126000, note:"4.5%"},
                {name:"ê±´ê°•ë³´í—˜", amount:103000, note:""},
                {name:"ê³ ìš©ë³´í—˜", amount:23000, note:""}
              ]
            },
            "2024-12": {
              payDate:"2024-12-25",
              memo:"ì„±ê³¼ê¸‰ ë³„ë„ì§€ê¸‰(ë¹„ì •ê¸°).",
              earn:[
                {name:"ê¸°ë³¸ê¸‰", amount:2800000, note:""},
                {name:"ì‹ëŒ€", amount:200000, note:"ë¹„ê³¼ì„¸"},
                {name:"ì„±ê³¼ê¸‰", amount:1000000, note:"ë¹„ì •ê¸°"}
              ],
              deduct:[
                {name:"ì†Œë“ì„¸", amount:210000, note:""},
                {name:"ì§€ë°©ì†Œë“ì„¸", amount:21000, note:""},
                {name:"êµ­ë¯¼ì—°ê¸ˆ", amount:126000, note:""},
                {name:"ê±´ê°•ë³´í—˜", amount:103000, note:""},
                {name:"ê³ ìš©ë³´í—˜", amount:23000, note:""}
              ]
            }
          }
        };

        function loadMonth(month){
          const m = SAMPLE.months[month];
          const emp = SAMPLE.employee;
          if(!m){ alert("í•´ë‹¹ ì›” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

          el('payMonthLabel').textContent = month;
          el('payDate').textContent = m.payDate;
          el('bank').textContent = emp.bank;
          el('empName').textContent = emp.name;
          el('empDept').textContent = emp.dept;
          el('empPos').textContent = emp.pos;
          el('empNo').textContent = emp.no;
          el('memo').textContent = m.memo || "íŠ¹ì´ì‚¬í•­ ì—†ìŒ.";

          const earnBody = el('earnTable').querySelector('tbody');
          const dedBody  = el('deductTable').querySelector('tbody');
          earnBody.innerHTML = ""; dedBody.innerHTML = "";

          let earnTotal=0, dedTotal=0;
          m.earn.forEach(it => {
            earnTotal += it.amount;
            earnBody.insertAdjacentHTML('beforeend',
              `<tr><td>${it.name}</td><td class="right">${fmt(it.amount)}</td><td class="right muted">${it.note||""}</td></tr>`);
          });
          m.deduct.forEach(it => {
            dedTotal += it.amount;
            dedBody.insertAdjacentHTML('beforeend',
              `<tr><td>${it.name}</td><td class="right">${fmt(it.amount)}</td><td class="right muted">${it.note||""}</td></tr>`);
          });

          el('earnTotal').textContent = fmt(earnTotal);
          el('deductTotal').textContent = fmt(dedTotal);
          el('netPay').textContent = fmt(earnTotal - dedTotal);
          el('earnCount').textContent = m.earn.length + "ê°œ";
          el('dedCount').textContent = m.deduct.length + "ê°œ";
          el('month').value = month;
        }

        function shiftMonth(current, diff){
          const [y,m] = current.split('-').map(Number);
          const d = new Date(y, m-1+diff, 1);
          const yyyy = d.getFullYear();
          const mm = ('0'+(d.getMonth()+1)).slice(-2);
          return `${yyyy}-${mm}`;
        }

        // Inquiry storage (local only)
        const STORE_KEY = "pay_inquiries";
        const getInquiries = () => { try{return JSON.parse(localStorage.getItem(STORE_KEY)||"[]")}catch{ return [] }};
        const setInquiries = (arr) => localStorage.setItem(STORE_KEY, JSON.stringify(arr));
        function renderInquiries(){
          const list = el('inquiryList');
          const arr = getInquiries().sort((a,b)=> b.createdAt - a.createdAt);
          if(arr.length===0){ list.innerHTML = '<span class="muted">ë“±ë¡ëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</span>'; return; }
          list.innerHTML = arr.map(i => `
            <div class="card" style="margin:10px 0">
              <div class="row" style="justify-content:space-between">
                <div><strong>${i.title}</strong> <span class="badge">${i.type}</span></div>
                <div class="muted mini">${new Date(i.createdAt).toLocaleString()}</div>
              </div>
              <div class="divider"></div>
              <div class="muted">${i.body.replace(/</g,"&lt;")}</div>
              <div class="row" style="justify-content:space-between;margin-top:8px">
                <div class="mini muted">ì—°ë½ìˆ˜ë‹¨: ${i.channel} Â· íŒŒì¼ ${i.files.length}ê°œ</div>
                <div class="status" data-v="${i.status}">${i.status}</div>
              </div>
            </div>
          `).join("");
        }

        // Drawer helpers
        const openDrawer = ()=> el('drawer').classList.add('open');
        const closeDrawer = ()=> el('drawer').classList.remove('open');

        document.addEventListener('DOMContentLoaded', () => {
          // init
          const keys = Object.keys(SAMPLE.months).sort().reverse();
          loadMonth(keys[0]);
          renderInquiries();

          el('printBtn').addEventListener('click', ()=> window.print());
          el('prevMonthBtn').addEventListener('click', ()=> loadMonth(shiftMonth(el('month').value, -1)));
          el('nextMonthBtn').addEventListener('click', ()=> loadMonth(shiftMonth(el('month').value, +1)));
          el('month').addEventListener('change', e => loadMonth(e.target.value));

          // ì¡´ì¬ ì—¬ë¶€ ì²´í¬(ì•ˆì „)
          const btn1 = el('openInquiryBtn');
          if (btn1) btn1.addEventListener('click', openDrawer);
          el('openInquiryBtn2').addEventListener('click', openDrawer);

          el('closeDrawer').addEventListener('click', closeDrawer);
          el('cancelInquiry').addEventListener('click', closeDrawer);

          el('inquiryForm').addEventListener('submit', (ev) => {
            ev.preventDefault();
            const title = el('inqTitle').value.trim();
            const type = el('inqType').value;
            const body = el('inqBody').value.trim();
            const channel = el('inqChannel').value;
            if(!title || !body){ alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
            const files = Array.from(el('inqFiles').files).map(f => ({name:f.name, size:f.size}));
            const rec = { id: crypto.randomUUID(), title, type, body, channel, files, status:"ì ‘ìˆ˜", createdAt: Date.now() };
            const arr = getInquiries(); arr.push(rec); setInquiries(arr);
            closeDrawer(); ev.target.reset(); renderInquiries();
            alert("ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹´ë‹¹ì í™•ì¸ í›„ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.");
          });
        });
      </script>

    </div>

  </th:block>
</th:block>
