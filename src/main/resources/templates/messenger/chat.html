<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/messenger/chat.css}">
</head>

<body>

<div class="chat-window">

  <!-- =======================================
       상단바
  ======================================== -->
  <div class="chat-header header-purple">
    <div class="chat-header-left">
      <div class="chat-title" th:text="${groupName}"></div>
      <i class="bi bi-pencil-square" id="rename-room" th:if="${roomId != null}"></i>
    </div>

    <div class="chat-header-right">
      <i class="bi bi-people-fill" id="toggle-members"></i>
      <i class="bi bi-pin-angle-fill pin-icon" id="pin-room"></i>
      <i class="bi bi-box-arrow-right" id="exit-room"></i>
    </div>
  </div>

  <!-- =======================================
       메시지 영역
  ======================================== -->
  <div class="chat-body" id="chat-body">

    <input type="hidden" id="groupYn" th:value="${groupYn}">

    <!-- 새 방 안내 -->
    <div class="new-room-empty" id="new-room-empty" th:if="${roomId == null}">
      <div class="empty-guide"><span>대화를 시작해보세요.</span></div>
    </div>

    <!-- 메시지 반복 -->
    <div th:each="msg : ${msgList}"
         class="msg-row"
         th:classappend="${msg.msgType=='SYSTEM'} ? 'system' :
                         (${msg.senderId} == ${#authentication.principal.empId} ? 'right' : 'left')"
         th:attr="data-msg-id=${msg.msgId}">

      <!-- SYSTEM 메시지 -->
      <th:block th:if="${msg.msgType}=='SYSTEM'">
        <div class="system-text" th:text="${msg.msgContent}"></div>
      </th:block>

      <!-- 상대 메시지 -->
      <th:block th:if="${msg.msgType!='SYSTEM' and msg.senderId != #authentication.principal.empId}">
        <img th:src="|@{'/img/msg_img_' + ${msg.senderProfile} + '.png'}|" class="profile-img">

        <div class="msg-main">
          <div class="sender-name" th:text="${msg.senderName}"></div>

          <!-- 텍스트 -->
          <div class="msg-bubble msg-left" th:if="${msg.msgType=='TEXT'}"
               th:text="${msg.msgContent}"></div>

          <!-- 파일 -->
          <div class="file-bundle" th:if="${msg.msgType=='FILE'}">
            <div class="file-item" th:each="f : ${msg.files}">
              <!-- 이미지 -->
              <th:block th:if="${f.category.startsWith('image')}">
                <a th:href="@{|/files/download/${f.fileId}|}" target="_blank">
                  <img th:src="@{|/uploads/${f.filePath}/${f.fileName}|}" class="file-thumb">
                </a>
                <span th:text="${f.originFileName}" class="file-name"></span>
              </th:block>

              <!-- 그 외 -->
              <th:block th:unless="${f.category.startsWith('image')}">
                <i class="bi bi-file-earmark"></i>
                <span class="file-name" th:text="${f.originFileName}"></span>
              </th:block>
            </div>
          </div>
        </div>

        <div class="msg-time msg-time-left"
             th:text="${#temporals.format(msg.sentDate, 'yyyy-MM-dd a h:mm')}"></div>
      </th:block>


      <!-- 내 메시지 -->
      <th:block th:if="${msg.msgType!='SYSTEM' and msg.senderId == #authentication.principal.empId}">
        <div class="msg-meta">
          <span th:text="${#temporals.format(msg.sentDate, 'yyyy-MM-dd a h:mm')}"></span>
          <i class="bi bi-check2-all read-check"></i>
        </div>

        <!-- 텍스트 -->
        <div class="msg-bubble msg-right" th:if="${msg.msgType=='TEXT'}"
             th:text="${msg.msgContent}"></div>

        <!-- 파일 -->
        <div class="file-bundle" th:if="${msg.msgType=='FILE'}">
          <div class="file-item" th:each="f : ${msg.files}">
            <th:block th:if="${f.category.startsWith('image')}">
              <a th:href="@{|/files/download/${f.fileId}|}" target="_blank">
                <img th:src="@{|/uploads/${f.filePath}/${f.fileName}|}" class="file-thumb">
              </a>
              <span class="file-name" th:text="${f.originFileName}"></span>
            </th:block>

            <th:block th:unless="${f.category.startsWith('image')}">
              <i class="bi bi-file-earmark"></i>
              <span class="file-name" th:text="${f.originFileName}"></span>
            </th:block>
          </div>
        </div>
      </th:block>

    </div>
  </div>


  <!-- =======================================
       입력 + 파일 미리보기
  ======================================== -->
  <div id="attachment-preview"></div>

  <div class="chat-footer">
    <label class="file-btn">
      <i class="bi bi-paperclip"></i>
      <input type="file" id="fileInput" hidden multiple>
    </label>

    <textarea id="message" placeholder="메시지를 입력하세요"></textarea>

    <button id="send" class="send-btn">
      <i class="bi bi-send-fill"></i>
    </button>
  </div>
</div>

<!-- =======================================
     참여자 패널
======================================= -->
<div class="member-panel" id="member-panel">
  <div class="member-panel-header">
    <span>참여자</span>
    <i class="bi bi-x-lg" id="close-member-panel"></i>
  </div>

  <div class="member-panel-body">
    <div class="member-item" th:each="m : ${members}">
      <img th:src="|@{/img/msg_img_${m.msgProfile}.png}|" class="member-avatar">
      <div class="info">
        <p class="name" th:text="${m.empName}"></p>
        <small th:text="|${m.department} / ${m.position}|"></small>
      </div>
    </div>
  </div>
</div>

<!-- =======================================
     방 이름 수정 모달
======================================= -->
<div class="modal fade" id="renameModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">방 이름 수정</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="text" class="form-control" id="renameInput" placeholder="새 그룹명을 입력하세요">
      </div>

      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">취소</button>
        <button class="btn btn-primary" id="renameSubmit">변경</button>
      </div>
    </div>
  </div>
</div>

<!-- =======================================
     방 나가기 모달
======================================= -->
<div class="modal fade" id="exitModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">

      <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold">방 나가기</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p class="mb-0 fw-semibold">정말 방을 나가겠습니까?</p>
        <small>나간 이후 대화 내용은 다시 볼 수 없습니다.</small>
      </div>

      <div class="modal-footer border-0">
        <button class="btn btn-light px-3" data-bs-dismiss="modal">취소</button>
        <button class="btn btn-danger px-3" id="exitSubmit">나가기</button>
      </div>
    </div>
  </div>
</div>

<!-- =======================================
     JS
======================================= -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- 소켓 JS -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:src="@{/js/common/connectSocket.js}"></script>
<script th:src="@{/js/messenger/createRoom.js}"></script>
<script th:src="@{/js/common/formatTimeJS.js}"></script>
<script th:inline="javascript">
  const chatBody = document.getElementById('chat-body');
  const textarea = document.getElementById('message');
  const sendBtn = document.getElementById('send');
  const emptyView = document.getElementById('new-room-empty');

  // Thymeleaf에서 내려줄 값
  window.roomId         = /*[[${roomId}]]*/ null;
  window.targetEmpId    = /*[[${targetEmpId}]]*/ null;
  window.csrfToken      = /*[[${_csrf.token}]]*/ '';
  window.csrfHeaderName = /*[[${_csrf.headerName}]]*/ '';
  window.senderId       = /*[[${#authentication.principal.empId}]]*/ '';

  console.log("roomId.... : ", roomId);
  console.log("target..... : ", targetEmpId);
  console.log("token..... : ", csrfToken);
  console.log("headerName..... : ", csrfHeaderName);



  //한 줄 높이(px)
const baseHeight = 40;

textarea.addEventListener("input", function () {
 this.style.height = baseHeight + "px"; // 무조건 한 줄에서 시작

 const newHeight = this.scrollHeight;

 // scrollHeight가 기본 한 줄을 넘겼을 때만 증가
 if (newHeight > baseHeight) {
   this.style.height = Math.min(newHeight, 120) + "px";
 }
});

//참여자 패널 토글 관련 요소
const toggleBtn   = document.getElementById('toggle-members');
const memberPanel = document.getElementById('member-panel');
const closeBtn    = document.getElementById('close-member-panel');

console.log('toggleBtn  =', toggleBtn);
console.log('memberPanel=', memberPanel);
console.log('closeBtn   =', closeBtn);

//참여자 패널 열기
if (toggleBtn && memberPanel) {
  toggleBtn.addEventListener('click', () => {
    console.log('open member panel');
    memberPanel.classList.add('open');
  });
}

//참여자 패널 닫기
if (closeBtn && memberPanel) {
  closeBtn.addEventListener('click', () => {
    console.log('close member panel');
    memberPanel.classList.remove('open');
  });
}

  // ================================
  // 방 이름 수정 모달 열기
  // ================================
  document.getElementById('rename-room')?.addEventListener('click', () => {

    console.log("방 이름 클릭!!!!!");

    const modal = new bootstrap.Modal(document.getElementById('renameModal'));

    // 기존 제목 불러오기
    const title = document.querySelector('.chat-header-left .chat-title')?.textContent.trim();
    document.getElementById('renameInput').value = title || "";

    modal.show();
  });

// 방 이름 수정 모달 컨트롤
  document.getElementById('renameSubmit').addEventListener('click', () => {
    const newName = document.getElementById('renameInput').value.trim();
    if (!newName) return;

    // 화면 즉시 변환
    document.querySelector('.chat-header-left .chat-title').textContent = newName;

    // ===== 서버 호출 =====
    fetch(`/messenger/room/${roomId}/rename`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        [csrfHeaderName]: csrfToken
      },
      body: JSON.stringify({ groupName: newName })
    })
            .then(res => res.text())
            .then(text => console.log("방이름 수정 완료:", text))
            .catch(err => console.error("방 이름 수정 오류:", err));

    // 모달 닫기
    bootstrap.Modal.getInstance(document.getElementById('renameModal')).hide();
  });


// 핀 버튼 클릭 시 토글

document.getElementById('pin-room').addEventListener('click', () => {
    const pin = document.getElementById('pin-room');
    pin.classList.toggle('pinned');

    // 나중에 방 고정 로직 백엔드 연결 가능
});

//방 나가기 버튼 → 모달 열기
document.getElementById('exit-room').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('exitModal'));
    modal.show();
});

// 모달에서 "나가기" 버튼 → 방 나가기 처리
document.getElementById('exitSubmit').addEventListener('click', async () => {

    if (!roomId) return;

    leaveRoom();

    try {
        await fetch(`/messenger/room/${roomId}/member`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeaderName]: csrfToken
            }
        });

        // 나가기 성공 → 창 자동 닫기
        window.close();

    } catch (e) {
        console.error("방 나가기 실패:", e);
        alert("오류가 발생했습니다.");
    }
});

</script>
<script th:src="@{/js/messenger/chat.js}"></script>
</body>
</html>
