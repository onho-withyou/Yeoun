<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yeoun.process.mapper.ProductionTrendMapper">
	
	<!-- =========================================================
		 DAY (일) : label = YYYY-MM-DD
		 계획 = WORK_ORDER.PLAN_QTY 합
		 완료 = 최종공정(6) WORK_ORDER_PROCESS.GOOD_QTY 합
	 	 ========================================================= -->
	<select id="plannedByDay" resultType="com.yeoun.process.dto.TrendRowDTO">
		SELECT TO_CHAR(w.PLAN_END_DATE, 'YYYY-MM-DD') AS label,
			   NVL(SUM(w.PLAN_QTY), 0) AS cnt
	    FROM WORK_ORDER w
	    WHERE <![CDATA[ w.PLAN_END_DATE >= #{fromDt} ]]>
	    	AND <![CDATA[ w.PLAN_END_DATE <  #{toDt} ]]>
	    GROUP BY TO_CHAR(w.PLAN_END_DATE, 'YYYY-MM-DD')
	    ORDER BY label
	</select>
	
	<select id="completedByDay" resultType="com.yeoun.process.dto.TrendRowDTO">
		WITH planned_orders AS (
			SELECT w.ORDER_ID, w.PLAN_END_DATE
			FROM WORK_ORDER w
			WHERE <![CDATA[ w.PLAN_END_DATE >= #{fromDt} ]]>
				AND <![CDATA[ w.PLAN_END_DATE <  #{toDt} ]]>
		)
		SELECT TO_CHAR(p.PLAN_END_DATE, 'YYYY-MM-DD') AS label,
			   NVL(SUM(wop.GOOD_QTY), 0) AS cnt
	    FROM planned_orders p
	    JOIN WORK_ORDER_PROCESS wop
    		ON wop.ORDER_ID = p.ORDER_ID
	    WHERE wop.STEP_SEQ = 6
	   	 	AND wop.STATUS = 'DONE'
	  	GROUP BY TO_CHAR(p.PLAN_END_DATE, 'YYYY-MM-DD')
	  	ORDER BY label
	</select>

	<!-- =========================================================
		 WEEK (주) : 월 기준 주차: "MM월 W주차"
	 	 ========================================================= -->
	<select id="plannedByWeek" resultType="com.yeoun.process.dto.TrendRowDTO">
		SELECT TO_CHAR(w.PLAN_END_DATE, 'MM') || '월 ' || TO_CHAR(w.PLAN_END_DATE, 'W') || '주차' AS label,
			   NVL(SUM(w.PLAN_QTY), 0) AS cnt
	    FROM WORK_ORDER w
	    WHERE <![CDATA[ w.PLAN_END_DATE >= #{fromDt} ]]>
	    	AND <![CDATA[ w.PLAN_END_DATE <  #{toDt} ]]>
	    GROUP BY TO_CHAR(w.PLAN_END_DATE, 'MM'), TO_CHAR(w.PLAN_END_DATE, 'W')
 		ORDER BY TO_CHAR(w.PLAN_END_DATE, 'MM'), TO_CHAR(w.PLAN_END_DATE, 'W')
	</select>

  	<select id="completedByWeek" resultType="com.yeoun.process.dto.TrendRowDTO">
 		WITH planned_orders AS (
		    SELECT w.ORDER_ID, w.PLAN_END_DATE
		    FROM WORK_ORDER w
		    WHERE <![CDATA[ w.PLAN_END_DATE >= #{fromDt} ]]>
		    	AND <![CDATA[ w.PLAN_END_DATE <  #{toDt} ]]>
 		)
  		SELECT TO_CHAR(p.PLAN_END_DATE, 'MM') || '월 ' || TO_CHAR(p.PLAN_END_DATE, 'W') || '주차' AS label,
  			   NVL(SUM(wop.GOOD_QTY), 0) AS cnt
		FROM planned_orders p
  		JOIN WORK_ORDER_PROCESS wop
		    ON wop.ORDER_ID = p.ORDER_ID
	  	WHERE wop.STEP_SEQ = 6
	    	AND wop.STATUS = 'DONE'
	  	GROUP BY TO_CHAR(p.PLAN_END_DATE, 'MM'), TO_CHAR(p.PLAN_END_DATE, 'W')
	  	ORDER BY TO_CHAR(p.PLAN_END_DATE, 'MM'), TO_CHAR(p.PLAN_END_DATE, 'W')
  	</select>

  	<!-- =========================================================
         MONTH (월) : label = YYYY-MM
         ========================================================= -->

 	<select id="plannedByMonth" resultType="com.yeoun.process.dto.TrendRowDTO">
		SELECT TO_CHAR(w.PLAN_END_DATE, 'YYYY-MM') AS label,
			   NVL(SUM(w.PLAN_QTY), 0) AS cnt
		FROM WORK_ORDER w
		WHERE <![CDATA[ w.PLAN_END_DATE >= #{fromDt} ]]>
			AND <![CDATA[ w.PLAN_END_DATE <  #{toDt} ]]>
		GROUP BY TO_CHAR(w.PLAN_END_DATE, 'YYYY-MM')
		ORDER BY label
  	</select>

  	<select id="completedByMonth" resultType="com.yeoun.process.dto.TrendRowDTO">
	    WITH planned_orders AS (
	    	SELECT w.ORDER_ID, w.PLAN_END_DATE
	    	FROM WORK_ORDER w
	    	WHERE <![CDATA[ w.PLAN_END_DATE >= #{fromDt} ]]>
	     		AND <![CDATA[ w.PLAN_END_DATE <  #{toDt} ]]>
	    )
	    SELECT TO_CHAR(p.PLAN_END_DATE, 'YYYY-MM') AS label,
	    	   NVL(SUM(wop.GOOD_QTY), 0) AS cnt
	    FROM planned_orders p
	    JOIN WORK_ORDER_PROCESS wop
	    	ON wop.ORDER_ID = p.ORDER_ID
	    WHERE wop.STEP_SEQ = 6
	    	AND wop.STATUS = 'DONE'
	    GROUP BY TO_CHAR(p.PLAN_END_DATE, 'YYYY-MM')
	    ORDER BY label
  	</select>

</mapper>