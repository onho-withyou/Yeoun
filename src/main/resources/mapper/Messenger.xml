<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yeoun.messenger.mapper.MessengerMapper">

	<!-- 메신저 친구목록 조회 -->
	<select id="selectUsers" resultType="com.yeoun.messenger.dto.MsgStatusDTO">
		SELECT e.EMP_ID,
			   e.EMP_NAME,
			   ms.AVLB_STAT,
			   ms.AUTO_WORK_STAT,
			   ms.MANUAL_WORK_STAT,
			   ms.WORK_STAT_SOURCE,
			   ms.ONLINE_YN,
			   ms.MSG_PROFILE,
			   d.DEPT_NAME,
			   p.POS_NAME,
			   (
				 SELECT f.CREATED_DATE
				   FROM MSG_FAVORITE f
				  WHERE f.EMP_ID = #{id}
					AND f.FV_USER = e.EMP_ID
			   ) AS FAVORITE_DATE,
			   (
				 SELECT CASE
						  WHEN COUNT(*) > 0 THEN 'Y'
						  ELSE 'N'
						END
				   FROM MSG_FAVORITE f
				  WHERE f.EMP_ID = #{id}
					AND f.FV_USER = e.EMP_ID
			   ) AS FAVORITE_YN
		FROM MSG_STATUS ms
		JOIN EMP e		ON ms.EMP_ID = e.EMP_ID
		JOIN DEPT d		ON e.DEPT_ID = d.DEPT_ID
		JOIN POSITION p	ON e.POS_CODE = p.POS_CODE
		WHERE ms.EMP_ID != #{id}
		ORDER BY
			-- 1) 즐겨찾기 있는 애들 먼저 (FAVORITE_DATE IS NOT NULL)
			CASE
			  WHEN (
				 SELECT f.CREATED_DATE
				   FROM MSG_FAVORITE f
				  WHERE f.EMP_ID = #{id}
					AND f.FV_USER = e.EMP_ID
			   ) IS NOT NULL THEN 0
			  ELSE 1
			END,

			-- 2) 즐겨찾기끼리는 추가한 순서대로 (CREATED_DATE DESC)
			FAVORITE_DATE DESC,

			-- 3) 일반 친구들은 이름순
			e.EMP_NAME ASC
	</select>

	<!-- 메신저 대화목록 조회 -->
	<select id="selectChats" resultType="com.yeoun.messenger.dto.MsgRoomDTO">
		SELECT
		r.ROOM_ID                        	AS roomId,
		r.PINNED_YN                      	AS pinnedYn,
		rm.GROUP_YN                         AS groupYn,

		-- 1:1일 때 상대방 이름 가져오기
		CASE
		WHEN rm.GROUP_YN = 'N' THEN (
		SELECT e.EMP_NAME
		FROM MSG_RELATION rr
		JOIN EMP e ON rr.EMP_ID = e.EMP_ID
		WHERE rr.ROOM_ID = r.ROOM_ID
		AND rr.EMP_ID != #{id}
		AND rr.PARTICIPANT_YN = 'Y'
		)
		ELSE rm.GROUP_NAME
		END 								AS groupName,

		-- 1:1일 때 상대방 프로필 사진 가져오기
		CASE
		WHEN rm.GROUP_YN = 'N' THEN (
		SELECT ms.MSG_PROFILE
		FROM MSG_RELATION rr
		JOIN MSG_STATUS ms ON rr.EMP_ID = ms.EMP_ID
		WHERE rr.ROOM_ID = r.ROOM_ID
		AND rr.EMP_ID != #{id}
		AND rr.PARTICIPANT_YN = 'Y'
		)
		ELSE 6   -- 그룹채팅은 프사 제공 안 함
		END 								AS profileImg,

		-- 최근 메시지
		lastMsg.MSG_CONTENT                 AS lastMessage,

		-- 최근 메시지 시간
		lastMsg.SENT_DATE                   AS lastMessageTime,

		-- 읽지 않은 메시지 수
		(
		SELECT COUNT(*)
		FROM MSG_MESSAGE mm
		WHERE mm.ROOM_ID = r.ROOM_ID
		AND mm.MSG_ID >
		NVL((SELECT lr.LAST_READ_ID
		FROM MSG_RELATION lr
		WHERE lr.EMP_ID = #{id}
		AND lr.ROOM_ID = r.ROOM_ID), 0)
		) 									AS unreadCount

		FROM MSG_RELATION r
		JOIN MSG_ROOM rm
		ON rm.ROOM_ID = r.ROOM_ID

		-- 최근 메시지 서브쿼리 JOIN
		LEFT JOIN (
		SELECT msg.ROOM_ID,
		msg.MSG_CONTENT,
		msg.SENT_DATE
		FROM (
		SELECT
		m.*,
		ROW_NUMBER() OVER(PARTITION BY m.ROOM_ID ORDER BY m.SENT_DATE DESC) AS rn
		FROM MSG_MESSAGE m
		) msg
		WHERE msg.rn = 1
		) lastMsg
		ON lastMsg.ROOM_ID = r.ROOM_ID

		WHERE r.EMP_ID = #{id}
		AND r.PARTICIPANT_YN = 'Y'

		ORDER BY
		r.PINNED_YN DESC,
		lastMsg.SENT_DATE DESC
	</select>

</mapper>





