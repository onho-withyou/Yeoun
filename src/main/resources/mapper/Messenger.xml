<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yeoun.messenger.mapper.MessengerMapper">

<!-- 메신저 친구목록 조회 -->
<select id="selectUsers" resultType="com.yeoun.messenger.dto.MsgStatusDTO">
	SELECT e.EMP_ID,
		   e.EMP_NAME,
		   ms.AVLB_STAT,
		   ms.AUTO_WORK_STAT,
		   ms.MANUAL_WORK_STAT,
		   ms.WORK_STAT_SOURCE,
		   ms.ONLINE_YN,
		   ms.MSG_PROFILE,
		   d.DEPT_NAME,
		   p.POS_NAME,
		   (
		     SELECT f.CREATED_DATE
		       FROM MSG_FAVORITE f
		      WHERE f.EMP_ID = #{id}
		        AND f.FV_USER = e.EMP_ID
		   ) AS FAVORITE_DATE,
		   (
		     SELECT CASE 
		              WHEN COUNT(*) > 0 THEN 'Y'
		              ELSE 'N'
		            END
		       FROM MSG_FAVORITE f
		      WHERE f.EMP_ID = #{id}
		        AND f.FV_USER = e.EMP_ID
		   ) AS FAVORITE_YN
	FROM MSG_STATUS ms
	JOIN EMP e		ON ms.EMP_ID = e.EMP_ID
	JOIN DEPT d		ON e.DEPT_ID = d.DEPT_ID
	JOIN POSITION p	ON e.POS_CODE = p.POS_CODE
	WHERE ms.EMP_ID != #{id}
	ORDER BY 
		-- 1) 즐겨찾기 있는 애들 먼저 (FAVORITE_DATE IS NOT NULL)
	    CASE 
	      WHEN (
		     SELECT f.CREATED_DATE
		       FROM MSG_FAVORITE f
		      WHERE f.EMP_ID = #{id}
		        AND f.FV_USER = e.EMP_ID
		   ) IS NOT NULL THEN 0
	      ELSE 1
	    END,
	    
	    -- 2) 즐겨찾기끼리는 추가한 순서대로 (CREATED_DATE DESC)
	    FAVORITE_DATE DESC,
	    
	    -- 3) 일반 친구들은 이름순
	    e.EMP_NAME ASC
</select>

</mapper>





