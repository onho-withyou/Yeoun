<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yeoun.equipment.mapper.EquipmentMapper">

    <select id="selectProcessByLineAndStep" resultType="com.yeoun.equipment.dto.EquipProcessHistoryDTO">
        SELECT
            o.ORDER_ID,
			p.STEP_SEQ AS STEP,
			e.EQUIP_ID,
			pe.EQUIP_NAME,
            m.PRD_NAME AS PRODUCT_NAME,
            o.LINE_ID,
            p.WOP_ID,
            p.START_TIME,
            p.END_TIME,
            p.STATUS
        FROM WORK_ORDER_PROCESS p
            JOIN WORK_ORDER o ON p.ORDER_ID = o.ORDER_ID
            JOIN PRODUCT_MST m ON o.PRD_ID = m.PRD_ID
			JOIN EQUIPMENT e ON p.PROCESS_ID = e.PROCESS_ID
			JOIN PROD_EQUIP pe ON o.LINE_ID = pe.LINE_ID
				AND e.EQUIP_ID = pe.EQUIP_CODE
		WHERE p.STATUS != 'READY'
			AND p.STATUS != 'SKIPPED'
		<if test="equipment != null">
			AND e.EQUIP_ID = #{equipment}
		</if>
		<if test="line != null">
			AND o.LINE_ID = #{line}
		</if>
		<if test="step != null">
			AND p.STEP_SEQ = #{step}
		</if>
		<if test="start != null">
			AND p.END_TIME <![CDATA[ >= ]]> TO_DATE(#{start}, 'YYYY-MM-DD')
		</if>
		<if test="end != null">
			AND p.START_TIME <![CDATA[ <= ]]> TO_DATE(#{end}, 'YYYY-MM-DD') + 1
		</if>
    </select>
    
    <select id="selectDowntimeHistories" resultType="com.yeoun.equipment.dto.EquipDowntimeDTO">
    	SELECT
    		d.DOWN_ID,
    		d.EQUIP_ID,
    		e.EQUIP_CODE AS EQUIP_TYPE_ID,
    		e.EQUIP_NAME,
    		e.LINE_ID,
    		d.DOWN_REASON,
    		d.START_TIME AS START_DATE,
    		d.END_TIME AS END_DATE
    	FROM EQUIP_DOWNTIME d
    		JOIN PROD_EQUIP e ON d.EQUIP_ID = e.EQUIP_ID 
    	<where>
    		<if test="equipment != null">
    			AND e.EQUIP_CODE = #{equipment}
    		</if>
    		
    		<if test="line != null">
    			AND e.LINE_ID = #{line}
    		</if>
    		
    		<if test="reason != null">
    			AND d.DOWN_REASON = #{reason}
    		</if>
    		
    		<if test="start != null">
    			AND d.END_TIME <![CDATA[ >= ]]> TO_DATE(#{start}, 'YYYY-MM-DD')
    		</if>
    		
    		<if test="end != null">
    			AND d.START_TIME <![CDATA[ <= ]]> TO_DATE(#{end}, 'YYYY-MM-DD') + 1
    		</if>
    	</where>
    	ORDER BY d.START_TIME DESC
    </select>
    
    <select id="countRunningEquipments" resultType="Integer">
	    SELECT COUNT(DISTINCT pe.equip_id)
		FROM prod_equip pe
		JOIN equipment p
		  ON pe.equip_code = p.equip_id
		JOIN work_order_process wop
		  ON p.process_id = wop.process_id
		JOIN work_order wo
		  ON wop.order_id = wo.order_id
		WHERE wop.status = 'IN_PROGRESS'
		  AND SYSDATE BETWEEN wop.start_time AND NVL(wop.end_time, SYSDATE)
    </select>
    
    <select id="selectProdEquipByLineAndProcess" resultType="com.yeoun.equipment.dto.ProdEquipDTO">
		SELECT
			p.*
	    FROM PROD_EQUIP p
	    JOIN EQUIPMENT  e
	    	ON p.EQUIP_CODE = e.EQUIP_ID 
	    WHERE LINE_ID = #{line}
	    AND e.PROCESS_ID = #{process}
    </select>

</mapper>