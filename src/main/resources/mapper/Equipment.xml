<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yeoun.equipment.mapper.EquipmentMapper">

    <select id="selectProcessByLineAndStep" resultType="com.yeoun.equipment.dto.EquipProcessHistoryDTO">
        SELECT
            o.ORDER_ID,
            m.PRD_NAME AS PRODUCT_NAME,
            o.LINE_ID,
            p.WOP_ID,
            p.START_TIME,
            p.END_TIME,
            p.STATUS
        FROM WORK_ORDER_PROCESS p
            JOIN WORK_ORDER o ON p.ORDER_ID = o.ORDER_ID
            JOIN PRODUCT_MST m ON o.PRD_ID = m.PRD_ID
        WHERE o.LINE_ID = #{line}
        AND p.STEP_SEQ = #{step}
        AND p.STATUS != 'READY'
    </select>
    
    <select id="selectDowntimeHistories" resultType="com.yeoun.equipment.dto.EquipDowntimeDTO">
    	SELECT
    		d.DOWN_ID,
    		d.EQUIP_ID,
    		e.EQUIP_CODE AS EQUIP_TYPE_ID,
    		e.EQUIP_NAME,
    		e.LINE_ID,
    		d.DOWN_REASON,
    		d.START_TIME AS START_DATE,
    		d.END_TIME AS END_DATE
    	FROM EQUIP_DOWNTIME d
    		JOIN PROD_EQUIP e ON d.EQUIP_ID = e.EQUIP_ID 
    	<where>
    		<if test="equipment != null">
    			AND e.EQUIP_CODE = #{equipment}
    		</if>
    		
    		<if test="line != null">
    			AND e.LINE_ID = #{line}
    		</if>
    		
    		<if test="reason != null">
    			AND d.DOWN_REASON = #{reason}
    		</if>
    		
    		<if test="start != null">
    			AND d.END_TIME <![CDATA[ >= ]]> TO_DATE(#{start}, 'YYYY-MM-DD')
    		</if>
    		
    		<if test="end != null">
    			AND d.START_TIME <![CDATA[ <= ]]> TO_DATE(#{end}, 'YYYY-MM-DD') + 1
    		</if>
    	</where>
    	ORDER BY d.START_TIME DESC
    </select>

</mapper>