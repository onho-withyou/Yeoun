<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yeoun.order.mapper.OrderMapper">

	<select id="selectOrderList"
			parameterType="com.yeoun.order.dto.WorkOrderSearchDTO"
			resultType="com.yeoun.order.dto.WorkOrderListDTO">
		SELECT
			DISTINCT
			w.ORDER_ID,
			pp.PLAN_ID,
			ppi.PRD_ID,
			m.PRD_NAME,
			w.PLAN_QTY,
			w.PLAN_START_DATE AS START_DATE,
			w.PLAN_END_DATE AS END_DATE,
			w.STATUS,
			w.OUTBOUND_YN,
			w.CREATED_DATE,
			w.REMARK
		FROM WORK_ORDER w
		JOIN PRODUCTION_PLAN pp
			ON w.PLAN_ID = pp.PLAN_ID
		JOIN PRODUCTION_PLAN_ITEM ppi
			ON w.PLAN_ID = ppi.PLAN_ID
		JOIN PRODUCT_MST m
			ON w.PRD_ID = m.PRD_ID
		<where>
			<!-- 키워드(품명 or 작업지시번호) -->
			<if test="keyword != null and keyword != ''">
				AND (
				m.PRD_NAME LIKE '%' || #{keyword} || '%'
				OR w.ORDER_ID LIKE '%' || #{keyword} || '%'
				OR ppi.PRD_ID LIKE '%' || #{keyword} || '%'
				)
			</if>

			<!-- 상태 검색 -->
			<if test="status != null and status != '' and status != 'ALL' and status != 'DONE'">
				AND w.STATUS = #{status}
			</if>

			<!-- 시작일자 FROM -->
			<if test="startDateFrom != null and startDateFrom != ''">
				AND TO_CHAR(w.PLAN_START_DATE, 'YYYY-MM-DD') = #{startDateFrom}
			</if>
			
			<if test="status == 'DONE'">
				AND w.STATUS = 'SCRAPPED' OR w.STATUS = 'COMPLETED' OR w.STATUS = 'CANCELED'
			</if>

		</where>
		ORDER BY w.ORDER_ID DESC
	</select>
	
	<select id="selectWorkers" resultType="com.yeoun.order.dto.WorkerListDTO">
		SELECT
			e.EMP_ID,
			e.EMP_NAME,
			d.DEPT_NAME,
			p.POS_NAME
		FROM EMP e
		JOIN DEPT d
			ON e.DEPT_ID = d.DEPT_ID
		JOIN POSITION p
			ON e.POS_CODE = p.POS_CODE
		WHERE d.DEPT_ID = #{dept}
		<if test="dept != null and dept == 'DEP003'">
			AND p.POS_CODE = 'POS001'
		</if>
			AND e.STATUS = 'ACTIVE'
		ORDER BY e.EMP_NAME ASC
	</select>
	
	<select id="selectMaterials" resultType="com.yeoun.order.dto.MaterialAvailabilityDTO">
		WITH BOM AS (
		    SELECT 
		        PRD_ID,
		        MAT_ID,
		        SUM(MAT_QTY) AS BASE_QTY
		    FROM BOM_MST
		    WHERE PRD_ID = #{prdId}
		    GROUP BY PRD_ID, MAT_ID
		),
		INV AS (
		    SELECT
		        ITEM_ID,
		        SUM(IV_AMOUNT) AS STOCK_QTY
		    FROM INVENTORY
		    GROUP BY ITEM_ID
		)
		SELECT 
		    b.PRD_ID,
		    p.PRD_NAME,
		    b.MAT_ID,
		    m.MAT_NAME,
		    m.MAT_TYPE,
		    b.BASE_QTY * #{planQty} AS REQUIRED_QTY,
		    i.STOCK_QTY
		FROM BOM b
		LEFT JOIN MATERIAL_MST m
			ON b.MAT_ID = m.MAT_ID
		LEFT JOIN PRODUCT_MST p
			ON p.PRD_ID = b.PRD_ID
		LEFT JOIN INV i
		       ON b.MAT_ID = i.ITEM_ID
		ORDER BY b.MAT_ID
	</select>
	
	<select id="selectAllSchedules" resultType="com.yeoun.order.dto.WorkScheduleDTO">
		SELECT 
		    s.SCHEDULE_ID,
		    s.COLOR_CODE,
		    s.START_DATE AS START_TIME,
		    s.END_DATE AS END_TIME,
		    s.WORK_ID,
		    o.LINE_ID,
		    l.LINE_NAME,
		    pm.PRD_NAME AS PRODUCT_NAME
		FROM WORK_SCHEDULE s
			JOIN WORK_ORDER o ON s.WORK_ID=o.ORDER_ID
			JOIN PROD_LINE l ON o.LINE_ID=l.LINE_ID
			JOIN PRODUCT_MST pm ON O.PRD_ID=pm.PRD_ID
		WHERE o.STATUS != 'CANCELED' OR o.STATUS != 'CREATED'
		ORDER BY START_TIME DESC
	</select>
	
	<select id="selectWorkersBySchedule" resultType="com.yeoun.order.dto.WorkerProcessDTO">
		SELECT 
		    SCHEDULE_ID,
		    WORKER_ID AS EMP_ID
		FROM WORKER_PROCESS
		WHERE SCHEDULE_ID = #{id}
	</select>
	
	<select id="existWorkingSchedule" resultType="Integer">
		SELECT COUNT(*)
			FROM WORK_SCHEDULE s
			JOIN WORKER_PROCESS wp ON s.SCHEDULE_ID = wp.SCHEDULE_ID
		WHERE wp.WORKER_ID = #{empId}
		AND #{now} BETWEEN s.START_DATE AND s.END_DATE
	</select>
	
	<select id="countLineOverlap" resultType="Integer">
		SELECT COUNT(ORDER_ID)
			FROM WORK_ORDER w
		WHERE w.LINE_ID = #{lineId}
		AND w.STATUS IN ('CREATED', 'RELEASED', 'IN_PROGRESS')
		AND w.PLAN_START_DATE <![CDATA[ < ]]> #{endTime}
		AND w.PLAN_END_DATE   <![CDATA[ > ]]> #{startTime}
	</select>
		
	<select id="countWorkerOverlap" resultType="Integer">
		SELECT COUNT(ORDER_ID)
			FROM WORK_ORDER w
			JOIN WORK_SCHEDULE s  ON w.ORDER_ID = s.WORK_ID
			JOIN WORKER_PROCESS p ON s.SCHEDULE_ID = p.SCHEDULE_ID
		WHERE p.WORKER_ID = #{workerId}
		AND w.STATUS IN ('CREATED', 'RELEASED', 'IN_PROGRESS')
		AND w.PLAN_START_DATE <![CDATA[ < ]]> #{endTime}
		AND w.PLAN_END_DATE   <![CDATA[ > ]]> #{startTime}
	</select>
	
</mapper>
